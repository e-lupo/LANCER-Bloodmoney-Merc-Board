<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LANCER Job Board - Admin</title>
  <link rel="stylesheet" href="/css/currency.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      background-color: #1a1a1a;
      padding: 20px;
    }
    
    .admin-header {
      background-color: #2a2a2a;
      color: #e0e0e0;
      padding: 20px;
      margin-bottom: 30px;
      border-radius: 5px;
    }
    
    .admin-header h1 {
      margin-bottom: 10px;
    }
    
    .logout-link {
      color: #66BB6A;
      text-decoration: none;
      font-weight: bold;
    }
    
    .settings-section {
      background-color: #2a2a2a;
      padding: 30px;
      margin-bottom: 30px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }
    
    .settings-section h2 {
      margin-bottom: 20px;
      color: #e0e0e0;
    }
    
    .add-job-section {
      background-color: #2a2a2a;
      padding: 30px;
      margin-bottom: 30px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }
    
    .add-job-section h2 {
      margin-bottom: 20px;
      color: #e0e0e0;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #b0b0b0;
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #444;
      border-radius: 3px;
      font-size: 14px;
      background-color: #1a1a1a;
      color: #e0e0e0;
    }
    
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: 2px solid #66BB6A;
      outline-offset: 1px;
    }
    
    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
    }
    
    .btn-primary {
      background-color: #4CAF50;
      color: white;
    }
    
    .btn-primary:hover {
      background-color: #45a049;
    }
    
    .btn-edit {
      background-color: #2196F3;
      color: white;
      margin-right: 5px;
    }
    
    .btn-edit:hover {
      background-color: #0b7dda;
    }
    
    .btn-delete {
      background-color: #f44336;
      color: white;
    }
    
    .btn-delete:hover {
      background-color: #da190b;
    }
    
    .btn-neutral {
      background-color: #6a6a6a;
      color: white;
    }
    
    .btn-neutral:hover {
      background-color: #5a5a5a;
    }
    
    .btn-neutral:focus {
      outline: 2px solid #66BB6A;
      outline-offset: 1px;
    }
    
    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: flex-start;
      margin-top: 20px;
    }
    
    .button-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .jobs-list {
      background-color: #2a2a2a;
      padding: 30px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }
    
    .jobs-list h2 {
      margin-bottom: 20px;
      color: #e0e0e0;
    }
    
    .job-item {
      border: 1px solid #444;
      padding: 20px;
      margin-bottom: 15px;
      border-radius: 3px;
      background-color: #1a1a1a;
    }
    
    .job-item h3 {
      color: #e0e0e0;
      margin-bottom: 10px;
    }
    
    .job-item-field {
      margin-bottom: 8px;
      color: #b0b0b0;
    }
    
    .job-item-field strong {
      color: #e0e0e0;
    }
    
    .job-item-actions {
      margin-top: 15px;
    }
    
    .rank-display {
      color: #FFD700;
      font-size: 18px;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
    }
    
    .modal-content {
      background-color: #2a2a2a;
      margin: 5% auto;
      padding: 30px;
      border-radius: 5px;
      width: 80%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-header h2 {
      color: #e0e0e0;
    }
    
    .close {
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      color: #b0b0b0;
    }
    
    .close:hover {
      color: #e0e0e0;
    }
    
    .emblem-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 10px;
      margin-top: 10px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #444;
      padding: 10px;
      border-radius: 3px;
      background-color: #ffffff;
    }
    
    .emblem-option {
      position: relative;
      padding: 8px;
      border: 2px solid transparent;
      border-radius: 3px;
      cursor: pointer;
      transition: all 0.2s ease;
      background-color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 80px;
    }
    
    .emblem-option:hover {
      border-color: #66BB6A;
      box-shadow: 0 2px 5px rgba(102,187,106,0.3);
    }
    
    .emblem-option.selected {
      border-color: #66BB6A;
      background-color: #e8f5e9;
      box-shadow: 0 2px 8px rgba(102, 187, 106, 0.5);
    }
    
    .emblem-option img {
      max-width: 100%;
      max-height: 60px;
      display: block;
    }
    
    .emblem-option.none {
      font-size: 12px;
      color: #666;
      font-weight: bold;
      text-align: center;
    }
    
    .notification-footer {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #4CAF50;
      color: white;
      padding: 15px 25px;
      border-radius: 5px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      font-weight: bold;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
      z-index: 2000;
      pointer-events: none;
    }
    
    .notification-footer.show {
      opacity: 1;
    }
    
    .emblem-display {
      max-width: 150px;
      max-height: 150px;
      margin-top: 10px;
      border: 1px solid #ddd;
      padding: 10px;
      background-color: white;
      border-radius: 3px;
    }

    .form-inline {
      display: inline;
    }

    .is-hidden {
      display: none;
    }

    .helper-text {
      font-size: 0.9em;
      color: #e0e0e0;
    }

    .btn-add-job {
      margin-top: 25px;
      padding: 15px 30px;
      font-size: 16px;
      font-weight: bold;
      box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
    }
  
    /* Tab Navigation */
    .tab-navigation {
      background-color: #2a2a2a;
      padding: 15px 20px;
      margin-bottom: 20px;
      border-radius: 5px;
      display: flex;
      gap: 10px;
    }
    
    .tab-button {
      padding: 12px 24px;
      border: none;
      background-color: #3a3a3a;
      color: #b0b0b0;
      cursor: pointer;
      border-radius: 3px;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.3s ease;
    }
    
    .tab-button:hover {
      background-color: #4a4a4a;
      color: #e0e0e0;
    }
    
    .tab-button.active {
      background-color: #66BB6A;
      color: #1a1a1a;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .module-grid {
      display: grid;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .module-item {
      border: 1px solid #444;
      padding: 10px;
      border-radius: 3px;
      background-color: #1a1a1a;
    }
    
    .module-item h4 {
      color: #66BB6A;
      margin-bottom: 8px;
      font-size: 13px;
    }
    
    .module-item.disabled-module {
      opacity: 0.4;
    }
    
    .manna-display {
      font-size: 32px;
      font-weight: bold;
      color: #66BB6A;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .manna-display .currency-icon {
      width: 32px;
      height: 32px;
    }
    
    .faction-item {
      border: 1px solid #444;
      padding: 20px;
      margin-bottom: 15px;
      border-radius: 3px;
      background-color: #1a1a1a;
    }
    
    .faction-item h3 {
      color: #e0e0e0;
      margin-bottom: 10px;
    }
    
    .faction-item-field {
      margin-bottom: 8px;
      color: #b0b0b0;
    }
    
    .faction-item-field strong {
      color: #e0e0e0;
    }
    
    .faction-item-actions {
      margin-top: 15px;
    }
    
    .transaction-item {
      border: 1px solid #444;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 3px;
      background-color: #1a1a1a;
    }
    
    .transaction-item-field {
      margin-bottom: 6px;
      color: #b0b0b0;
    }
    
    .transaction-item-field strong {
      color: #e0e0e0;
    }
    
    .transaction-item-actions {
      margin-top: 10px;
    }
</style>
</head><body><div class="admin-header">
    <h1>LANCER Job Board - Admin Panel</h1>
    <p>Manage job postings, base modules, factions, and global settings</p>
    <a href="/" class="logout-link">Logout</a>
  </div>
  <!-- Tab Navigation -->
  <div class="tab-navigation">
    <button class="tab-button active" onclick="switchTab('overview')">Overview Config</button>
    <button class="tab-button" onclick="switchTab('jobs')">Job Board Config</button>
    <button class="tab-button" onclick="switchTab('base')">Base Config</button>
    <button class="tab-button" onclick="switchTab('factions')">Faction Config</button>
  </div>

  <!-- Overview Tab -->
  <div id="overview-tab" class="tab-content active">
    <div class="settings-section">
      <h2>Global Settings</h2>
      <form id="settingsForm">
        <div class="form-group">
          <label for="settingsPortalHeading">Portal Heading (Landing & Client View)</label>
          <input type="text" id="settingsPortalHeading" name="portalHeading" value="<%= settings.portalHeading %>" maxlength="100" required>
        </div>
        
        <div class="form-group">
          <label for="settingsColorScheme">Color Scheme (Client & Landing View)</label>
          <select id="settingsColorScheme" name="colorScheme" required>
            <option value="grey" <%= settings.colorScheme === 'grey' ? 'selected' : '' %>>Grey (Black & White)</option>
            <option value="orange" <%= settings.colorScheme === 'orange' ? 'selected' : '' %>>Orange (Portal Style)</option>
            <option value="green" <%= settings.colorScheme === 'green' ? 'selected' : '' %>>Green (Classic Terminal)</option>
            <option value="blue" <%= settings.colorScheme === 'blue' ? 'selected' : '' %>>Blue (Dark Blue Background)</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="settingsUnt">UNT (Date - DD/MM/YYYY)</label>
          <input type="text" id="settingsUnt" name="unt" value="<%= settings.unt %>" placeholder="DD/MM/YYYY" pattern="\d{2}/\d{2}/\d{4}" required>
        </div>
        
        <div class="form-group">
          <label for="settingsGalacticPos">Current Galactic Position</label>
          <input type="text" id="settingsGalacticPos" name="currentGalacticPos" value="<%= settings.currentGalacticPos %>" required>
        </div>
        
        <div class="form-group">
          <label for="settingsUserGroup">User Group</label>
          <input type="text" id="settingsUserGroup" name="userGroup" value="<%= settings.userGroup %>" maxlength="100" required>
        </div>
        
        <button type="submit" class="btn btn-primary">Save Settings</button>
      </form>
    </div>

    <div class="settings-section">
      <h2>Manna Balance Management</h2>
      <div class="manna-display">
        Balance: <span id="overviewMannaBalance"><%= manna.balance %></span>
        <img src="/css/images/manna_symbol.svg" alt="Currency Icon" class="currency-icon">
      </div>
      
      <h3 style="color: #e0e0e0; margin: 20px 0 15px;">Modify Balance</h3>
      <form id="directBalanceForm" style="margin-bottom: 30px;">
        <div class="form-group">
          <label for="directBalance">Set Balance Directly</label>
          <input type="number" id="directBalance" name="balance" value="<%= manna.balance %>" required>
        </div>
        <button type="submit" class="btn btn-primary">Set Balance</button>
      </form>
      
      <h3 style="color: #e0e0e0; margin: 20px 0 15px;">Add Transaction</h3>
      <form id="overviewMannaForm">
        <div class="form-group">
          <label for="overviewMannaAmount">Amount (+ or -)</label>
          <input type="number" id="overviewMannaAmount" name="amount" required>
        </div>
        <div class="form-group">
          <label for="overviewMannaDescription">Transaction Description</label>
          <input type="text" id="overviewMannaDescription" name="description" required>
        </div>
        <button type="submit" class="btn btn-primary">Add Transaction</button>
      </form>
      
      <h3 style="color: #e0e0e0; margin: 20px 0 15px;">Transaction History</h3>
      <div id="transactionsList">
        <% if (manna.transactions.length === 0) { %>
          <p style="color: #b0b0b0;">No transactions yet.</p>
        <% } else { %>
          <% manna.transactions.slice().reverse().forEach(transaction => { %>
            <div class="transaction-item" data-id="<%= transaction.id %>">
              <div class="transaction-item-field">
                <strong>Date:</strong> <%= new Date(transaction.date).toLocaleString('en-GB', { dateStyle: 'short', timeStyle: 'short' }) %>
              </div>
              <div class="transaction-item-field">
                <strong>Amount:</strong> 
                <span style="color: <%= transaction.amount >= 0 ? '#66BB6A' : '#f44336' %>">
                  <%= transaction.amount >= 0 ? '+' : '' %><%= transaction.amount %>
                </span>
                <img src="/css/images/manna_symbol.svg" alt="Currency Icon" class="currency-icon">
              </div>
              <div class="transaction-item-field">
                <strong>Description:</strong> <%= transaction.description %>
              </div>
              <div class="transaction-item-field">
                <strong>Balance After:</strong> <%= transaction.balance %>
                <img src="/css/images/manna_symbol.svg" alt="Currency Icon" class="currency-icon">
              </div>
              <div class="transaction-item-actions">
                <button class="btn btn-edit" onclick="editTransaction('<%= transaction.id %>')">Edit</button>
                <button class="btn btn-delete" onclick="deleteTransaction('<%= transaction.id %>')">Delete</button>
              </div>
            </div>
          <% }); %>
        <% } %>
      </div>
    </div>
  </div>

  <!-- Jobs Tab -->
  <div id="jobs-tab" class="tab-content">
  <div class="add-job-section">
    <h2>Add New Job</h2>
    <form id="addJobForm">
      <div class="form-group">
        <label for="jobName">Job Name</label>
        <input type="text" id="jobName" name="name" required>
      </div>
      
      <div class="form-group">
        <label for="jobRank">Job Rank (1-3 stars)</label>
        <select id="jobRank" name="rank" required>
          <option value="1">1 Star</option>
          <option value="2">2 Stars</option>
          <option value="3">3 Stars</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="jobClient">Client</label>
        <input type="text" id="jobClient" name="client" required>
      </div>
      
      <div class="form-group">
        <label for="jobType">Job Type</label>
        <input type="text" id="jobType" name="jobType" required>
      </div>
      
      <div class="form-group">
        <label for="jobDescription">Objective</label>
        <textarea id="jobDescription" name="description" required></textarea>
      </div>
      
      <div class="form-group">
        <label for="jobClientBrief">Client Brief</label>
        <textarea id="jobClientBrief" name="clientBrief" required></textarea>
      </div>
      
      <div class="form-group">
        <label for="jobCurrencyPay" class="currency-label">
          Currency Pay (e.g., 100m)
          <img src="/css/images/manna_symbol.svg" alt="Currency Icon" class="currency-icon">
        </label>
        <input type="text" id="jobCurrencyPay" name="currencyPay" required>
      </div>
      
      <div class="form-group">
        <label for="jobAdditionalPay">Additional Pay</label>
        <input type="text" id="jobAdditionalPay" name="additionalPay">
      </div>
      
      <div class="form-group">
        <label for="jobEmblem">Emblem</label>
        <input type="hidden" id="jobEmblem" name="emblem" value="">
        <div class="emblem-grid" id="emblemGrid">
          <div class="emblem-option none" data-emblem="">
            [None]
          </div>
          <% emblems.forEach(emblem => { %>
            <div class="emblem-option" data-emblem="<%= emblem %>" title="<%= formatEmblemTitle(emblem) %>">
              <img src="/emblems/<%= emblem %>" alt="<%= formatEmblemTitle(emblem) %>">
            </div>
          <% }); %>
        </div>
      </div>
    </form>
	
<div class="button-group">
  <div class="button-container">
    <form id="uploadForm" class="form-inline" enctype="multipart/form-data">
      <input type="file" id="fileInput" class="is-hidden" name="myFile" accept="image/png,image/jpeg,image/bmp">
      <button type="button" class="btn btn-neutral"
        onclick="document.getElementById('fileInput').click();"
        title="Uploads an image and converts it to SVG">
        Upload Emblem
      </button>
    </form>
    <p class="helper-text">Accepts PNG, JPEG, BMP (max 10MB)</p>
  </div>
  
  <div class="button-container">
    <button type="button" class="btn btn-delete" id="deleteEmblemBtn" onclick="deleteSelectedEmblem()"
      title="Deletes the currently selected emblem (if not in use by any jobs)">
      Delete Selected Emblem
    </button>
    <p class="helper-text">Deletes the selected emblem if not in use</p>
  </div>
</div>

<button type="submit" class="btn btn-primary btn-add-job" form="addJobForm">Add Job</button>
	
  </div>

  <div class="jobs-list">
    <h2>Existing Jobs</h2>
    <div id="jobsList">
      <% jobs.forEach(job => { %>
        <div class="job-item" data-id="<%= job.id %>">
          <h3><%= job.name %></h3>
          <div class="job-item-field">
            <strong>Rank:</strong> 
            <span class="rank-display">
              <% for(let i = 0; i < job.rank; i++) { %>★<% } %>
              <% for(let i = job.rank; i < 3; i++) { %>☆<% } %>
            </span>
          </div>
          <div class="job-item-field"><strong>Client:</strong> <%= job.client %></div>
          <div class="job-item-field"><strong>Job Type:</strong> <%= job.jobType %></div>
          <div class="job-item-field"><strong>Objective:</strong> <%= job.description %></div>
          <div class="job-item-field"><strong>Client Brief:</strong> <%= job.clientBrief %></div>
          <div class="job-item-field"><strong>Payment:</strong>
            <%= job.currencyPay %>
            <img src="/css/images/manna_symbol.svg" alt="Currency Icon" class="currency-icon">
          </div>
          <% if (job.additionalPay) { %>
            <div class="job-item-field"><strong>Additional Pay:</strong> <%= job.additionalPay %></div>
          <% } %>
          <% if (job.emblem) { %>
            <div class="job-item-field">
              <strong>Emblem:</strong> <%= job.emblem %>
              <br>
              <img src="/emblems/<%= job.emblem %>" alt="<%= job.emblem.replace('.svg', '') %>" class="emblem-display">
            </div>
          <% } %>
          <div class="job-item-actions">
            <button class="btn btn-edit" onclick="editJob('<%= job.id %>')">Edit</button>
            <button class="btn btn-delete" onclick="deleteJob('<%= job.id %>')">Delete</button>
          </div>
        </div>
      <% }); %>
    </div>
  </div>

  <!-- Notification Footer -->
  <div id="notificationFooter" class="notification-footer"></div>

  <!-- Edit Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Job</h2>
        <span class="close" onclick="closeEditModal()">&times;</span>
      </div>
      <form id="editJobForm">
        <input type="hidden" id="editJobId">
        <div class="form-group">
          <label for="editJobName">Job Name</label>
          <input type="text" id="editJobName" name="name" required>
        </div>
        
        <div class="form-group">
          <label for="editJobRank">Job Rank (1-3 stars)</label>
          <select id="editJobRank" name="rank" required>
            <option value="1">1 Star</option>
            <option value="2">2 Stars</option>
            <option value="3">3 Stars</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="editJobClient">Client</label>
          <input type="text" id="editJobClient" name="client" required>
        </div>
        
        <div class="form-group">
          <label for="editJobType">Job Type</label>
          <input type="text" id="editJobType" name="jobType" required>
        </div>
        
        <div class="form-group">
          <label for="editJobDescription">Objective</label>
          <textarea id="editJobDescription" name="description" required></textarea>
        </div>
        
        <div class="form-group">
          <label for="editJobClientBrief">Client Brief</label>
          <textarea id="editJobClientBrief" name="clientBrief" required></textarea>
        </div>
        
        <div class="form-group">
          <label for="editJobCurrencyPay" class="currency-label">
            Currency Pay (e.g., 100m)
            <img src="/css/images/manna_symbol.svg" alt="Currency Icon" class="currency-icon">
          </label>
          <input type="text" id="editJobCurrencyPay" name="currencyPay" required>
        </div>

        <div class="form-group">
          <label for="editJobAdditionalPay">Additional Pay</label>
          <input type="text" id="editJobAdditionalPay" name="additionalPay">
        </div>
        
        <div class="form-group">
          <label for="editJobEmblem">Emblem</label>
          <input type="hidden" id="editJobEmblem" name="emblem" value="">
          <div class="emblem-grid" id="editEmblemGrid">
            <div class="emblem-option none" data-emblem="">
              [None]
            </div>
            <% emblems.forEach(emblem => { %>
              <div class="emblem-option" data-emblem="<%= emblem %>" title="<%= formatEmblemTitle(emblem) %>">
                <img src="/emblems/<%= emblem %>" alt="<%= formatEmblemTitle(emblem) %>">
              </div>
            <% }); %>
          </div>
        </div>
        
        <button type="submit" class="btn btn-primary">Save Changes</button>
      </form>
    </div>
  </div>

  
  </div>

  <!-- Base Tab -->
  <div id="base-tab" class="tab-content">
    <div class="settings-section">
      <h2>Base Module Configuration</h2>
      <p style="color: #b0b0b0; margin-bottom: 20px;">Configure the 15 base modules (3 Core, 6 Major, 6 Minor). Last 2 Minor modules are disabled by default.</p>
      <form id="baseForm">
        <button type="submit" class="btn btn-primary" style="margin-bottom: 20px;">Save Base Configuration</button>
        <h3 style="color: #e0e0e0; margin-bottom: 15px;">Core Modules (3)</h3>
        <div class="module-grid">
          <% for (let i = 0; i < 3; i++) { %>
            <div class="module-item">
              <h4>Core Module <%= i + 1 %></h4>
              <div class="form-group">
                <label>Title</label>
                <input type="text" name="modules[<%= i %>][title]" value="<%= base.modules[i].title %>" placeholder="Optional">
              </div>
              <div class="form-group">
                <label>Description</label>
                <textarea name="modules[<%= i %>][description]" placeholder="Optional"><%= base.modules[i].description %></textarea>
              </div>
              <input type="hidden" name="modules[<%= i %>][type]" value="Core">
              <input type="hidden" name="modules[<%= i %>][disabled]" value="false">
            </div>
          <% } %>
        </div>
        
        <h3 style="color: #e0e0e0; margin: 20px 0 15px;">Major Modules (6)</h3>
        <div class="module-grid">
          <% for (let i = 3; i < 9; i++) { %>
            <div class="module-item">
              <h4>Major Module <%= i - 2 %></h4>
              <div class="form-group">
                <label>Title</label>
                <input type="text" name="modules[<%= i %>][title]" value="<%= base.modules[i].title %>" placeholder="Optional">
              </div>
              <div class="form-group">
                <label>Description</label>
                <textarea name="modules[<%= i %>][description]" placeholder="Optional"><%= base.modules[i].description %></textarea>
              </div>
              <input type="hidden" name="modules[<%= i %>][type]" value="Major">
              <input type="hidden" name="modules[<%= i %>][disabled]" value="false">
            </div>
          <% } %>
        </div>
        
        <h3 style="color: #e0e0e0; margin: 20px 0 15px;">Minor Modules (6 - last 2 can be enabled/disabled)</h3>
        <div class="module-grid">
          <% for (let i = 9; i < 15; i++) { %>
            <% if (i >= 13) { %>
              <div style="grid-column: span 1; margin-bottom: 10px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 3px;">
                  <input type="checkbox" name="modules[<%= i %>][enabled]" <%= !base.modules[i].disabled ? 'checked' : '' %> onchange="toggleMinorModule(this, <%= i %>)" style="cursor: pointer;">
                  <span style="color: #e0e0e0;">Enable Minor Module <%= i - 8 %></span>
                </label>
              </div>
            <% } %>
            <div class="module-item <%= base.modules[i].disabled ? 'disabled-module' : '' %>">
              <h4>Minor Module <%= i - 8 %> <%= base.modules[i].disabled ? '(DISABLED)' : '' %></h4>
              <div id="module-<%= i %>-fields" style="<%= base.modules[i].disabled ? 'display: none;' : '' %>">
                <div class="form-group">
                  <label>Title</label>
                  <input type="text" name="modules[<%= i %>][title]" value="<%= base.modules[i].title %>" placeholder="Optional" <%= base.modules[i].disabled ? 'disabled' : '' %>>
                </div>
                <div class="form-group">
                  <label>Description</label>
                  <textarea name="modules[<%= i %>][description]" placeholder="Optional" <%= base.modules[i].disabled ? 'disabled' : '' %>><%= base.modules[i].description %></textarea>
                </div>
              </div>
              <% if (base.modules[i].disabled && i >= 13) { %>
                <p style="color: #666; text-align: center; padding: 20px;">This module slot is disabled</p>
              <% } %>
              <input type="hidden" name="modules[<%= i %>][type]" value="Minor">
              <input type="hidden" id="module-<%= i %>-disabled" name="modules[<%= i %>][disabled]" value="<%= base.modules[i].disabled %>">
            </div>
          <% } %>
        </div>
        
        <button type="submit" class="btn btn-primary">Save Base Configuration</button>
      </form>
    </div>
  </div>

  <!-- Factions Tab -->
  <div id="factions-tab" class="tab-content">
    <div class="add-job-section">
      <h2>Add New Faction</h2>
      <form id="addFactionForm">
        <div class="form-group">
          <label for="factionTitle">Faction Title</label>
          <input type="text" id="factionTitle" name="title" required>
        </div>
        
        <div class="form-group">
          <label for="factionBrief">Brief</label>
          <textarea id="factionBrief" name="brief" required></textarea>
        </div>
        
        <div class="form-group">
          <label for="factionStanding">Standing</label>
          <select id="factionStanding" name="standing" required>
            <option value="0">0 - Distrusted</option>
            <option value="1">1 - Wary</option>
            <option value="2" selected>2 - Neutral</option>
            <option value="3">3 - Respected</option>
            <option value="4">4 - Trusted</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="factionJobsCompleted">Jobs Completed</label>
          <input type="number" id="factionJobsCompleted" name="jobsCompleted" value="0" min="0" required>
        </div>
        
        <div class="form-group">
          <label for="factionJobsFailed">Jobs Failed</label>
          <input type="number" id="factionJobsFailed" name="jobsFailed" value="0" min="0" required>
        </div>
        
        <div class="form-group">
          <label for="factionEmblem">Emblem (shared with Jobs)</label>
          <input type="hidden" id="factionEmblem" name="emblem" value="">
          <div class="emblem-grid" id="factionEmblemGrid">
            <div class="emblem-option none" data-emblem="">
              [None]
            </div>
            <% emblems.forEach(emblem => { %>
              <div class="emblem-option" data-emblem="<%= emblem %>" title="<%= formatEmblemTitle(emblem) %>">
                <img src="/emblems/<%= emblem %>" alt="<%= formatEmblemTitle(emblem) %>">
              </div>
            <% }); %>
          </div>
        </div>
        
        <button type="submit" class="btn btn-primary btn-add-job">Add Faction</button>
      </form>
    </div>

    <div class="jobs-list">
      <h2>Existing Factions</h2>
      <div id="factionsList">
        <% if (factions.length === 0) { %>
          <p style="color: #b0b0b0;">No factions created yet.</p>
        <% } else { %>
          <% factions.forEach(faction => { 
            const standingLabels = ['Distrusted', 'Wary', 'Neutral', 'Respected', 'Trusted'];
          %>
            <div class="faction-item" data-id="<%= faction.id %>">
              <h3><%= faction.title %></h3>
              <div class="faction-item-field"><strong>Standing:</strong> <%= standingLabels[faction.standing] || 'Unknown' %></div>
              <div class="faction-item-field"><strong>Jobs Completed:</strong> <%= faction.jobsCompleted || 0 %></div>
              <div class="faction-item-field"><strong>Jobs Failed:</strong> <%= faction.jobsFailed || 0 %></div>
              <div class="faction-item-field"><strong>Brief:</strong> <%= faction.brief %></div>
              <% if (faction.emblem) { %>
                <div class="faction-item-field">
                  <strong>Emblem:</strong> <%= faction.emblem %>
                  <br>
                  <img src="/emblems/<%= faction.emblem %>" alt="<%= faction.emblem.replace('.svg', '') %>" class="emblem-display">
                </div>
              <% } %>
              <div class="faction-item-actions">
                <button class="btn btn-edit" onclick="editFaction('<%= faction.id %>')">Edit</button>
                <button class="btn btn-delete" onclick="deleteFaction('<%= faction.id %>')">Delete</button>
              </div>
            </div>
          <% }); %>
        <% } %>
      </div>
    </div>
  </div>

  <!-- Edit Faction Modal -->
  <div id="editFactionModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Faction</h2>
        <span class="close" onclick="closeEditFactionModal()">&times;</span>
      </div>
      <form id="editFactionForm">
        <input type="hidden" id="editFactionId">
        <div class="form-group">
          <label for="editFactionTitle">Faction Title</label>
          <input type="text" id="editFactionTitle" name="title" required>
        </div>
        
        <div class="form-group">
          <label for="editFactionBrief">Brief</label>
          <textarea id="editFactionBrief" name="brief" required></textarea>
        </div>
        
        <div class="form-group">
          <label for="editFactionStanding">Standing</label>
          <select id="editFactionStanding" name="standing" required>
            <option value="0">0 - Distrusted</option>
            <option value="1">1 - Wary</option>
            <option value="2">2 - Neutral</option>
            <option value="3">3 - Respected</option>
            <option value="4">4 - Trusted</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="editFactionJobsCompleted">Jobs Completed</label>
          <input type="number" id="editFactionJobsCompleted" name="jobsCompleted" min="0" required>
        </div>
        
        <div class="form-group">
          <label for="editFactionJobsFailed">Jobs Failed</label>
          <input type="number" id="editFactionJobsFailed" name="jobsFailed" min="0" required>
        </div>
        
        <div class="form-group">
          <label for="editFactionEmblem">Emblem</label>
          <input type="hidden" id="editFactionEmblem" name="emblem" value="">
          <div class="emblem-grid" id="editFactionEmblemGrid">
            <div class="emblem-option none" data-emblem="">
              [None]
            </div>
            <% emblems.forEach(emblem => { %>
              <div class="emblem-option" data-emblem="<%= emblem %>" title="<%= formatEmblemTitle(emblem) %>">
                <img src="/emblems/<%= emblem %>" alt="<%= formatEmblemTitle(emblem) %>">
              </div>
            <% }); %>
          </div>
        </div>
        
        <button type="submit" class="btn btn-primary">Save Changes</button>
      </form>
    </div>
  </div>
  
  <!-- Edit Transaction Modal -->
  <div id="editTransactionModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Transaction</h2>
        <span class="close" onclick="closeEditTransactionModal()">&times;</span>
      </div>
      <form id="editTransactionForm">
        <input type="hidden" id="editTransactionId">
        <div class="form-group">
          <label for="editTransactionDate">Date</label>
          <input type="datetime-local" id="editTransactionDate" name="date" required>
        </div>
        
        <div class="form-group">
          <label for="editTransactionAmount">Amount (+ or -)</label>
          <input type="number" id="editTransactionAmount" name="amount" required>
        </div>
        
        <div class="form-group">
          <label for="editTransactionDescription">Description</label>
          <input type="text" id="editTransactionDescription" name="description" required>
        </div>
        
        <p style="color: #b0b0b0; margin: 10px 0;">
          <em>Note: Editing transactions does not affect the balance value. Use this for record-keeping purposes only.</em>
        </p>
        
        <button type="submit" class="btn btn-primary">Save Changes</button>
      </form>
    </div>
  </div>
<script>
    // Tab switching
    function switchTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Remove active class from all buttons
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected tab
      document.getElementById(tabName + '-tab').classList.add('active');
      
      // Set button as active
      event.target.classList.add('active');
    }
    
    // Toggle minor module enable/disable
    function toggleMinorModule(checkbox, moduleIndex) {
      const fieldsDiv = document.getElementById(`module-${moduleIndex}-fields`);
      const disabledInput = document.getElementById(`module-${moduleIndex}-disabled`);
      
      // Find the module-item by looking for it in the parent grid
      const moduleGrid = checkbox.closest('.module-grid');
      const allItems = moduleGrid.querySelectorAll('.module-item');
      let moduleItem = null;
      
      // Find the module item that corresponds to this moduleIndex
      allItems.forEach(item => {
        const header = item.querySelector('h4');
        if (header && header.textContent.includes(`Minor Module ${moduleIndex - 8}`)) {
          moduleItem = item;
        }
      });
      
      if (!moduleItem) return; // Safety check
      
      const titleInput = fieldsDiv.querySelector('input[type="text"]');
      const descriptionInput = fieldsDiv.querySelector('textarea');
      const moduleHeader = moduleItem.querySelector('h4');
      const disabledMessage = moduleItem.querySelector('p');
      
      if (checkbox.checked) {
        // Enable the module
        fieldsDiv.style.display = '';
        disabledInput.value = 'false';
        titleInput.disabled = false;
        descriptionInput.disabled = false;
        moduleItem.classList.remove('disabled-module');
        moduleHeader.textContent = `Minor Module ${moduleIndex - 8}`;
        if (disabledMessage) disabledMessage.style.display = 'none';
      } else {
        // Disable the module
        fieldsDiv.style.display = 'none';
        disabledInput.value = 'true';
        titleInput.disabled = true;
        descriptionInput.disabled = true;
        titleInput.value = '';
        descriptionInput.value = '';
        moduleItem.classList.add('disabled-module');
        moduleHeader.textContent = `Minor Module ${moduleIndex - 8} (DISABLED)`;
        if (disabledMessage) disabledMessage.style.display = '';
      }
    }
    
    // Helper function to format emblem filename for display
    function formatEmblemTitle(filename) {
      return filename.replace('.svg', '').replace(/_/g, ' ');
    }

    // Settings form submission
    document.getElementById('settingsForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      
      // Client-side date validation
      const datePattern = /^\d{2}\/\d{2}\/\d{4}$/;
      if (data.unt && !datePattern.test(data.unt)) {
        alert('Invalid date format. Please use DD/MM/YYYY');
        return;
      }
      
      if (data.unt && datePattern.test(data.unt)) {
        const [day, month, year] = data.unt.split('/').map(Number);
        if (month < 1 || month > 12 || day < 1) {
          alert('Invalid date values. Day must be at least 1, month must be 1-12');
          return;
        }
        
        // Check days per month
        const daysInMonth = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
        // Check for leap year
        const isLeapYear = (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
        if (month === 2 && isLeapYear) {
          daysInMonth[1] = 29;
        }
        
        if (day > daysInMonth[month - 1]) {
          alert(`Invalid day for month ${month}. Maximum is ${daysInMonth[month - 1]} days.`);
          return;
        }
      }
      
      try {
        const response = await fetch('/api/settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        if (response.ok) {
          showNotification('Settings saved successfully!');
        } else {
          const errorData = await response.json();
          alert(errorData.message || 'Failed to save settings');
        }
      } catch (error) {
        alert('Error saving settings');
      }
    });

    // Emblem selection handling
    function setupEmblemGrid(gridId, inputId) {
      const grid = document.getElementById(gridId);
      const input = document.getElementById(inputId);
      
      grid.addEventListener('click', (e) => {
        const option = e.target.closest('.emblem-option');
        if (!option) {
          e.stopPropagation();
          return;
        }
        
        // Remove selected class from all options in this grid
        grid.querySelectorAll('.emblem-option').forEach(opt => opt.classList.remove('selected'));
        
        // Add selected class to clicked option
        option.classList.add('selected');
        
        // Update hidden input
        input.value = option.getAttribute('data-emblem');
      });
    }
    
    // Initialize emblem grids
    setupEmblemGrid('emblemGrid', 'jobEmblem');
    setupEmblemGrid('editEmblemGrid', 'editJobEmblem');
    setupEmblemGrid('factionEmblemGrid', 'factionEmblem');
    setupEmblemGrid('editFactionEmblemGrid', 'editFactionEmblem');
    
    // Store notification timeout ID
    let notificationTimeoutId = null;

    // Show notification
    function showNotification(message) {
      const notification = document.getElementById('notificationFooter');
      notification.textContent = message;
      notification.classList.add('show');
      
      // Clear any existing timeout to prevent race conditions
      if (notificationTimeoutId) {
        clearTimeout(notificationTimeoutId);
      }
      notificationTimeoutId = setTimeout(() => {
        notification.classList.remove('show');
        notificationTimeoutId = null;
      }, 3000);
    }

    function upsertEmblemOption(gridEl, emblemFilename) {
      const options = Array.from(gridEl.querySelectorAll('.emblem-option'));
      let option = options.find(o => o.getAttribute('data-emblem') === emblemFilename);

      const title = formatEmblemTitle(emblemFilename);
      const src = `/emblems/${encodeURIComponent(emblemFilename)}?v=${Date.now()}`;

      if (!option) {
        option = document.createElement('div');
        option.className = 'emblem-option';
        option.setAttribute('data-emblem', emblemFilename);
        option.title = title;

        const img = document.createElement('img');
        img.alt = title;
        img.src = src;
        option.appendChild(img);

        gridEl.appendChild(option);
      } else {
        option.title = title;
        const img = option.querySelector('img');
        if (img) img.src = src;
      }

      return option;
    }

    document.getElementById('fileInput').addEventListener('change', async function () {
      if (!this.files || this.files.length === 0) return;

      const filePayload = new FormData();
      filePayload.append('myFile', this.files[0]);

      try {
        const response = await fetch('/upload', {
          method: 'POST',
          body: filePayload
        });

        let data;
        try {
          data = await response.json();
        } catch (jsonError) {
          console.error('Failed to parse JSON response:', jsonError);
          alert('Server returned an invalid response. Please try again or contact support.');
          return;
        }
        if (!response.ok) {
          alert((data && data.message) || 'Upload failed');
          return;
        }

        const emblem = data.emblem;
        const addGrid = document.getElementById('emblemGrid');
        const editGrid = document.getElementById('editEmblemGrid');

        const addOption = upsertEmblemOption(addGrid, emblem);
        upsertEmblemOption(editGrid, emblem);

        addGrid.querySelectorAll('.emblem-option').forEach(o => o.classList.remove('selected'));
        addOption.classList.add('selected');
        document.getElementById('jobEmblem').value = emblem;

        showNotification(`Emblem uploaded: ${emblem}`);
      } catch (error) {
        alert('Network error during upload: ' + error.message);
      } finally {
        this.value = '';
      }
    });

    // Add job
    document.getElementById('addJobForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      
      try {
        const response = await fetch('/api/jobs', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        if (response.ok) {
          showNotification('Job added successfully!');
          setTimeout(() => location.reload(), 3000);
        }
      } catch (error) {
        alert('Error adding job');
      }
    });

    // Edit job
    function editJob(id) {
      const jobItem = document.querySelector(`.job-item[data-id="${id}"]`);
      const jobData = <%- JSON.stringify(jobs) %>.find(j => j.id === id);
      
      document.getElementById('editJobId').value = jobData.id;
      document.getElementById('editJobName').value = jobData.name;
      document.getElementById('editJobRank').value = jobData.rank;
      document.getElementById('editJobClient').value = jobData.client;
      document.getElementById('editJobType').value = jobData.jobType;
      document.getElementById('editJobDescription').value = jobData.description;
      document.getElementById('editJobClientBrief').value = jobData.clientBrief;
      document.getElementById('editJobCurrencyPay').value = jobData.currencyPay;
      document.getElementById('editJobAdditionalPay').value = jobData.additionalPay || '';
      document.getElementById('editJobEmblem').value = jobData.emblem || '';
      
      // Select the correct emblem in the grid
      const editGrid = document.getElementById('editEmblemGrid');
      editGrid.querySelectorAll('.emblem-option').forEach(opt => opt.classList.remove('selected'));
      const selectedEmblem = Array.from(editGrid.querySelectorAll('.emblem-option')).find(opt => opt.getAttribute('data-emblem') === (jobData.emblem || ''));
      if (selectedEmblem) {
        selectedEmblem.classList.add('selected');
      }
      
      document.getElementById('editModal').style.display = 'block';
    }

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
    }

    document.getElementById('editJobForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      const id = document.getElementById('editJobId').value;
      
      try {
        const response = await fetch(`/api/jobs/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        if (response.ok) {
          showNotification('Changes successfully saved');
          closeEditModal();
          setTimeout(() => location.reload(), 3000);
        } else {
          let errorMsg = 'Failed to update job';
          try {
            const errorData = await response.json();
            if (errorData && errorData.message) {
              errorMsg += ': ' + errorData.message;
            }
          } catch (e) {
            // ignore JSON parse errors
          }
          showNotification(errorMsg);
        }
      } catch (error) {
        alert('Error updating job');
      }
    });

    // Delete job
    async function deleteJob(id) {
      if (confirm('Are you sure you want to delete this job?')) {
        try {
          const response = await fetch(`/api/jobs/${id}`, {
            method: 'DELETE'
          });
          
          if (response.ok) {
            alert('Job deleted successfully!');
            location.reload();
          }
        } catch (error) {
          alert('Error deleting job');
        }
      }
    }

    // Delete selected emblem
    async function deleteSelectedEmblem() {
      const selectedEmblem = document.getElementById('jobEmblem').value;
      
      if (!selectedEmblem) {
        alert('Please select an emblem to delete');
        return;
      }
      
      if (confirm(`Are you sure you want to delete the emblem "${formatEmblemTitle(selectedEmblem)}"?\n\nThis action cannot be undone.`)) {
        try {
          const response = await fetch(`/api/emblems/${encodeURIComponent(selectedEmblem)}`, {
            method: 'DELETE'
          });
          
          const data = await response.json();
          
          if (response.ok) {
            showNotification('Emblem deleted successfully!');
            setTimeout(() => location.reload(), 3000);
          } else {
            alert(data.message || 'Failed to delete emblem');
          }
        } catch (error) {
          alert('Error deleting emblem: ' + error.message);
        }
      }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('editModal');
      const factionModal = document.getElementById('editFactionModal');
      const transactionModal = document.getElementById('editTransactionModal');
      if (event.target === modal) {
        closeEditModal();
      }
      if (event.target === factionModal) {
        closeEditFactionModal();
      }
      if (event.target === transactionModal) {
        closeEditTransactionModal();
      }
    };
    
    // ==================== BASE MANAGEMENT ====================
    if (document.getElementById('baseForm')) {
      document.getElementById('baseForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        
        // Build modules array
        const modules = [];
        for (let i = 0; i < 15; i++) {
          modules.push({
            type: formData.get(`modules[${i}][type]`),
            title: formData.get(`modules[${i}][title]`) || '',
            description: formData.get(`modules[${i}][description]`) || '',
            disabled: formData.get(`modules[${i}][disabled]`) === 'true'
          });
        }
        
        try {
          const response = await fetch('/api/base', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ modules })
          });
          
          if (response.ok) {
            showNotification('Base configuration saved successfully!');
          } else {
            alert('Failed to save base configuration');
          }
        } catch (error) {
          alert('Error saving base configuration');
        }
      });
    }
    
    
    // ==================== OVERVIEW MANNA MANAGEMENT ====================
    if (document.getElementById('directBalanceForm')) {
      document.getElementById('directBalanceForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const balance = parseInt(formData.get('balance'));
        
        try {
          const response = await fetch('/api/manna', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ balance, description: '', amount: 0 })
          });
          
          if (response.ok) {
            const result = await response.json();
            document.getElementById('overviewMannaBalance').textContent = result.manna.balance;
            showNotification('Balance updated successfully!');
          } else {
            alert('Failed to update balance');
          }
        } catch (error) {
          alert('Error updating balance');
        }
      });
    }
    
    if (document.getElementById('overviewMannaForm')) {
      document.getElementById('overviewMannaForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        
        try {
          const response = await fetch('/api/manna/transaction', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          
          if (response.ok) {
            const result = await response.json();
            document.getElementById('overviewMannaBalance').textContent = result.manna.balance;
            document.getElementById('directBalance').value = result.manna.balance;
            document.getElementById('overviewMannaForm').reset();
            showNotification('Transaction added successfully!');
          } else {
            const errorData = await response.json();
            alert(errorData.message || 'Failed to add transaction');
          }
        } catch (error) {
          alert('Error adding transaction');
        }
      });
    }
    
    // ==================== MANNA MANAGEMENT ====================
    if (document.getElementById('mannaForm')) {
      document.getElementById('mannaForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        
        try {
          const response = await fetch('/api/manna/transaction', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          
          if (response.ok) {
            const result = await response.json();
            document.getElementById('mannaBalance').textContent = result.manna.balance;
            document.getElementById('mannaForm').reset();
            showNotification('Transaction added successfully!');
          } else {
            const errorData = await response.json();
            alert(errorData.message || 'Failed to add transaction');
          }
        } catch (error) {
          alert('Error adding transaction');
        }
      });
    }
    
    // ==================== FACTION MANAGEMENT ====================
    if (document.getElementById('addFactionForm')) {
      document.getElementById('addFactionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        
        try {
          const response = await fetch('/api/factions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          
          if (response.ok) {
            showNotification('Faction added successfully!');
            setTimeout(() => location.reload(), 3000);
          } else {
            const errorData = await response.json();
            alert(errorData.message || 'Failed to add faction');
          }
        } catch (error) {
          alert('Error adding faction');
        }
      });
    }
    
    function editFaction(id) {
      const factionData = <%- JSON.stringify(factions) %>.find(f => f.id === id);
      
      document.getElementById('editFactionId').value = factionData.id;
      document.getElementById('editFactionTitle').value = factionData.title;
      document.getElementById('editFactionBrief').value = factionData.brief;
      document.getElementById('editFactionStanding').value = factionData.standing;
      document.getElementById('editFactionJobsCompleted').value = factionData.jobsCompleted || 0;
      document.getElementById('editFactionJobsFailed').value = factionData.jobsFailed || 0;
      document.getElementById('editFactionEmblem').value = factionData.emblem || '';
      
      // Select the correct emblem in the grid
      const editGrid = document.getElementById('editFactionEmblemGrid');
      editGrid.querySelectorAll('.emblem-option').forEach(opt => opt.classList.remove('selected'));
      const selectedEmblem = Array.from(editGrid.querySelectorAll('.emblem-option')).find(opt => opt.getAttribute('data-emblem') === (factionData.emblem || ''));
      if (selectedEmblem) {
        selectedEmblem.classList.add('selected');
      }
      
      document.getElementById('editFactionModal').style.display = 'block';
    }
    
    function closeEditFactionModal() {
      document.getElementById('editFactionModal').style.display = 'none';
    }
    
    if (document.getElementById('editFactionForm')) {
      document.getElementById('editFactionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        const id = document.getElementById('editFactionId').value;
        
        try {
          const response = await fetch(`/api/factions/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          
          if (response.ok) {
            showNotification('Faction updated successfully');
            closeEditFactionModal();
            setTimeout(() => location.reload(), 3000);
          } else {
            const errorData = await response.json();
            alert(errorData.message || 'Failed to update faction');
          }
        } catch (error) {
          alert('Error updating faction');
        }
      });
    }
    
    async function deleteFaction(id) {
      if (confirm('Are you sure you want to delete this faction?')) {
        try {
          const response = await fetch(`/api/factions/${id}`, {
            method: 'DELETE'
          });
          
          if (response.ok) {
            showNotification('Faction deleted successfully!');
            setTimeout(() => location.reload(), 3000);
          } else {
            alert('Failed to delete faction');
          }
        } catch (error) {
          alert('Error deleting faction');
        }
      }
    }
    
    // ==================== TRANSACTION MANAGEMENT ====================
    function editTransaction(id) {
      const transactionData = <%- JSON.stringify(manna.transactions) %>.find(t => t.id === id);
      
      if (!transactionData) {
        alert('Transaction not found');
        return;
      }
      
      document.getElementById('editTransactionId').value = transactionData.id;
      
      // Convert ISO date to datetime-local format (YYYY-MM-DDTHH:mm)
      const date = new Date(transactionData.date);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const localDatetime = `${year}-${month}-${day}T${hours}:${minutes}`;
      
      document.getElementById('editTransactionDate').value = localDatetime;
      document.getElementById('editTransactionAmount').value = transactionData.amount;
      document.getElementById('editTransactionDescription').value = transactionData.description;
      
      document.getElementById('editTransactionModal').style.display = 'block';
    }
    
    function closeEditTransactionModal() {
      document.getElementById('editTransactionModal').style.display = 'none';
    }
    
    if (document.getElementById('editTransactionForm')) {
      document.getElementById('editTransactionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        const id = document.getElementById('editTransactionId').value;
        
        // Validate amount
        const amount = parseInt(data.amount);
        if (isNaN(amount)) {
          alert('Invalid amount. Please enter a valid number.');
          return;
        }
        
        try {
          const response = await fetch(`/api/manna/transaction/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              date: new Date(data.date).toISOString(),
              amount: amount,
              description: data.description
            })
          });
          
          if (response.ok) {
            showNotification('Transaction updated successfully');
            closeEditTransactionModal();
            setTimeout(() => location.reload(), 3000);
          } else {
            const errorData = await response.json();
            alert(errorData.message || 'Failed to update transaction');
          }
        } catch (error) {
          alert('Error updating transaction');
        }
      });
    }
    
    async function deleteTransaction(id) {
      if (confirm('Are you sure you want to delete this transaction?\n\nNote: This will NOT affect the current balance value.')) {
        try {
          const response = await fetch(`/api/manna/transaction/${id}`, {
            method: 'DELETE'
          });
          
          if (response.ok) {
            showNotification('Transaction deleted successfully!');
            setTimeout(() => location.reload(), 3000);
          } else {
            const errorData = await response.json();
            alert(errorData.message || 'Failed to delete transaction');
          }
        } catch (error) {
          alert('Error deleting transaction');
        }
      }
    }
  </script></body></html>