<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LANCER Job Board - Admin</title>
  <link rel="stylesheet" href="/css/currency.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      background-color: #1a1a1a;
      padding: 20px;
    }
    
    .admin-header {
      background-color: #2a2a2a;
      color: #e0e0e0;
      padding: 20px;
      margin-bottom: 30px;
      border-radius: 5px;
    }
    
    .admin-header h1 {
      margin-bottom: 10px;
    }
    
    .logout-link {
      color: #66BB6A;
      text-decoration: none;
      font-weight: bold;
    }
    
    .settings-section {
      background-color: #2a2a2a;
      padding: 30px;
      margin-bottom: 30px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }
    
    .settings-section h2 {
      margin-bottom: 20px;
      color: #e0e0e0;
    }
    
    .add-job-section {
      background-color: #2a2a2a;
      padding: 30px;
      margin-bottom: 30px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }
    
    .add-job-section h2 {
      margin-bottom: 20px;
      color: #e0e0e0;
    }
    
    .form-group {
      margin-bottom: 22px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #b0b0b0;
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #444;
      border-radius: 3px;
      font-size: 14px;
      background-color: #1a1a1a;
      color: #e0e0e0;
    }
    
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: 2px solid #66BB6A;
      outline-offset: 1px;
    }
    
    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
    }
    
    .btn-primary {
      background-color: #4CAF50;
      color: white;
      margin-right: 5px;
    }
    
    .btn-primary:hover {
      background-color: #45a049;
    }
    
    .btn-edit {
      background-color: #2196F3;
      color: white;
      margin-right: 5px;
    }
    
    .btn-edit:hover {
      background-color: #0b7dda;
    }
    
    .btn-delete {
      background-color: #f44336;
      color: white;
      margin-right: 5px;
    }
    
    .btn-delete:hover {
      background-color: #da190b;
    }
    
    .btn-neutral {
      background-color: #6a6a6a;
      color: white;
    }
    
    .btn-neutral:hover {
      background-color: #5a5a5a;
    }
    
    .btn-neutral:focus {
      outline: 2px solid #66BB6A;
      outline-offset: 1px;
    }
    
    .btn-secondary {
      background-color: #888;
      color: white;
      margin-right: 5px;
    }
    
    .btn-secondary:hover {
      background-color: #777;
    }
    
    .filter-pill {
      padding: 8px 16px;
      margin-right: 8px;
      border: 2px solid #666;
      border-radius: 20px;
      background-color: #1a1a1a;
      color: #b0b0b0;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.2s;
    }
    
    .filter-pill:hover {
      background-color: #2a2a2a;
      border-color: #888;
    }
    
    .filter-pill.active {
      background-color: #66BB6A;
      color: white;
      border-color: #66BB6A;
    }
    
    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: flex-start;
      margin-top: 20px;
    }
    
    .button-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .jobs-list {
      background-color: #2a2a2a;
      padding: 30px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }
    
    .jobs-list h2 {
      margin-bottom: 20px;
      color: #e0e0e0;
    }
    
    .job-item {
      border: 1px solid #444;
      padding: 20px;
      margin-bottom: 15px;
      border-radius: 3px;
      background-color: #1a1a1a;
    }
    
    .job-item h3 {
      color: #e0e0e0;
      margin-bottom: 10px;
    }
    
    .job-item-field {
      margin-bottom: 8px;
      color: #b0b0b0;
      white-space: pre-line;
    }
    
    .job-item-field strong {
      color: #e0e0e0;
    }
    
    .job-item-actions {
      margin-top: 15px;
    }
    
    .rank-display {
      color: #FFD700;
      font-size: 18px;
      font-family: Arial, sans-serif;
      white-space: nowrap;
      display: inline-flex;
      gap: 0;
    }
    
    .rank-display .star {
      display: inline-block;
      width: 1em;
      text-align: center;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
    }
    
    .modal-content {
      background-color: #2a2a2a;
      margin: 5% auto;
      padding: 30px;
      border-radius: 5px;
      width: 80%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-header h2 {
      color: #e0e0e0;
    }
    
    .close {
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      color: #b0b0b0;
    }
    
    .close:hover {
      color: #e0e0e0;
    }
    
    .emblem-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 10px;
      margin-top: 10px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #444;
      padding: 10px;
      border-radius: 3px;
      background-color: #ffffff;
    }
    
    .emblem-option {
      position: relative;
      padding: 8px;
      border: 2px solid transparent;
      border-radius: 3px;
      cursor: pointer;
      transition: all 0.2s ease;
      background-color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 80px;
    }
    
    .emblem-option:hover {
      border-color: #66BB6A;
      box-shadow: 0 2px 5px rgba(102,187,106,0.3);
    }
    
    .emblem-option.selected {
      border-color: #66BB6A;
      background-color: #e8f5e9;
      box-shadow: 0 2px 8px rgba(102, 187, 106, 0.5);
    }
    
    .emblem-option img {
      width: 60px;
      height: 60px;
      object-fit: contain;
      display: block;
    }
    
    .emblem-option.none {
      font-size: 12px;
      color: #666;
      font-weight: bold;
      text-align: center;
    }
    
    .notification-footer {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #4CAF50;
      color: white;
      padding: 15px 25px;
      border-radius: 5px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      font-weight: bold;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
      z-index: 2000;
      pointer-events: none;
      white-space: nowrap;
      min-width: 200px;
      display: block;
    }
    
    .notification-footer.show {
      opacity: 1;
    }
    
    .emblem-display {
      width: 150px;
      height: 150px;
      margin-top: 10px;
      border: 1px solid #ddd;
      padding: 10px;
      background-color: white;
      border-radius: 3px;
      object-fit: contain;
    }

    .form-inline {
      display: inline;
    }

    .is-hidden {
      display: none;
    }

    .helper-text {
      font-size: 0.9em;
      color: #e0e0e0;
    }

    .btn-add-job {
      margin-top: 25px;
      padding: 15px 30px;
      font-size: 16px;
      font-weight: bold;
      box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
    }
    
    /* State Badge Styles */
    .state-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 3px;
      font-size: 12px;
      font-weight: bold;
      text-transform: uppercase;
    }
    
    .state-badge-pending {
      background-color: #FFC107;
      color: #000;
    }
    
    .state-badge-active {
      background-color: #4CAF50;
      color: white;
    }
    
    .state-badge-complete {
      background-color: #2196F3;
      color: white;
    }
    
    .state-badge-failed {
      background-color: #f44336;
      color: white;
    }
    
    .state-badge-ignored {
      background-color: #9E9E9E;
      color: white;
    }
    
    /* Filter Pills */
    .filter-pills {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .filter-pill {
      padding: 8px 16px;
      border: 2px solid #444;
      border-radius: 20px;
      background-color: #1a1a1a;
      color: #b0b0b0;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.2s;
    }
    
    .filter-pill:hover {
      border-color: #66BB6A;
      color: #e0e0e0;
    }
    
    .filter-pill.active {
      background-color: #66BB6A;
      color: white;
      border-color: #66BB6A;
    }
  
    /* Tab Navigation */
    .tab-navigation {
      background-color: #2a2a2a;
      padding: 15px 20px;
      margin-bottom: 20px;
      border-radius: 5px;
      display: flex;
      gap: 10px;
    }
    
    .tab-button {
      padding: 12px 24px;
      border: none;
      background-color: #3a3a3a;
      color: #b0b0b0;
      cursor: pointer;
      border-radius: 3px;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.3s ease;
    }
    
    .tab-button:hover {
      background-color: #4a4a4a;
      color: #e0e0e0;
    }
    
    .tab-button.active {
      background-color: #66BB6A;
      color: #1a1a1a;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .facility-grid {
      display: grid;
      gap: 15px;
      margin-bottom: 30px;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    }
    
    .facility-card {
      border: 1px solid #444;
      padding: 15px;
      border-radius: 5px;
      background-color: #1a1a1a;
    }
    
    .facility-card.disabled-facility {
      opacity: 0.4;
    }
    
    .facility-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .facility-header h4 {
      color: #66BB6A;
      margin: 0;
      font-size: 16px;
    }
    
    .facility-price {
      color: #FFD54F;
      font-size: 14px;
      margin-bottom: 8px;
      font-weight: bold;
    }
    
    .facility-description {
      color: #b0b0b0;
      font-size: 13px;
      line-height: 1.5;
      margin-bottom: 15px;
    }
    
    .purchased-toggle,
    .enabled-toggle {
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      font-size: 13px;
      color: #b0b0b0;
    }
    
    .purchased-toggle input,
    .enabled-toggle input {
      cursor: pointer;
    }
    
    .upgrades-section {
      border-top: 1px solid #333;
      padding-top: 10px;
      margin-top: 10px;
    }
    
    .upgrades-section h5 {
      color: #e0e0e0;
      font-size: 14px;
      margin-bottom: 10px;
    }
    
    .upgrade-item {
      background: rgba(255,255,255,0.05);
      padding: 10px;
      border-radius: 3px;
      margin-bottom: 10px;
    }
    
    .upgrade-item:last-child {
      margin-bottom: 0;
    }
    
    .upgrade-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }
    
    .upgrade-info strong {
      color: #e0e0e0;
      font-size: 13px;
    }
    
    .upgrade-price {
      color: #FFD54F;
      font-size: 12px;
    }
    
    .upgrade-description {
      color: #b0b0b0;
      font-size: 12px;
      line-height: 1.4;
      margin-bottom: 8px;
    }
    
    .upgrade-count {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #b0b0b0;
    }
    
    .upgrade-count-input {
      width: 50px;
      padding: 4px;
      border: 1px solid #444;
      border-radius: 3px;
      background-color: #2a2a2a;
      color: #e0e0e0;
      text-align: center;
    }
    
    .assigned-facility h5 {
      color: #66BB6A;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .empty-slot {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    
    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
    }
    
    .minor-slot.disabled-facility .btn {
      display: none;
    }
    
    .minor-facility-selection-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 10px;
      max-height: 60vh;
      overflow-y: auto;
      padding: 10px;
      background-color: #0a0a0a;
      border-radius: 5px;
    }
    
    .minor-facility-option {
      border: 2px solid #444;
      padding: 12px;
      border-radius: 5px;
      background-color: #1a1a1a;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .minor-facility-option:hover {
      border-color: #66BB6A;
      background-color: #2a2a2a;
    }
    
    .minor-facility-option h4 {
      color: #66BB6A;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .minor-facility-option .facility-price {
      color: #FFD54F;
      font-size: 12px;
      margin-bottom: 6px;
    }
    
    .minor-facility-option p {
      color: #b0b0b0;
      font-size: 12px;
      line-height: 1.4;
    }
    
    .manna-display {
      font-size: 32px;
      font-weight: bold;
      color: #66BB6A;
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }
    
    .manna-display .currency-icon {
      width: 32px;
      height: 32px;
    }
    
    .faction-item {
      border: 1px solid #444;
      padding: 20px;
      margin-bottom: 15px;
      border-radius: 3px;
      background-color: #1a1a1a;
    }
    
    .faction-item h3 {
      color: #e0e0e0;
      margin-bottom: 10px;
    }
    
    .faction-item-field {
      margin-bottom: 8px;
      color: #b0b0b0;
    }
    
    .faction-item-field strong {
      color: #e0e0e0;
    }
    
    .faction-item-actions {
      margin-top: 15px;
    }
    
    .transaction-item {
      border: 1px solid #444;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 3px;
      background-color: #1a1a1a;
    }
    
    .transaction-item-field {
      margin-bottom: 6px;
      color: #b0b0b0;
    }
    
    .transaction-item-field strong {
      color: #e0e0e0;
    }
    
    .transaction-item-actions {
      margin-top: 10px;
    }
</style>
</head><body><div class="admin-header">
    <h1>LANCER Job Board - Admin Panel</h1>
    <p>Manage job postings, base modules, factions, and global settings</p>
    <a href="/logout" class="logout-link">Logout</a>
  </div>
  <!-- Tab Navigation -->
  <div class="tab-navigation">
    <button class="tab-button active" onclick="switchTab('overview', event)">Overview Config</button>
    <button class="tab-button" onclick="switchTab('transactions', event)">Transaction Management</button>
    <button class="tab-button" onclick="switchTab('jobs', event)">Job Board Config</button>
    <button class="tab-button" onclick="switchTab('vote', event)">Vote Config</button>
    <button class="tab-button" onclick="switchTab('factions', event)">Faction Config</button>
    <button class="tab-button" onclick="switchTab('base', event)">Base Config</button>
    <button class="tab-button" onclick="switchTab('pilots', event)">Pilot Config</button>
    <button class="tab-button" onclick="switchTab('store', event)">Shop & Reserves Config</button>
  </div>

  <!-- Overview Tab -->
  <div id="overview-tab" class="tab-content active">
    <div class="settings-section">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;">Global Settings</h2>
        <button type="submit" form="settingsForm" class="btn btn-primary">Save Settings</button>
      </div>
      <form id="settingsForm">
        <input type="hidden" id="settingsCurrencyIcon" name="currencyIcon" value="<%= settings.currencyIcon || 'manna_symbol.svg' %>">
        <div class="form-group">
          <label for="settingsPortalHeading">Portal Heading (Landing & Client View)</label>
          <input type="text" id="settingsPortalHeading" name="portalHeading" value="<%= settings.portalHeading %>" maxlength="100" required>
        </div>
        
        <div class="form-group">
          <label for="settingsColorScheme">Color Scheme (Client & Landing View)</label>
          <select id="settingsColorScheme" name="colorScheme" required>
            <option value="grey" <%= settings.colorScheme === 'grey' ? 'selected' : '' %>>Grey (Black & White)</option>
            <option value="orange" <%= settings.colorScheme === 'orange' ? 'selected' : '' %>>Orange (Portal Style)</option>
            <option value="green" <%= settings.colorScheme === 'green' ? 'selected' : '' %>>Green (Classic Terminal)</option>
            <option value="blue" <%= settings.colorScheme === 'blue' ? 'selected' : '' %>>Blue (Dark Blue Background)</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="settingsUnt">UNT (Date - DD/MM/YYYY)</label>
          <input type="text" id="settingsUnt" name="unt" value="<%= settings.unt %>" placeholder="DD/MM/YYYY" pattern="\d{2}/\d{2}/\d{4}" required>
        </div>
        
        <div class="form-group">
          <label for="settingsGalacticPos">Current Galactic Position</label>
          <input type="text" id="settingsGalacticPos" name="currentGalacticPos" value="<%= settings.currentGalacticPos %>" required>
        </div>
        
        <div class="form-group">
          <label for="settingsUserGroup">User Group</label>
          <input type="text" id="settingsUserGroup" name="userGroup" value="<%= settings.userGroup %>" maxlength="100" required>
        </div>
        
        <div class="form-group">
          <label for="settingsOperationProgress">Operation Progress (0-3)</label>
          <select id="settingsOperationProgress" name="operationProgress" required>
            <option value="0" <%= settings.operationProgress === 0 ? 'selected' : '' %>>0 - Initial</option>
            <option value="1" <%= settings.operationProgress === 1 ? 'selected' : '' %>>1 - Developing</option>
            <option value="2" <%= settings.operationProgress === 2 ? 'selected' : '' %>>2 - Advanced</option>
            <option value="3" <%= settings.operationProgress === 3 ? 'selected' : '' %>>3 - Critical</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="settingsClientPassword">Pilot Password (CLIENT Mode Access)</label>
          <input type="text" id="settingsClientPassword" name="clientPassword" value="<%= settings.clientPassword || '' %>" placeholder="Alphanumeric only, empty for no password" pattern="[A-Za-z0-9]*">
          <small style="display: block; color: #b0b0b0; margin-top: 5px;">Only alphanumeric characters allowed. Leave empty to allow access without password.</small>
        </div>
        
        <div class="form-group">
          <label for="settingsAdminPassword">Admin Password (ADMIN Mode Access)</label>
          <input type="text" id="settingsAdminPassword" name="adminPassword" value="<%= settings.adminPassword || '' %>" placeholder="Alphanumeric only, empty for no password" pattern="[A-Za-z0-9]*">
          <small style="display: block; color: #b0b0b0; margin-top: 5px;">Only alphanumeric characters allowed. Leave empty to allow access without password.</small>
        </div>
        
        <div class="form-group">
          <label for="settingsOpenTable" style="display: inline-block; font-weight: bold; margin-bottom: 0;">
            Open Table (Show pilot personal operation progress)
          </label>
          <input type="checkbox" id="settingsOpenTable" name="openTable" value="true" <%= settings.openTable ? 'checked' : '' %> style="width: auto; margin-left: 10px; vertical-align: middle;">
        </div>
        
        <div class="form-group">
          <label>Currency Icon</label>
          <button type="button" class="btn" onclick="openCurrencyIconModal()" style="margin-top: 5px;">
            Change Currency Icon
          </button>
          <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
            <span style="color: #b0b0b0;">Current:</span>
            <img id="currentCurrencyIconPreview" src="/emblems/<%= settings.currencyIcon || 'manna_symbol.svg' %>" alt="Currency Icon" style="width: 40px; height: 40px; border: 1px solid #444; padding: 5px; border-radius: 3px; background: white;">
            <span style="color: #e0e0e0;" id="currentCurrencyIconName"><%= settings.currencyIcon || 'manna_symbol.svg' %></span>
          </div>
        </div>
        
        <button type="submit" class="btn btn-primary">Save Settings</button>
      </form>
    </div>
  </div>

  <!-- Transaction Management Tab -->
  <div id="transactions-tab" class="tab-content">
    <div class="settings-section">
      <h2>Manna Balance Management</h2>
      <div class="manna-display">
        <div style="margin-bottom: 10px;">
          <strong>Active Balance:</strong> <span id="activeBalance" style="font-size: 1.3em;"><%= balances.activeBalance %></span>
          <img src="/emblems/<%= settings.currencyIcon || 'manna_symbol.svg' %>" alt="Currency Icon" class="currency-icon">
        </div>
        <div style="font-size: 0.9em; color: #b0b0b0;">
          Total Balance: <span id="totalBalance"><%= balances.totalBalance %></span>
          <img src="/emblems/<%= settings.currencyIcon || 'manna_symbol.svg' %>" alt="Currency Icon" class="currency-icon" style="width: 20px; height: 20px;">
        </div>
      </div>
      
      <h3 style="color: #e0e0e0; margin: 20px 0 15px;">Add Transaction</h3>
      <p style="color: #FFD700; margin-bottom: 10px; font-size: 0.9em;">
        <strong>Note:</strong> Each pilot will be affected by the full transaction amount.
      </p>
      <form id="overviewMannaForm">
        <div class="form-group">
          <label for="overviewMannaAmount">Amount (+ or -)</label>
          <input type="number" id="overviewMannaAmount" name="amount" required>
        </div>
        <div class="form-group">
          <label for="overviewMannaDescription">Transaction Description</label>
          <input type="text" id="overviewMannaDescription" name="description" required>
        </div>
        <div class="form-group">
          <button type="button" class="btn btn-secondary" onclick="openPilotSelectionModal()">Select Pilot(s)</button>
          <input type="hidden" id="selectedPilotIds" name="pilotIds" value="">
          <p style="color: #b0b0b0; margin-top: 5px; font-size: 0.9em;">
            <span id="selectedPilotsText">No pilots selected (will assign to all active pilots)</span>
          </p>
        </div>
        <button type="submit" class="btn btn-primary">Add Transaction</button>
      </form>
      
      <h3 style="color: #e0e0e0; margin: 20px 0 15px;">Transaction History</h3>
      
      <div style="margin-bottom: 15px;">
        <button class="filter-pill active" data-filter="all" onclick="filterTransactions('all', event)">All</button>
        <button class="filter-pill" data-filter="assigned" onclick="filterTransactions('assigned', event)">Assigned</button>
        <button class="filter-pill" data-filter="unassigned" onclick="filterTransactions('unassigned', event)">Unassigned</button>
      </div>
      
      <div id="transactionsList">
        <% if (manna.transactions.length === 0) { %>
          <p style="color: #b0b0b0;">No transactions yet.</p>
        <% } else { %>
          <% 
          // Create a map of which pilots have which transactions
          const pilotTransactionMap = {};
          pilots.forEach(pilot => {
            if (pilot.personalTransactions && Array.isArray(pilot.personalTransactions)) {
              pilot.personalTransactions.forEach(txnId => {
                if (!pilotTransactionMap[txnId]) {
                  pilotTransactionMap[txnId] = [];
                }
                pilotTransactionMap[txnId].push(pilot);
              });
            }
          });
          %>
          <% manna.transactions.slice().reverse().forEach(transaction => { %>
            <% 
            const assignedPilots = pilotTransactionMap[transaction.id] || [];
            const isAssigned = assignedPilots.length > 0;
            
            // Sort pilots: active pilots first, then inactive pilots (create copy to avoid mutation)
            const sortedPilots = [...assignedPilots].sort((a, b) => {
              if (a.active && !b.active) return -1;
              if (!a.active && b.active) return 1;
              return 0;
            });
            
            // Count active pilots only
            const activePilotCount = assignedPilots.filter(p => p.active).length;
            const totalAmount = activePilotCount * transaction.amount;
            %>
            <div class="transaction-item" data-id="<%= transaction.id %>" data-assigned="<%= isAssigned ? 'true' : 'false' %>">
              <div class="transaction-item-field">
                <strong>Date:</strong> <%= new Date(transaction.date).toLocaleString('en-GB', { dateStyle: 'short', timeStyle: 'short' }) %>
              </div>
              <div class="transaction-item-field">
                <strong>Total amount:</strong> 
                <span style="color: <%= totalAmount >= 0 ? '#66BB6A' : '#f44336' %>">
                  <%= totalAmount >= 0 ? '+' : '' %><%= totalAmount %>
                </span>
                <img src="/emblems/<%= settings.currencyIcon || 'manna_symbol.svg' %>" alt="Currency Icon" class="currency-icon">
                <span style="color: #888; font-size: 0.9em; margin-left: 5px;">
                  (<%= activePilotCount %> active pilot<%= activePilotCount !== 1 ? 's' : '' %>)
                </span>
              </div>
              <div class="transaction-item-field">
                <strong>Individual amount:</strong> 
                <span style="color: <%= transaction.amount >= 0 ? '#66BB6A' : '#f44336' %>">
                  <%= transaction.amount >= 0 ? '+' : '' %><%= transaction.amount %>
                </span>
                <img src="/emblems/<%= settings.currencyIcon || 'manna_symbol.svg' %>" alt="Currency Icon" class="currency-icon">
              </div>
              <div class="transaction-item-field">
                <strong>Description:</strong> <%= transaction.description %>
              </div>
              <div class="transaction-item-field">
                <strong>Assigned to:</strong> 
                <% if (sortedPilots.length === 0) { %>
                  <span style="color: #888;">Unassigned</span>
                <% } else { %>
                  <% sortedPilots.forEach((pilot, index) => { %>
                    <span style="color: <%= pilot.active ? '#66BB6A' : '#888' %>;">
                      <%= pilot.callsign %><%= index < sortedPilots.length - 1 ? ', ' : '' %>
                    </span>
                  <% }); %>
                <% } %>
              </div>
              <div class="transaction-item-actions">
                <button class="btn btn-secondary" onclick="editTransactionPilots('<%= transaction.id %>')">Select Pilot(s)</button>
                <button class="btn btn-edit" onclick="editTransaction('<%= transaction.id %>')">Edit</button>
                <button class="btn btn-delete" onclick="deleteTransaction('<%= transaction.id %>')">Delete</button>
              </div>
            </div>
          <% }); %>
        <% } %>
      </div>
    </div>
  </div>

  <!-- Jobs Tab -->
  <div id="jobs-tab" class="tab-content">
  <div class="add-job-section">
    <h2>Add New Job</h2>
    <form id="addJobForm">
      <div class="form-group">
        <label for="jobName">Job Name</label>
        <input type="text" id="jobName" name="name" required>
      </div>
      
      <div class="form-group">
        <label for="jobRank">Job Rank (1-3 stars)</label>
        <select id="jobRank" name="rank" required>
          <option value="1">1 Star</option>
          <option value="2">2 Stars</option>
          <option value="3">3 Stars</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="jobState">Job State</label>
        <select id="jobState" name="state" required>
          <% jobStates.forEach(state => { %>
            <option value="<%= state %>" <%= state === defaultJobState ? 'selected' : '' %>><%= state %></option>
          <% }); %>
        </select>
      </div>
      
      <div class="form-group">
        <label for="jobFaction">Faction (Optional)</label>
        <select id="jobFaction" name="factionId">
          <option value="">None</option>
          <% factions.forEach(faction => { %>
            <option value="<%= faction.id %>"><%= faction.title %></option>
          <% }); %>
        </select>
      </div>
      
      <div class="form-group">
        <label for="jobType">Job Type</label>
        <input type="text" id="jobType" name="jobType" required>
      </div>
      
      <div class="form-group">
        <label for="jobDescription">Objective</label>
        <textarea id="jobDescription" name="description" required></textarea>
      </div>
      
      <div class="form-group">
        <label for="jobClientBrief">Client Brief</label>
        <textarea id="jobClientBrief" name="clientBrief" required></textarea>
      </div>
      
      <div class="form-group">
        <label for="jobCurrencyPay" class="currency-label">
          Currency Pay (e.g., 100m)
          <img src="/emblems/<%= settings.currencyIcon || 'manna_symbol.svg' %>" alt="Currency Icon" class="currency-icon">
        </label>
        <input type="text" id="jobCurrencyPay" name="currencyPay" required>
      </div>
      
      <div class="form-group">
        <label for="jobAdditionalPay">Additional Pay</label>
        <input type="text" id="jobAdditionalPay" name="additionalPay">
      </div>
      
      <div class="form-group">
        <label for="jobAdminLog">Admin Log</label>
        <textarea id="jobAdminLog" name="adminLog" rows="3" placeholder="GM-only notes for this job"></textarea>
      </div>
      
      <div class="form-group">
        <label for="jobEmblem">Emblem</label>
        <input type="hidden" id="jobEmblem" name="emblem" value="">
        <div class="emblem-grid" id="emblemGrid">
          <div class="emblem-option none" data-emblem="">
            [None]
          </div>
          <% emblems.forEach(emblem => { %>
            <div class="emblem-option" data-emblem="<%= emblem %>" title="<%= formatEmblemTitle(emblem) %>">
              <img src="/emblems/<%= emblem %>" alt="<%= formatEmblemTitle(emblem) %>">
            </div>
          <% }); %>
        </div>
      </div>
    </form>
	
<div class="button-group">
  <div class="button-container">
    <form id="uploadForm" class="form-inline" enctype="multipart/form-data">
      <input type="file" id="fileInput" class="is-hidden" name="myFile" accept="image/png,image/jpeg,image/bmp">
      <button type="button" class="btn btn-neutral"
        onclick="document.getElementById('fileInput').click();"
        title="Uploads an image and converts it to SVG">
        Upload Emblem
      </button>
    </form>
    <p class="helper-text">Accepts PNG, JPEG, BMP (max 10MB)</p>
  </div>
  
  <div class="button-container">
    <button type="button" class="btn btn-delete" id="deleteEmblemBtn" onclick="deleteSelectedEmblem()"
      title="Deletes the currently selected emblem (if not in use by any jobs)">
      Delete Selected Emblem
    </button>
    <p class="helper-text">Deletes the selected emblem if not in use</p>
  </div>
</div>

<button type="submit" class="btn btn-primary btn-add-job" form="addJobForm">Add Job</button>
	
  </div>

  <div class="jobs-list">
    <h2>Job History</h2>
    
    <!-- Progress All Jobs Button -->
    <div style="margin-bottom: 20px;">
      <button class="btn btn-neutral" onclick="showProgressAllJobsModal()" style="font-size: 14px; padding: 10px 20px;">
        Progress all Jobs
      </button>
      
      <% 
        const hasOngoingVotingPeriod = votingPeriods.find(p => p.state === 'Ongoing');
      %>
      <% if (hasOngoingVotingPeriod) { %>
        <div style="margin-top: 10px; padding: 10px; background-color: #3a2a1a; border: 1px solid #FFA726; border-radius: 3px;">
          <strong style="color: #FFA726;">⚠ Warning:</strong>
          <span style="color: #e0e0e0;">
            Moving any Active Job out of the Active state will automatically archive the current Voting Period.
          </span>
        </div>
      <% } %>
    </div>
    
    <!-- Search Bar -->
    <div style="margin-bottom: 20px;">
      <div class="form-group">
        <label for="admin-job-search-input">Search Jobs</label>
        <div style="display: flex; gap: 10px; align-items: center;">
          <input type="text" id="admin-job-search-input" placeholder="Filter jobs..." style="flex: 1; max-width: 400px;">
          <select id="admin-job-search-field" style="width: 100px;">
            <option value="all">All</option>
            <option value="name">Name</option>
            <option value="faction">Faction</option>
            <option value="description">Description</option>
            <option value="pilot">Pilot</option>
          </select>
          <button onclick="searchAdminJobs()" class="btn btn-primary">Search</button>
          <button onclick="clearAdminJobSearch()" class="btn btn-neutral">Clear</button>
        </div>
      </div>
    </div>
    
    <!-- Filter Pills -->
    <div class="filter-pills">
      <button class="filter-pill active" data-state="all" onclick="filterJobs('all')">All</button>
      <% jobStates.forEach(state => { %>
        <button class="filter-pill" data-state="<%= state %>" onclick="filterJobs('<%= state %>')"><%= state %></button>
      <% }); %>
    </div>
    
    <div id="jobsList">
      <% jobs.forEach(job => { %>
        <div class="job-item" data-id="<%= job.id %>" data-state="<%= job.state || defaultJobState %>">
          <h3><%= job.name %> <span class="state-badge state-badge-<%= job.stateClass %>"><%= job.state || defaultJobState %></span></h3>
          <div class="job-item-field">
            <strong>Rank:</strong> 
            <span class="rank-display">
              <% for(let i = 0; i < job.rank; i++) { %><span class="star">★</span><% } %>
              <% for(let i = job.rank; i < 3; i++) { %><span class="star">☆</span><% } %>
            </span>
          </div>
          <div class="job-item-field"><strong>Faction:</strong> <%= job.faction ? job.faction.title : 'FIELD_NULL' %></div>
          <div class="job-item-field"><strong>Job Type:</strong> <%= job.jobType %></div>
          <div class="job-item-field"><strong>Objective:</strong> <%= job.description %></div>
          <div class="job-item-field"><strong>Client Brief:</strong> <%= job.clientBrief %></div>
          <div class="job-item-field"><strong>Payment:</strong>
            <%= job.currencyPay %>
            <img src="/emblems/<%= settings.currencyIcon || 'manna_symbol.svg' %>" alt="Currency Icon" class="currency-icon">
          </div>
          <% if (job.additionalPay) { %>
            <div class="job-item-field"><strong>Additional Pay:</strong> <%= job.additionalPay %></div>
          <% } %>
          <% if (job.adminLog) { %>
            <div class="job-item-field"><strong>Admin Log:</strong> <%= job.adminLog %></div>
          <% } %>
          <% if (job.emblem) { %>
            <div class="job-item-field">
              <strong>Emblem:</strong> <%= job.emblem %>
              <br>
              <img src="/emblems/<%= job.emblem %>" alt="<%= job.emblem.replace('.svg', '') %>" class="emblem-display">
            </div>
          <% } %>
          <div class="job-item-actions">
            <button class="btn btn-edit" onclick="editJob('<%= job.id %>')">Edit</button>
            <% if (job.state === 'Active') { %>
              <button class="btn btn-primary" onclick="markJobComplete('<%= job.id %>')">Mark Completed</button>
              <button class="btn btn-delete" onclick="markJobFailed('<%= job.id %>')">Mark Failed</button>
            <% } %>
            <button class="btn btn-delete" onclick="deleteJob('<%= job.id %>')">Delete</button>
          </div>
        </div>
      <% }); %>
    </div>
  </div>

  <!-- Notification Footer -->
  <div id="notificationFooter" class="notification-footer"></div>

  <!-- Edit Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Job</h2>
        <span class="close" onclick="closeEditModal()">&times;</span>
      </div>
      <form id="editJobForm">
        <input type="hidden" id="editJobId">
        <div class="form-group">
          <label for="editJobName">Job Name</label>
          <input type="text" id="editJobName" name="name" required>
        </div>
        
        <div class="form-group">
          <label for="editJobRank">Job Rank (1-3 stars)</label>
          <select id="editJobRank" name="rank" required>
            <option value="1">1 Star</option>
            <option value="2">2 Stars</option>
            <option value="3">3 Stars</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="editJobState">Job State</label>
          <select id="editJobState" name="state" required>
            <% jobStates.forEach(state => { %>
              <option value="<%= state %>"><%= state %></option>
            <% }); %>
          </select>
        </div>
        
        <div class="form-group">
          <label for="editJobFaction">Faction (Optional)</label>
          <select id="editJobFaction" name="factionId">
            <option value="">None</option>
            <% factions.forEach(faction => { %>
              <option value="<%= faction.id %>"><%= faction.title %></option>
            <% }); %>
          </select>
        </div>
        
        <div class="form-group">
          <label for="editJobType">Job Type</label>
          <input type="text" id="editJobType" name="jobType" required>
        </div>
        
        <div class="form-group">
          <label for="editJobDescription">Objective</label>
          <textarea id="editJobDescription" name="description" required></textarea>
        </div>
        
        <div class="form-group">
          <label for="editJobClientBrief">Client Brief</label>
          <textarea id="editJobClientBrief" name="clientBrief" required></textarea>
        </div>
        
        <div class="form-group">
          <label for="editJobCurrencyPay" class="currency-label">
            Currency Pay (e.g., 100m)
            <img src="/emblems/<%= settings.currencyIcon || 'manna_symbol.svg' %>" alt="Currency Icon" class="currency-icon">
          </label>
          <input type="text" id="editJobCurrencyPay" name="currencyPay" required>
        </div>

        <div class="form-group">
          <label for="editJobAdditionalPay">Additional Pay</label>
          <input type="text" id="editJobAdditionalPay" name="additionalPay">
        </div>

        <div class="form-group">
          <label for="editJobAdminLog">Admin Log</label>
          <textarea id="editJobAdminLog" name="adminLog" rows="3" placeholder="GM-only notes for this job"></textarea>
        </div>

        <div class="form-group">
          <label for="editJobEmblem">Emblem</label>
          <input type="hidden" id="editJobEmblem" name="emblem" value="">
          <div class="emblem-grid" id="editEmblemGrid">
            <div class="emblem-option none" data-emblem="">
              [None]
            </div>
            <% emblems.forEach(emblem => { %>
              <div class="emblem-option" data-emblem="<%= emblem %>" title="<%= formatEmblemTitle(emblem) %>">
                <img src="/emblems/<%= emblem %>" alt="<%= formatEmblemTitle(emblem) %>">
              </div>
            <% }); %>
          </div>
        </div>
        
        <button type="submit" class="btn btn-primary">Save Changes</button>
      </form>
    </div>
  </div>

  
  </div>

  <!-- Base Tab -->
  <div id="base-tab" class="tab-content">
    <div class="settings-section">
      <h2>Base Facility Configuration</h2>
      <p style="color: #b0b0b0; margin-bottom: 20px;">Configure base facilities (3 Core, 6 Major, 6 Minor slots). Manage facility purchases, upgrades, and slot assignments.</p>
      
      <!-- Facility Cost Modifier Section -->
      <div class="form-group" style="margin-bottom: 30px; max-width: 500px;">
        <label for="facilityCostModifier">Facility Cost Modifier</label>
        <p style="color: #999; font-size: 12px; margin: 5px 0 10px 0;">Prices are tuned for 4 players. Recommended to add or take 20% for each extra or missing player respectively.</p>
        <div style="display: flex; align-items: center; gap: 10px;">
          <input type="number" 
                 id="facilityCostModifier" 
                 name="facilityCostModifier" 
                 value="<%= settings.facilityCostModifier || 0 %>" 
                 min="-100" 
                 max="300" 
                 step="5"
                 style="width: 100px;">
          <span style="color: #e0e0e0;">%</span>
          <button type="button" class="btn" onclick="updateFacilityCostModifier()" style="margin-left: 10px;">Update Modifier</button>
        </div>
      </div>
      
      <!-- Core Facilities Section -->
      <h3 style="color: #e0e0e0; margin-bottom: 15px;">Core Facilities (3)</h3>
      <div class="facility-grid">
        <% coreMajorFacilities.slice(0, 3).forEach((facility, index) => { %>
          <div class="facility-card" data-facility-index="<%= index %>">
            <div class="facility-header">
              <h4><%= facility.facilityName %></h4>
              <label class="purchased-toggle">
                <input type="checkbox" 
                       <%= facility.isPurchased ? 'checked' : '' %> 
                       disabled
                       title="Core facilities are always purchased">
                <span>Purchased</span>
              </label>
            </div>
            <p class="facility-description"><%= facility.facilityDescription %></p>
            
            <% if (facility.upgrades && facility.upgrades.length > 0) { %>
              <div class="upgrades-section">
                <h5>Upgrades</h5>
                <% facility.upgrades.forEach((upgrade, upgradeIndex) => { %>
                  <div class="upgrade-item">
                    <div class="upgrade-info">
                      <strong><%= upgrade.upgradeName %></strong>
                      <span class="upgrade-price"><%= upgrade.upgradePrice %><img src="/emblems/<%= settings.currencyIcon || 'manna_symbol.svg' %>" alt="Currency Icon" class="currency-icon"></span>
                    </div>
                    <p class="upgrade-description"><%= upgrade.upgradeDescription %></p>
                    <div class="upgrade-count">
                      <label>Purchased:</label>
                      <input type="number" 
                             class="upgrade-count-input"
                             value="<%= upgrade.upgradeCount %>"
                             min="0"
                             max="<%= upgrade.maxPurchases %>"
                             data-facility-index="<%= index %>"
                             data-upgrade-index="<%= upgradeIndex %>"
                             onchange="updateUpgradeCount(this)">
                      <span>/ <%= upgrade.maxPurchases %></span>
                    </div>
                  </div>
                <% }); %>
              </div>
            <% } %>
          </div>
        <% }); %>
      </div>
      
      <!-- Major Facilities Section -->
      <h3 style="color: #e0e0e0; margin: 20px 0 15px;">Major Facilities (6)</h3>
      <div class="facility-grid">
        <% coreMajorFacilities.slice(3, 9).forEach((facility, localIndex) => { 
           const index = localIndex + 3;
        %>
          <div class="facility-card" data-facility-index="<%= index %>">
            <div class="facility-header">
              <h4><%= facility.facilityName %></h4>
              <label class="purchased-toggle">
                <input type="checkbox" 
                       <%= facility.isPurchased ? 'checked' : '' %>
                       data-facility-index="<%= index %>"
                       onchange="toggleFacilityPurchased(this)">
                <span>Purchased</span>
              </label>
            </div>
            <div class="facility-price">Price: <%= facility.facilityPrice %><img src="/emblems/<%= settings.currencyIcon || 'manna_symbol.svg' %>" alt="Currency Icon" class="currency-icon"></div>
            <p class="facility-description"><%= facility.facilityDescription %></p>
            
            <% if (facility.upgrades && facility.upgrades.length > 0) { %>
              <div class="upgrades-section">
                <h5>Upgrades</h5>
                <% facility.upgrades.forEach((upgrade, upgradeIndex) => { %>
                  <div class="upgrade-item">
                    <div class="upgrade-info">
                      <strong><%= upgrade.upgradeName %></strong>
                      <span class="upgrade-price"><%= upgrade.upgradePrice %><img src="/emblems/<%= settings.currencyIcon || 'manna_symbol.svg' %>" alt="Currency Icon" class="currency-icon"></span>
                    </div>
                    <p class="upgrade-description"><%= upgrade.upgradeDescription %></p>
                    <div class="upgrade-count">
                      <label>Purchased:</label>
                      <input type="number" 
                             class="upgrade-count-input"
                             value="<%= upgrade.upgradeCount %>"
                             min="0"
                             max="<%= upgrade.maxPurchases %>"
                             data-facility-index="<%= index %>"
                             data-upgrade-index="<%= upgradeIndex %>"
                             onchange="updateUpgradeCount(this)">
                      <span>/ <%= upgrade.maxPurchases %></span>
                    </div>
                  </div>
                <% }); %>
              </div>
            <% } %>
          </div>
        <% }); %>
      </div>
      
      <!-- Minor Facilities Section -->
      <h3 style="color: #e0e0e0; margin: 20px 0 15px;">Minor Facility Slots (6)</h3>
      <p style="color: #b0b0b0; margin-bottom: 15px;">Last 2 slots can be enabled/disabled. Click "Assign" to select from available minor facilities.</p>
      <div class="facility-grid">
        <% minorFacilitiesSlots.slots.forEach((slot, slotIndex) => { %>
          <div class="facility-card minor-slot <%= !slot.enabled ? 'disabled-facility' : '' %>" data-slot-number="<%= slot.slotNumber %>">
            <div class="facility-header">
              <h4>Minor Slot <%= slot.slotNumber %></h4>
              <% if (slotIndex >= 4) { %>
                <label class="enabled-toggle">
                  <input type="checkbox" 
                         <%= slot.enabled ? 'checked' : '' %>
                         data-slot-number="<%= slot.slotNumber %>"
                         onchange="toggleMinorSlotEnabled(this)">
                  <span>Enabled</span>
                </label>
              <% } %>
            </div>
            
            <% if (slot.enabled) { %>
              <% if (slot.facilityName) { %>
                <div class="assigned-facility">
                  <h5><%= slot.facilityName %></h5>
                  <p class="facility-description"><%= slot.facilityDescription %></p>
                  <button class="btn btn-delete btn-sm" onclick="clearMinorSlot(<%= slot.slotNumber %>)">Clear Slot</button>
                </div>
              <% } else { %>
                <div class="empty-slot">
                  <p style="color: #888; text-align: center; padding: 20px;">No facility assigned</p>
                  <button class="btn btn-primary btn-sm" onclick="openMinorFacilityAssignModal(<%= slot.slotNumber %>)">Assign Facility</button>
                </div>
              <% } %>
            <% } else { %>
              <p style="color: #666; text-align: center; padding: 20px;">This slot is disabled</p>
            <% } %>
          </div>
        <% }); %>
      </div>
    </div>
  </div>

  <!-- Pilots Tab -->
  <div id="pilots-tab" class="tab-content">
    <div class="add-job-section">
      <h2>Add New Pilot</h2>
      <form id="addPilotForm">
        <div class="form-group">
          <label for="pilotName">Name</label>
          <input type="text" id="pilotName" name="name" required>
        </div>
        
        <div class="form-group">
          <label for="pilotCallsign">Callsign</label>
          <input type="text" id="pilotCallsign" name="callsign" required>
        </div>
        
        <div class="form-group">
          <label for="pilotLL">License Level (0-12)</label>
          <input type="number" id="pilotLL" name="ll" min="0" max="12" value="0" required>
        </div>
        
        <div class="form-group">
          <label for="pilotNotes">Notes (multiline)</label>
          <textarea id="pilotNotes" name="notes" rows="4" placeholder="Optional"></textarea>
        </div>

        <div class="form-group">
          <label for="pilotAdminLog">Admin Log</label>
          <textarea id="pilotAdminLog" name="adminLog" rows="3" placeholder="GM-only notes for this pilot"></textarea>
        </div>

        <div class="form-group" id="addPilotPersonalOperationProgressGroup" style="display: <%= settings.openTable ? 'block' : 'none' %>">
          <label for="pilotPersonalOperationProgress">Personal Operation Progress</label>
          <select id="pilotPersonalOperationProgress" name="personalOperationProgress">
            <option value="0" selected>0</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
          </select>
        </div>
        
        <div class="form-group">
          <label style="display: block; cursor: pointer;">
            <span style="display: inline; margin-right: 8px;">Active:</span>
            <input type="checkbox" id="pilotActive" name="active" value="true" checked style="width: auto;">
          </label>
        </div>
        
        <button type="submit" class="btn btn-primary btn-add-job">Add Pilot</button>
      </form>
    </div>

    <div class="jobs-list">
      <h2>Existing Pilots</h2>
      
      <!-- Progress Operation Button (only visible when openTable is ON) -->
      <div id="progressOperationButtonContainer" style="margin-bottom: 20px; display: <%= settings.openTable ? 'block' : 'none' %>;">
        <button class="btn btn-neutral" onclick="showProgressOperationModal()" style="font-size: 14px; padding: 10px 20px;">
          Progress Operation Track for Active Pilots
        </button>
      </div>
      
      <div id="pilotsList">
        <% if (pilots.length === 0) { %>
          <p style="color: #b0b0b0;">No pilots created yet.</p>
        <% } else { %>
          <% pilots.forEach(pilot => { %>
            <div class="job-item" data-id="<%= pilot.id %>">
              <h3><%= pilot.name %> ("<%= pilot.callsign %>") <% if (pilot.active) { %><span class="state-badge state-badge-active">ACTIVE</span><% } else { %><span class="state-badge state-badge-ignored">INACTIVE</span><% } %></h3>
              <div class="job-item-field"><strong>License Level:</strong> <%= pilot.ll %></div>
              <div class="job-item-field">
                <strong>Balance:</strong> 
                <span class="pilot-balance" data-pilot-id="<%= pilot.id %>"><%= pilot.balance || 0 %></span>
                <img src="/emblems/<%= settings.currencyIcon || 'manna_symbol.svg' %>" alt="Currency Icon" class="currency-icon">
              </div>
              <% if (pilot.notes) { %>
                <div class="job-item-field"><strong>Notes:</strong><br><pre style="margin: 5px 0; font-family: inherit; white-space: pre-wrap;"><%= pilot.notes %></pre></div>
              <% } %>
              <% if (pilot.adminLog) { %>
                <div class="job-item-field"><strong>Admin Log:</strong> <%= pilot.adminLog %></div>
              <% } %>
              <div class="job-item-field">
                <strong>Related Jobs:</strong> <%= (pilot.relatedJobs || []).length %> job(s)
              </div>
              <div class="job-item-field pilot-personal-operation-progress-display" style="display: <%= settings.openTable ? 'block' : 'none' %>">
                <strong>Personal Operation Progress:</strong> <%= pilot.personalOperationProgress ?? 0 %>
              </div>
              <div class="job-item-actions">
                <button class="btn btn-edit" onclick="editPilot('<%= pilot.id %>')">Edit</button>
                <button class="btn btn-neutral" onclick="openPilotRelatedJobsModal('<%= pilot.id %>')">Related Jobs</button>
                <button class="btn btn-neutral" onclick="openPilotBalanceHistoryModal('<%= pilot.id %>')">Balance History</button>
                <button class="btn btn-neutral" onclick="openPilotReservesModal('<%= pilot.id %>')">Edit Reserves</button>
                <button class="btn btn-delete" onclick="deletePilot('<%= pilot.id %>')">Delete</button>
              </div>
            </div>
          <% }); %>
        <% } %>
      </div>
    </div>
  </div>

  <!-- Factions Tab -->
  <div id="factions-tab" class="tab-content">
    <div class="add-job-section">
      <h2>Add New Faction</h2>
      <form id="addFactionForm">
        <div class="form-group">
          <label for="factionTitle">Faction Title</label>
          <input type="text" id="factionTitle" name="title" required>
        </div>
        
        <div class="form-group">
          <label for="factionBrief">Brief</label>
          <textarea id="factionBrief" name="brief" required></textarea>
        </div>
        
        <div class="form-group">
          <label for="factionStanding">Standing</label>
          <select id="factionStanding" name="standing" required>
            <option value="0">0 - Distrusted</option>
            <option value="1">1 - Wary</option>
            <option value="2" selected>2 - Neutral</option>
            <option value="3">3 - Respected</option>
            <option value="4">4 - Trusted</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="factionJobsCompletedOffset">Jobs Completed Offset (This number is added to the completed jobs count)</label>
          <input type="number" id="factionJobsCompletedOffset" name="jobsCompletedOffset" value="0" required>
        </div>
        
        <div class="form-group">
          <label for="factionJobsFailedOffset">Jobs Failed Offset (This number is added to the failed jobs count)</label>
          <input type="number" id="factionJobsFailedOffset" name="jobsFailedOffset" value="0" required>
        </div>

        <div class="form-group">
          <label for="factionAdminLog">Admin Log</label>
          <textarea id="factionAdminLog" name="adminLog" rows="3" placeholder="GM-only notes for this faction"></textarea>
        </div>

        <div class="form-group">
          <label for="factionEmblem">Emblem</label>
          <input type="hidden" id="factionEmblem" name="emblem" value="">
          <div class="emblem-grid" id="factionEmblemGrid">
            <div class="emblem-option none" data-emblem="">
              [None]
            </div>
            <% emblems.forEach(emblem => { %>
              <div class="emblem-option" data-emblem="<%= emblem %>" title="<%= formatEmblemTitle(emblem) %>">
                <img src="/emblems/<%= emblem %>" alt="<%= formatEmblemTitle(emblem) %>">
              </div>
            <% }); %>
          </div>
        </div>

        <button type="submit" class="btn btn-primary btn-add-job">Add Faction</button>
      </form>
    </div>

    <div class="jobs-list">
      <h2>Existing Factions</h2>
      <div id="factionsList">
        <% if (factions.length === 0) { %>
          <p style="color: #b0b0b0;">No factions created yet.</p>
        <% } else { %>
          <% factions.forEach(faction => { 
            const standingLabels = ['Distrusted', 'Wary', 'Neutral', 'Respected', 'Trusted'];
          %>
            <div class="faction-item" data-id="<%= faction.id %>">
              <h3><%= faction.title %></h3>
              <div class="faction-item-field"><strong>Standing:</strong> <%= standingLabels[faction.standing] || 'Unknown' %></div>
              <div class="faction-item-field"><strong>Jobs Completed:</strong> <%= faction.jobsCompleted || 0 %> (Offset: <%= faction.jobsCompletedOffset || 0 %>)</div>
              <div class="faction-item-field"><strong>Jobs Failed:</strong> <%= faction.jobsFailed || 0 %> (Offset: <%= faction.jobsFailedOffset || 0 %>)</div>
              <div class="faction-item-field"><strong>Brief:</strong> <%= faction.brief %></div>
              <% if (faction.adminLog) { %>
              <div class="faction-item-field"><strong>Admin Log:</strong> <%= faction.adminLog %></div>
              <% } %>
              <% if (faction.emblem) { %>
                <div class="faction-item-field">
                  <strong>Emblem:</strong> <%= faction.emblem %>
                  <br>
                  <img src="/emblems/<%= faction.emblem %>" alt="<%= faction.emblem.replace('.svg', '') %>" class="emblem-display">
                </div>
              <% } %>
              <div class="faction-item-actions">
                <button class="btn btn-edit" onclick="editFaction('<%= faction.id %>')">Edit</button>
                <button class="btn btn-neutral" onclick="openFactionRelatedJobsModal('<%= faction.id %>')">Related Jobs</button>
                <button class="btn btn-delete" onclick="deleteFaction('<%= faction.id %>')">Delete</button>
              </div>
            </div>
          <% }); %>
        <% } %>
      </div>
    </div>
  </div>

  <!-- Edit Faction Modal -->
  <div id="editFactionModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Faction</h2>
        <span class="close" onclick="closeEditFactionModal()">&times;</span>
      </div>
      <form id="editFactionForm">
        <input type="hidden" id="editFactionId">
        <div class="form-group">
          <label for="editFactionTitle">Faction Title</label>
          <input type="text" id="editFactionTitle" name="title" required>
        </div>
        
        <div class="form-group">
          <label for="editFactionBrief">Brief</label>
          <textarea id="editFactionBrief" name="brief" required></textarea>
        </div>
        
        <div class="form-group">
          <label for="editFactionStanding">Standing</label>
          <select id="editFactionStanding" name="standing" required>
            <option value="0">0 - Distrusted</option>
            <option value="1">1 - Wary</option>
            <option value="2">2 - Neutral</option>
            <option value="3">3 - Respected</option>
            <option value="4">4 - Trusted</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="editFactionJobsCompletedOffset">Jobs Completed Offset (calculated from jobs + this offset)</label>
          <input type="number" id="editFactionJobsCompletedOffset" name="jobsCompletedOffset" required>
        </div>
        
        <div class="form-group">
          <label for="editFactionJobsFailedOffset">Jobs Failed Offset (calculated from jobs + this offset)</label>
          <input type="number" id="editFactionJobsFailedOffset" name="jobsFailedOffset" required>
        </div>

        <div class="form-group">
          <label for="editFactionAdminLog">Admin Log</label>
          <textarea id="editFactionAdminLog" name="adminLog" rows="3" placeholder="GM-only notes for this faction"></textarea>
        </div>

        <div class="form-group">
          <label for="editFactionEmblem">Emblem</label>
          <input type="hidden" id="editFactionEmblem" name="emblem" value="">
          <div class="emblem-grid" id="editFactionEmblemGrid">
            <div class="emblem-option none" data-emblem="">
              [None]
            </div>
            <% emblems.forEach(emblem => { %>
              <div class="emblem-option" data-emblem="<%= emblem %>" title="<%= formatEmblemTitle(emblem) %>">
                <img src="/emblems/<%= emblem %>" alt="<%= formatEmblemTitle(emblem) %>">
              </div>
            <% }); %>
          </div>
        </div>
        
        <button type="submit" class="btn btn-primary">Save Changes</button>
      </form>
    </div>
  </div>
  
  <!-- Edit Transaction Modal -->
  <div id="editTransactionModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Transaction</h2>
        <span class="close" onclick="closeEditTransactionModal()">&times;</span>
      </div>
      <form id="editTransactionForm">
        <input type="hidden" id="editTransactionId">
        <div class="form-group">
          <label for="editTransactionDate">Date</label>
          <input type="datetime-local" id="editTransactionDate" name="date" required>
        </div>
        
        <div class="form-group">
          <label for="editTransactionAmount">Amount (+ or -)</label>
          <input type="number" id="editTransactionAmount" name="amount" required>
        </div>
        
        <div class="form-group">
          <label for="editTransactionDescription">Description</label>
          <input type="text" id="editTransactionDescription" name="description" required>
        </div>
        
        <p style="color: #b0b0b0; margin: 10px 0;">
          <em>Note: Editing transactions does not affect pilot associations. Use the "Select Pilot(s)" button to change pilot assignments.</em>
        </p>
        
        <button type="submit" class="btn btn-primary">Save Changes</button>
      </form>
    </div>
  </div>
  
  <!-- Pilot Selection Modal -->
  <div id="pilotSelectionModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Select Pilot(s)</h2>
        <span class="close" onclick="closePilotSelectionModal()">&times;</span>
      </div>
      <div id="pilotSelectionList" style="max-height: 400px; overflow-y: auto;">
        <% if (pilots.length === 0) { %>
          <p style="color: #b0b0b0;">No pilots available.</p>
        <% } else { %>
          <% pilots.sort((a, b) => {
            if (a.active !== b.active) return b.active ? 1 : -1;
            return a.name.localeCompare(b.name);
          }).forEach(pilot => { %>
            <div style="margin-bottom: 10px; padding: 10px; background-color: <%= pilot.active ? '#1a1a1a' : '#2a2a2a' %>; border-radius: 3px;">
              <label style="display: flex; align-items: center; cursor: pointer; color: <%= pilot.active ? '#e0e0e0' : '#888' %>;">
                <input type="checkbox" class="pilot-checkbox" value="<%= pilot.id %>" style="margin-right: 10px; width: auto;">
                <span><%= pilot.name %> (<%= pilot.callsign %>)<%= pilot.active ? '' : ' - Inactive' %></span>
              </label>
            </div>
          <% }); %>
        <% } %>
      </div>
      <div style="margin-top: 20px;">
        <button type="button" class="btn btn-primary" onclick="confirmPilotSelection()">Confirm Selection</button>
        <button type="button" class="btn btn-neutral" onclick="closePilotSelectionModal()">Cancel</button>
      </div>
    </div>
  </div>
  
  <!-- Edit Pilot Modal -->
  <div id="editPilotModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Pilot</h2>
        <span class="close" onclick="closeEditPilotModal()">&times;</span>
      </div>
      <form id="editPilotForm">
        <input type="hidden" id="editPilotId">
        <div class="form-group">
          <label for="editPilotName">Name</label>
          <input type="text" id="editPilotName" name="name" required>
        </div>
        
        <div class="form-group">
          <label for="editPilotCallsign">Callsign</label>
          <input type="text" id="editPilotCallsign" name="callsign" required>
        </div>
        
        <div class="form-group">
          <label for="editPilotLL">License Level (0-12)</label>
          <input type="number" id="editPilotLL" name="ll" min="0" max="12" required>
        </div>
        
        <div class="form-group">
          <label for="editPilotNotes">Notes (multiline)</label>
          <textarea id="editPilotNotes" name="notes" rows="4"></textarea>
        </div>

        <div class="form-group">
          <label for="editPilotAdminLog">Admin Log</label>
          <textarea id="editPilotAdminLog" name="adminLog" placeholder="GM Only notes for this pilot" rows="4"></textarea>
        </div>
        
        <div class="form-group" id="editPilotPersonalOperationProgressGroup" style="display: <%= settings.openTable ? 'block' : 'none' %>">
          <label for="editPilotPersonalOperationProgress">Personal Operation Progress</label>
          <select id="editPilotPersonalOperationProgress" name="personalOperationProgress">
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
          </select>
        </div>
        
        <div class="form-group">
          <label style="display: block; cursor: pointer;">
            <span style="display: inline; margin-right: 8px;">Active:</span>
            <input type="checkbox" id="editPilotActive" name="active" value="true" style="width: auto;">
          </label>
        </div>
        
        <button type="submit" class="btn btn-primary">Save Changes</button>
      </form>
    </div>
  </div>
  
  <!-- Pilot Related Jobs Modal -->
  <div id="pilotRelatedJobsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Pilot Related Jobs</h2>
        <span class="close" onclick="closePilotRelatedJobsModal()">&times;</span>
      </div>
      <input type="hidden" id="pilotRelatedJobsPilotId">
      <p style="color: #b0b0b0; margin-bottom: 15px;">Select jobs to associate with this pilot (non-Pending jobs only):</p>
      <div id="pilotRelatedJobsList" style="max-height: 400px; overflow-y: auto; border: 1px solid #444; padding: 15px; border-radius: 3px; background-color: #1a1a1a;">
        <!-- Populated dynamically -->
      </div>
      <div style="margin-top: 15px;">
        <button class="btn btn-primary" onclick="savePilotRelatedJobs()">Save Related Jobs</button>
      </div>
    </div>
  </div>
  
  <!-- Pilot Balance History Modal -->
  <div id="pilotBalanceHistoryModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Pilot Balance History</h2>
        <span class="close" onclick="closePilotBalanceHistoryModal()">&times;</span>
      </div>
      <input type="hidden" id="pilotBalanceHistoryPilotId">
      <div style="margin-bottom: 15px;">
        <div class="job-item-field">
          <strong>Current Balance:</strong> 
          <span id="pilotBalanceHistoryTotal">0</span>
          <img src="/emblems/<%= settings.currencyIcon || 'manna_symbol.svg' %>" alt="Currency Icon" class="currency-icon">
        </div>
      </div>
      <p style="color: #b0b0b0; margin-bottom: 15px;">Uncheck transactions to disassociate them from this pilot. The transaction will remain in the system.</p>
      <div id="pilotBalanceHistoryList" style="max-height: 400px; overflow-y: auto; border: 1px solid #444; padding: 15px; border-radius: 3px; background-color: #1a1a1a;">
        <!-- Populated dynamically -->
      </div>
      <div style="margin-top: 15px;">
        <button class="btn btn-primary" onclick="savePilotBalanceHistory()">Save Changes</button>
      </div>
    </div>
  </div>
  
  <!-- Pilot Reserves Modal -->
  <div id="pilotReservesModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Pilot Reserves</h2>
        <span class="close" onclick="closePilotReservesModal()">&times;</span>
      </div>
      <input type="hidden" id="pilotReservesModalPilotId">
      <p style="color: #b0b0b0; margin-bottom: 15px;">Manage reserves owned by this pilot. Click cards to select/deselect.</p>
      
      <!-- Reserve Action Buttons -->
      <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
        <button class="btn btn-neutral" onclick="setSelectedReservesStatus('In Reserve')" id="setInReserveBtn" disabled>Set to In Reserve</button>
        <button class="btn btn-neutral" onclick="setSelectedReservesStatus('Deployed')" id="setDeployedBtn" disabled>Set to Deployed</button>
        <button class="btn btn-neutral" onclick="setSelectedReservesStatus('Expended')" id="setExpendedBtn" disabled>Set to Expended</button>
        <button class="btn btn-delete" onclick="removeSelectedReservesFromPilot()" id="removeReservesBtn" disabled>Remove Reserve</button>
        <button class="btn btn-primary" onclick="openAddReservesToPilotModal()">Add Reserve</button>
      </div>
      
      <!-- Pilot Reserves Grid -->
      <div id="pilotReservesGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; min-height: 100px; max-height: 500px; overflow-y: auto; border: 1px solid #444; padding: 15px; border-radius: 3px; background-color: #1a1a1a;">
        <!-- Populated dynamically -->
      </div>
    </div>
  </div>
  
  <!-- Add Reserves to Pilot Modal (Sub-modal) -->
  <div id="addReservesToPilotModal" class="modal">
    <div class="modal-content" style="max-width: 1200px;">
      <div class="modal-header">
        <h2>Add Reserves to Pilot</h2>
        <span class="close" onclick="closeAddReservesToPilotModal()">&times;</span>
      </div>
      <p style="color: #b0b0b0; margin-bottom: 15px;">Select reserves to add to this pilot. Click cards to select/deselect.</p>
      
      <div style="margin-bottom: 15px;">
        <button class="btn btn-primary" onclick="addSelectedStockReservesToPilot()" id="addStockReservesBtn" disabled>Add Selected to Pilot</button>
      </div>
      
      <!-- Filter Pills -->
      <div class="filter-pills" style="margin-bottom: 15px;">
        <button class="filter-pill active" data-rank="all" onclick="filterPilotAddReserves('all', event)" id="pilotAddFilterAll">All</button>
        <button class="filter-pill" data-rank="1" onclick="filterPilotAddReserves('1', event)" id="pilotAddFilterRank1">Rank 1</button>
        <button class="filter-pill" data-rank="2" onclick="filterPilotAddReserves('2', event)" id="pilotAddFilterRank2">Rank 2</button>
        <button class="filter-pill" data-rank="3" onclick="filterPilotAddReserves('3', event)" id="pilotAddFilterRank3">Rank 3</button>
        <button class="filter-pill" data-hide-default="false" onclick="togglePilotAddHideDefault(event)" id="pilotAddHideDefaultPill">Hide Default Reserves</button>
      </div>
      
      <!-- Search Field -->
      <div class="form-group" style="margin-bottom: 15px;">
        <label for="pilotAddReserveSearchInput">Search Reserves</label>
        <input type="text" id="pilotAddReserveSearchInput" placeholder="Search by name..." oninput="searchPilotAddReserves(this.value)" style="max-width: 400px;">
      </div>
      
      <!-- Available Reserves Grid -->
      <div id="addReservesStockGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; min-height: 100px; max-height: 500px; overflow-y: auto; border: 1px solid #444; padding: 15px; border-radius: 3px; background-color: #1a1a1a;">
        <!-- Populated dynamically -->
      </div>
    </div>
  </div>
  
  <!-- Faction Related Jobs Modal -->
  <div id="factionRelatedJobsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Faction Related Jobs</h2>
        <span class="close" onclick="closeFactionRelatedJobsModal()">&times;</span>
      </div>
      <p style="color: #b0b0b0; margin-bottom: 15px;">Jobs related to this faction:</p>
      <div id="factionRelatedJobsList" style="max-height: 400px; overflow-y: auto;">
        <!-- Populated dynamically -->
      </div>
    </div>
  </div>
  
  <!-- Progress All Jobs Confirmation Modal -->
  <div id="progressAllJobsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Confirm: Progress All Jobs</h2>
        <span class="close" onclick="closeProgressAllJobsModal()">&times;</span>
      </div>
      <div style="color: #e0e0e0; line-height: 1.6;">
        <p style="margin-bottom: 15px;">This action will:</p>
        <ul style="margin-left: 20px; margin-bottom: 15px;">
          <li>Set all <strong>"Active"</strong> jobs to <strong>"Ignored"</strong></li>
          <li>Set all <strong>"Pending"</strong> jobs to <strong>"Active"</strong></li>
          <li>Add newly active jobs to all currently <strong>Active Pilots'</strong> related job lists</li>
        </ul>
        
        <h3 style="margin: 20px 0 10px; color: #e0e0e0;">Jobs to be affected:</h3>
        <div id="progressAllJobsList" style="max-height: 50vh; overflow-y: auto; border: 1px solid #444; padding: 15px; border-radius: 3px; background-color: #1a1a1a; margin-bottom: 15px;">
          <!-- Populated dynamically -->
        </div>
        
        <p style="margin-bottom: 20px; color: #f44336; font-weight: bold;">This action cannot be undone.</p>
        <div style="display: flex; gap: 10px;">
          <button class="btn btn-primary" onclick="confirmProgressAllJobs()">Confirm</button>
          <button class="btn btn-neutral" onclick="closeProgressAllJobsModal()">Cancel</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Progress Operation Modal -->
  <div id="progressOperationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Confirm: Progress Operation Track for Active Pilots</h2>
        <span class="close" onclick="closeProgressOperationModal()">&times;</span>
      </div>
      <div style="color: #e0e0e0; line-height: 1.6;">
        <p style="margin-bottom: 15px;">This action will increment <strong>Personal Operation Progress</strong> for the following <strong>Active Pilots</strong>:</p>
        <div id="progressOperationPilotList" style="margin-bottom: 15px; max-height: 50vh; overflow-y: auto; border: 1px solid #555; padding: 10px; background-color: #1a1a1a;">
          <!-- Pilot list will be populated dynamically -->
        </div>
        <p style="margin-bottom: 20px; color: #f44336; font-weight: bold;">This action cannot be undone.</p>
        <div style="display: flex; gap: 10px;">
          <button class="btn btn-primary" onclick="confirmProgressOperation()">Confirm</button>
          <button class="btn btn-neutral" onclick="closeProgressOperationModal()">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Minor Facility Assignment Modal -->
  <div id="minorFacilityAssignModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h2>Assign Minor Facility to Slot <span id="assignModalSlotNumber"></span></h2>
        <span class="close" onclick="closeMinorFacilityAssignModal()">&times;</span>
      </div>
      <p style="color: #b0b0b0; margin-bottom: 15px;">Select a minor facility to assign to this slot. Already assigned facilities are not shown.</p>
      <div id="minorFacilityGrid" class="minor-facility-selection-grid">
        <!-- Populated dynamically -->
      </div>
      <div style="margin-top: 20px;">
        <button class="btn btn-neutral" onclick="closeMinorFacilityAssignModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Store Config Tab -->
  <div id="store-tab" class="tab-content">
    <!-- Resupply Item Settings Section -->
    <div class="settings-section">
      <h2>Resupply Item Settings</h2>
      <p style="color: #b0b0b0; margin-bottom: 20px;">Configure pricing and availability for static resupply items.</p>
      <form id="resupplyItemsForm">
        <% if (storeConfig && storeConfig.resupplyItems) { %>
          <% storeConfig.resupplyItems.forEach((item, index) => { %>
            <div style="border: 1px solid #444; padding: 15px; margin-bottom: 15px; border-radius: 3px; background-color: #1a1a1a;">
              <h3 style="color: #66BB6A; margin-bottom: 10px;"><%= item.name %></h3>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group" style="margin-bottom: 0;">
                  <label for="resupply-<%= index %>-price">Price</label>
                  <input type="number" id="resupply-<%= index %>-price" name="items[<%= index %>][price]" value="<%= item.price %>" min="0" required>
                </div>
                <div class="form-group" style="margin-bottom: 0; display: flex; align-items: center; padding-top: 25px;">
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin: 0;">
                    <input type="checkbox" id="resupply-<%= index %>-enabled" name="items[<%= index %>][enabled]" <%= item.enabled ? 'checked' : '' %> style="width: auto;">
                    <span>Enabled</span>
                  </label>
                </div>
              </div>
              <input type="hidden" name="items[<%= index %>][id]" value="<%= item.id %>">
              <input type="hidden" name="items[<%= index %>][name]" value="<%= item.name %>">
            </div>
          <% }); %>
        <% } %>
        <button type="submit" class="btn btn-primary">Save Resupply Settings</button>
      </form>
    </div>

    <!-- Reserve Stock Management Section -->
    <div class="settings-section">
      <h2>Reserve Stock Management</h2>
      <p style="color: #b0b0b0; margin-bottom: 15px;">Current reserves available for purchase in the store.</p>
      
      <div style="margin-bottom: 15px;">
        <button class="btn btn-delete" id="removeSelectedBtn" onclick="removeSelectedReserves(false)">Remove Selected</button>
        <button class="btn btn-delete" id="removeAllSelectedBtn" onclick="removeSelectedReserves(true)">Remove All Selected</button>
      </div>
      
      <div id="reserveStockGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; min-height: 50px;">
        <% if (!storeConfig || !storeConfig.currentStock || storeConfig.currentStock.length === 0) { %>
          <p style="color: #888; font-style: italic; margin: 20px 0;">No Reserves currently stocked.</p>
        <% } else { %>
          <%
            // Get reserve details from stock IDs and sort by rank then name
            const stockReserves = storeConfig.currentStock
              .map(id => reserves.find(r => r.id === id))
              .filter(r => r !== undefined)
              .sort((a, b) => {
                if (a.rank !== b.rank) return a.rank - b.rank;
                return a.name.localeCompare(b.name);
              });
          %>
          <% stockReserves.forEach(reserve => { %>
            <div class="job-item" style="cursor: pointer; transition: all 0.2s;" onclick="toggleStockReserveSelection(this, '<%= reserve.id %>')" data-reserve-id="<%= reserve.id %>">
              <h3 style="color: #e0e0e0; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" class="stock-reserve-checkbox" value="<%= reserve.id %>" onclick="event.stopPropagation(); toggleStockReserveSelection(this.parentElement.parentElement, '<%= reserve.id %>')" style="width: auto; margin: 0;">
                <span><%= reserve.name %></span>
              </h3>
              <div class="job-item-field"><strong>Rank:</strong> R<%= reserve.rank %></div>
              <div class="job-item-field"><strong>Price:</strong> <%= reserve.price %> <img src="/emblems/<%= settings.currencyIcon || 'manna_symbol.svg' %>" alt="Currency Icon" class="currency-icon"></div>
              <% if (reserve.description) { %>
                <div class="job-item-field"><strong>Description:</strong><br><%= reserve.description %></div>
              <% } %>
              <% if (reserve.adminLog) { %>
                <div class="job-item-field"><strong>Admin Log:</strong> <%= reserve.adminLog %></div>
              <% } %>
            </div>
          <% }); %>
        <% } %>
      </div>
    </div>

    <!-- Available Reserves Section -->
    <div class="settings-section">
      <h2>Available Reserves</h2>
      <p style="color: #b0b0b0; margin-bottom: 15px;">Manage all reserve items. Create, edit, delete, or add to stock.</p>
      
      <!-- Add Random Reserve and Add Selected to Stock Buttons -->
      <div style="margin-bottom: 15px;">
        <button class="btn btn-primary" onclick="addRandomReserve()">Add random Reserve from current view</button>
        <button class="btn btn-neutral" id="addToStockBtn" onclick="addSelectedToStock()" disabled>Add Selected to Stock</button>
      </div>
      
      <!-- CRUD Buttons -->
      <div style="margin-bottom: 20px;">
        <button class="btn btn-primary" onclick="openCreateReserveModal()">Create Reserve</button>
        <button class="btn btn-edit" id="editReserveBtn" onclick="openEditReserveModal()" disabled>Edit Selected</button>
        <button class="btn btn-delete" id="deleteReserveBtn" onclick="deleteSelectedReserve()" disabled>Delete Selected</button>
      </div>
      
      <!-- Filter Pills -->
      <div class="filter-pills" style="margin-bottom: 20px;">
        <button class="filter-pill active" data-rank="all" onclick="filterAvailableReserves('all', event)">All</button>
        <button class="filter-pill" data-rank="1" onclick="filterAvailableReserves('1', event)">Rank 1</button>
        <button class="filter-pill" data-rank="2" onclick="filterAvailableReserves('2', event)">Rank 2</button>
        <button class="filter-pill" data-rank="3" onclick="filterAvailableReserves('3', event)">Rank 3</button>
        <button class="filter-pill" data-hide-default="false" onclick="toggleHideDefaultReserves(event)" id="hideDefaultPill">Hide Default Reserves</button>
      </div>
      
      <!-- Search Field -->
      <div class="form-group" style="margin-bottom: 20px;">
        <label for="reserveSearchInput">Search Reserves</label>
        <input type="text" id="reserveSearchInput" placeholder="Search by name..." oninput="searchAvailableReserves(this.value)" style="max-width: 400px;">
      </div>
      
      <!-- Available Reserves Grid -->
      <div id="availableReservesGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
        <% 
          // Sort reserves by rank then name
          const sortedReserves = [...reserves].sort((a, b) => {
            if (a.rank !== b.rank) return a.rank - b.rank;
            return a.name.localeCompare(b.name);
          });
        %>
        <% sortedReserves.forEach(reserve => { %>
          <div class="job-item available-reserve-card" 
               data-reserve-id="<%= reserve.id %>" 
               data-rank="<%= reserve.rank %>"
               data-is-custom="<%= reserve.isCustom %>"
               style="cursor: pointer; transition: all 0.2s;" 
               onclick="selectAvailableReserve(this, '<%= reserve.id %>')">
            <h3 style="color: #e0e0e0; margin-bottom: 10px;"><%= reserve.name %></h3>
            <div class="job-item-field"><strong>Rank:</strong> R<%= reserve.rank %></div>
            <div class="job-item-field"><strong>Price:</strong> <%= reserve.price %> <img src="/emblems/<%= settings.currencyIcon || 'manna_symbol.svg' %>" alt="Currency Icon" class="currency-icon"></div>
            <% if (reserve.description) { %>
              <div class="job-item-field"><strong>Description:</strong><br><%= reserve.description %></div>
            <% } %>
            <div class="job-item-field"><strong>Type:</strong> <%= reserve.isCustom ? 'Custom' : 'Default' %></div>
            <% if (reserve.adminLog) { %>
              <div class="job-item-field"><strong>Admin Log:</strong><br><%= reserve.adminLog %></div>
            <% } %>
          </div>
        <% }); %>
      </div>
    </div>
  </div>

  <!-- Create Reserve Modal -->
  <div id="createReserveModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Create Reserve</h2>
        <span class="close" onclick="closeCreateReserveModal()">&times;</span>
      </div>
      <form id="createReserveForm">
        <div class="form-group">
          <label for="createReserveRank">Rank (1-3)</label>
          <select id="createReserveRank" name="rank" required>
            <option value="1">Rank 1</option>
            <option value="2">Rank 2</option>
            <option value="3">Rank 3</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="createReserveName">Name</label>
          <input type="text" id="createReserveName" name="name" required>
        </div>
        
        <div class="form-group">
          <label for="createReservePrice">Price</label>
          <input type="number" id="createReservePrice" name="price" min="0" value="0" required>
        </div>
    
        <div class="form-group">
          <label for="createReserveDescription">Description</label>
          <textarea id="createReserveDescription" name="description" rows="4" placeholder="Text before your first [enter] input will be bolded."></textarea>
        </div>

        <div class="form-group">
          <label for="createReserveAdminLog">Admin Log</label>
          <textarea id="createReserveAdminLog" name="adminLog" rows="3" placeholder="GM-only notes for this reserve"></textarea>
        </div>

        <button type="submit" class="btn btn-primary">Create Reserve</button>
      </form>
    </div>
  </div>

  <!-- Edit Reserve Modal -->
  <div id="editReserveModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Reserve</h2>
        <span class="close" onclick="closeEditReserveModal()">&times;</span>
      </div>
      <form id="editReserveForm">
        <input type="hidden" id="editReserveId">
        
        <div class="form-group">
          <label for="editReserveRank">Rank (1-3)</label>
          <select id="editReserveRank" name="rank" required>
            <option value="1">Rank 1</option>
            <option value="2">Rank 2</option>
            <option value="3">Rank 3</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="editReserveName">Name</label>
          <input type="text" id="editReserveName" name="name" required>
        </div>
        
        <div class="form-group">
          <label for="editReservePrice">Price</label>
          <input type="number" id="editReservePrice" name="price" min="0" required>
        </div>
        
        <div class="form-group">
          <label for="editReserveDescription">Description</label>
          <textarea id="editReserveDescription" name="description" rows="4"></textarea>
        </div>

        <div class="form-group">
          <label for="editReserveAdminLog">Admin Log</label>
          <textarea id="editReserveAdminLog" name="adminLog" rows="3" placeholder="GM-only notes for this reserve"></textarea>
        </div>

        <button type="submit" class="btn btn-primary">Save Changes</button>
      </form>
    </div>
  </div>

  <!-- Currency Icon Selection Modal -->
  <div id="currencyIconModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Select Currency Icon</h2>
        <span class="close" onclick="closeCurrencyIconModal()">&times;</span>
      </div>
      <div style="padding: 20px;">
        <p style="color: #b0b0b0; margin-bottom: 15px;">
          Select an SVG icon from the emblem library to use as the currency icon. The selected icon will be used throughout the application.
        </p>
        <div class="emblem-grid" id="currencyIconGrid">
          <% emblems.forEach(emblem => { %>
            <div class="emblem-option" data-emblem="<%= emblem %>" title="<%= formatEmblemTitle(emblem) %>">
              <img src="/emblems/<%= emblem %>" alt="<%= formatEmblemTitle(emblem) %>">
            </div>
          <% }); %>
        </div>
        <div style="margin-top: 20px; text-align: right;">
          <button type="button" class="btn btn-secondary" onclick="closeCurrencyIconModal()">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveCurrencyIcon()">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Vote Config Tab -->
  <div id="vote-tab" class="tab-content">
    <div class="settings-section">
      <h2>Vote Configuration</h2>
      <p style="color: #b0b0b0; margin-bottom: 20px;">
        This section allows the initiation of a voting period on the Job Board for Pilots. 
        The voting period will end when the End Time elapses, or manually by clicking "Conclude Voting".
      </p>
      
      <%
        // ongoingPeriod is provided by the server
        // Archive periods are filtered from votingPeriods
        const archivedPeriods = votingPeriods.filter(p => p.state === 'Archived').reverse();
      %>
      
      <% if (ongoingPeriod) { %>
        <!-- Current Ongoing Vote Section -->
        <div style="margin-bottom: 40px;">
          <h3 style="color: #66BB6A; margin-bottom: 15px;">Current Vote</h3>
          
          <div id="votingPeriodTimeDisplay" style="margin-bottom: 15px; padding: 15px; background-color: #1a1a1a; border-radius: 5px; border: 1px solid #444;">
            <% if (ongoingPeriod.endTime) { %>
              <div style="color: #e0e0e0; margin-bottom: 8px;">
                <strong>Time Remaining:</strong> <span id="timeRemaining">Calculating...</span>
              </div>
              <div style="color: #b0b0b0;">
                <strong>End Time:</strong> <span id="endTime"><%= new Date(ongoingPeriod.endTime).toLocaleString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit', day: '2-digit', month: '2-digit', year: 'numeric' }).replace(/,/, ' -') %></span>
              </div>
            <% } else { %>
              <div style="color: #e0e0e0;">
                <strong>Duration:</strong> Infinite (No end time set)
              </div>
            <% } %>
          </div>
          
          <div style="margin-bottom: 15px;">
            <button class="btn btn-secondary" id="conclude-vote-btn" onclick="concludeVote()">Conclude Vote</button>
            <% if (ongoingPeriod.endTime) { %>
              <button class="btn btn-primary" id="archive-vote-btn" onclick="archiveVote('<%= ongoingPeriod.id %>')" style="display: none;">Archive Voting Results</button>
            <% } else { %>
              <button class="btn btn-primary" onclick="archiveVote('<%= ongoingPeriod.id %>')" disabled style="opacity: 0.5; cursor: not-allowed;" title="Cannot archive until voting concludes">Archive Voting Results</button>
            <% } %>
            <button class="btn btn-primary" id="modify-vote-btn" onclick="openModifyVoteModal()">Modify Voting Close</button>
          </div>
          
          <!-- Job List for Ongoing Vote -->
          <div>
            <h4 style="color: #e0e0e0; margin-bottom: 15px;">Jobs in Current Vote</h4>
            <% 
              const ongoingJobVotes = ongoingPeriod.jobVotes || [];
              if (ongoingJobVotes.length === 0) { 
            %>
              <p style="color: #888;">No jobs in this voting period.</p>
            <% } else {
                ongoingJobVotes.forEach(jobVote => {
                  const job = jobs.find(j => j.id === jobVote.jobId);
                  const voteCount = (jobVote.votes || []).length;
                  const votingPilots = (jobVote.votes || []).map(pilotId => {
                    const pilot = pilots.find(p => p.id === pilotId);
                    return pilot ? pilot.callsign : 'DELETED PILOT';
                  });
            %>
              <div style="margin-bottom: 15px; padding: 15px; border: 1px solid #444; border-radius: 3px; background-color: #1a1a1a;">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                  <% if (job && job.emblem) { %>
                    <img src="/emblems/<%= job.emblem %>" alt="Emblem" style="width: 60px; height: 60px; border: 1px solid #ddd; padding: 5px; background: white; border-radius: 3px; object-fit: contain;">
                  <% } %>
                  <div style="flex: 1;">
                    <h5 style="color: #e0e0e0; margin-bottom: 5px;"><%= job ? job.name : 'JOB DELETED' %></h5>
                    <% if (job) { %>
                      <div style="color: #b0b0b0; font-size: 13px;">
                        <strong>Client:</strong> <%= job.faction ? job.faction.title : 'FIELD_NULL' %> | 
                        <strong>Rank:</strong> 
                        <span class="rank-display" style="font-size: 14px;">
                          <% for(let i = 0; i < job.rank; i++) { %><span class="star">★</span><% } %>
                          <% for(let i = job.rank; i < 3; i++) { %><span class="star">☆</span><% } %>
                        </span> | 
                        <strong>Type:</strong> <%= job.jobType %>
                      </div>
                    <% } %>
                  </div>
                </div>
                <div style="color: #e0e0e0; margin-bottom: 5px;">
                  <strong>Vote Count:</strong> <%= voteCount %>
                </div>
                <div style="color: #b0b0b0;">
                  <strong>Pilots:</strong> <%= votingPilots.length > 0 ? votingPilots.join(', ') : 'None' %>
                </div>
              </div>
            <% 
                });
              }
            %>
          </div>
        </div>
      <% } else { %>
        <!-- Create New Voting Period Section -->
        <div style="margin-bottom: 40px;">
          <h3 style="color: #66BB6A; margin-bottom: 15px;">Start New Voting Period</h3>
          
          <form id="newVotingPeriodForm" style="margin-bottom: 20px;">
            <div class="form-group">
              <label for="votingEndTime">End Time</label>
              <div style="display: flex; align-items: center; gap: 10px;">
                <input type="datetime-local" id="votingEndTime" name="endTime" style="flex: 1; color-scheme: dark;">
                <label style="display: flex; align-items: center; gap: 5px; color: #b0b0b0; cursor: pointer; white-space: nowrap;">
                  <input type="checkbox" id="infiniteDuration" name="infiniteDuration" onchange="toggleEndTime(this)">
                  No end time?
                </label>
              </div>
            </div>
          </form>
          
          <div>
            <h4 style="color: #e0e0e0; margin-bottom: 15px;">Active Jobs</h4>
            <% 
              const activeJobs = jobs.filter(j => j.state === 'Active');
              if (activeJobs.length === 0) {
            %>
              <p style="color: #888;">No Active jobs available to include in voting period.</p>
            <% } else { %>
              <div style="margin-bottom: 15px;">
                <% activeJobs.forEach(job => { %>
                  <div style="margin-bottom: 10px; padding: 12px; border: 1px solid #444; border-radius: 3px; background-color: #1a1a1a;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                      <% if (job.emblem) { %>
                        <img src="/emblems/<%= job.emblem %>" alt="Emblem" style="width: 50px; height: 50px; border: 1px solid #ddd; padding: 5px; background: white; border-radius: 3px; object-fit: contain;">
                      <% } %>
                      <div style="flex: 1;">
                        <h5 style="color: #e0e0e0; margin-bottom: 5px;"><%= job.name %></h5>
                        <div style="color: #b0b0b0; font-size: 13px;">
                          <strong>Client:</strong> <%= job.faction ? job.faction.title : 'FIELD_NULL' %> | 
                          <strong>Rank:</strong> 
                          <span class="rank-display" style="font-size: 14px;">
                            <% for(let i = 0; i < job.rank; i++) { %><span class="star">★</span><% } %>
                            <% for(let i = job.rank; i < 3; i++) { %><span class="star">☆</span><% } %>
                          </span> | 
                          <strong>Type:</strong> <%= job.jobType %>
                        </div>
                      </div>
                    </div>
                  </div>
                <% }); %>
              </div>
              <button type="submit" form="newVotingPeriodForm" class="btn btn-primary" onclick="startVotingPeriod(event)">Start Voting Period</button>
            <% } %>
          </div>
        </div>
      <% } %>
      
      <!-- Vote Archive Section -->
      <div>
        <h3 style="color: #e0e0e0; margin-bottom: 15px;">Vote Archive</h3>
        
        <% if (archivedPeriods.length === 0) { %>
          <p style="color: #888;">No archived voting periods.</p>
        <% } else { %>
          <% archivedPeriods.forEach((period, periodIndex) => { %>
            <div style="margin-bottom: 30px; padding: 20px; border: 1px solid #444; border-radius: 5px; background-color: #1a1a1a;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4 style="color: #b0b0b0; margin: 0;">
                  Archived Vote #<%= archivedPeriods.length - periodIndex %>
                  <% if (period.endTime) { %>
                    - Ended: <%= new Date(period.endTime).toLocaleString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit', day: '2-digit', month: '2-digit', year: 'numeric' }).replace(/,/, ' -') %>
                  <% } else { %>
                    - No End Time Set
                  <% } %>
                </h4>
                <button class="btn btn-delete btn-sm" onclick="deleteVoteLog('<%= period.id %>')">Delete Vote Log</button>
              </div>
              
              <% 
                const archivedJobVotes = period.jobVotes || [];
                if (archivedJobVotes.length === 0) {
              %>
                <p style="color: #888;">No jobs in this voting period.</p>
              <% } else {
                  archivedJobVotes.forEach(jobVote => {
                    const job = jobs.find(j => j.id === jobVote.jobId);
                    const voteCount = (jobVote.votes || []).length;
                    const votingPilots = (jobVote.votes || []).map(pilotId => {
                      const pilot = pilots.find(p => p.id === pilotId);
                      return pilot ? pilot.callsign : 'DELETED PILOT';
                    });
              %>
                <div style="margin-bottom: 10px; padding: 12px; border: 1px solid #333; border-radius: 3px; background-color: #0a0a0a;">
                  <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 8px;">
                    <% if (job && job.emblem) { %>
                      <img src="/emblems/<%= job.emblem %>" alt="Emblem" style="width: 50px; height: 50px; border: 1px solid #ddd; padding: 5px; background: white; border-radius: 3px; object-fit: contain;">
                    <% } %>
                    <div style="flex: 1;">
                      <h5 style="color: #e0e0e0; margin-bottom: 5px;"><%= job ? job.name : 'JOB DELETED' %></h5>
                      <% if (job) { %>
                        <div style="color: #b0b0b0; font-size: 13px;">
                          <strong>Client:</strong> <%= job.faction ? job.faction.title : 'FIELD_NULL' %> | 
                          <strong>Rank:</strong> 
                          <span class="rank-display" style="font-size: 14px;">
                            <% for(let i = 0; i < job.rank; i++) { %><span class="star">★</span><% } %>
                            <% for(let i = job.rank; i < 3; i++) { %><span class="star">☆</span><% } %>
                          </span> | 
                          <strong>Type:</strong> <%= job.jobType %>
                        </div>
                      <% } %>
                    </div>
                  </div>
                  <div style="color: #e0e0e0; margin-bottom: 5px;">
                    <strong>Vote Count:</strong> <%= voteCount %>
                  </div>
                  <div style="color: #b0b0b0;">
                    <strong>Pilots:</strong> <%= votingPilots.length > 0 ? votingPilots.join(', ') : 'None' %>
                  </div>
                </div>
              <% 
                  });
                }
              %>
            </div>
          <% }); %>
        <% } %>
      </div>
    </div>
  </div>

<script src="/js/sse-client.js"></script>
<script>
    // Handle settings update from SSE for admin view
    function handleSettingsUpdate(data) {
      if (!data || !data.settings) {
        return;
      }
      
      const settings = data.settings;
      
      // Update currency icons
      if (settings.currencyIcon) {
        const currencyIcons = document.querySelectorAll('.currency-icon');
        currencyIcons.forEach(icon => {
          if (icon.tagName === 'IMG') {
            icon.src = `/emblems/${settings.currencyIcon}?v=${Date.now()}`;
          }
        });
        
        // Update the preview in the settings form
        const preview = document.getElementById('currentCurrencyIconPreview');
        const name = document.getElementById('currentCurrencyIconName');
        if (preview) {
          preview.src = `/emblems/${settings.currencyIcon}?v=${Date.now()}`;
        }
        if (name) {
          name.textContent = settings.currencyIcon;
        }
        
        // Update the hidden input
        const input = document.getElementById('settingsCurrencyIcon');
        if (input) {
          input.value = settings.currencyIcon;
        }
      }
      
      // Update openTable state and toggle Personal Operation Progress fields
      if (settings.openTable !== undefined) {
        // Toggle "Add New Pilot" form Personal Operation Progress field
        const addPilotProgressGroup = document.getElementById('addPilotPersonalOperationProgressGroup');
        if (addPilotProgressGroup) {
          addPilotProgressGroup.style.display = settings.openTable ? 'block' : 'none';
        }
        
        // Toggle Personal Operation Progress display in existing pilots list
        const existingPilotProgressFields = document.querySelectorAll('.pilot-personal-operation-progress-display');
        existingPilotProgressFields.forEach(field => {
          field.style.display = settings.openTable ? 'block' : 'none';
        });
        
        // Toggle "Edit Pilot" modal Personal Operation Progress field
        const editPilotProgressGroup = document.getElementById('editPilotPersonalOperationProgressGroup');
        if (editPilotProgressGroup) {
          editPilotProgressGroup.style.display = settings.openTable ? 'block' : 'none';
        }
        
        // Toggle "Progress Operation for Active Pilots" button
        const progressOperationButtonContainer = document.getElementById('progressOperationButtonContainer');
        if (progressOperationButtonContainer) {
          progressOperationButtonContainer.style.display = settings.openTable ? 'block' : 'none';
        }
      }
    }

    // Handle pilots update from SSE for admin view
    function handlePilotsUpdate(data) {
      if (!data || !data.pilots) {
        return;
      }
      
      // Check if the pilot reserves modal is currently open
      const pilotReservesModal = document.getElementById('pilotReservesModal');
      if (pilotReservesModal && pilotReservesModal.style.display === 'block') {
        // Get the current pilot ID from the modal
        const pilotId = document.getElementById('pilotReservesModalPilotId').value;
        if (pilotId) {
          // Refresh the modal with updated data
          openPilotReservesModal(pilotId);
        }
      }
    }

    // Handle manna update from SSE for admin view
    function handleMannaUpdate(data) {
      if (!data || !data.manna) {
        return;
      }
      
      const manna = data.manna;
      const balances = data.balances || { activeBalance: 0, totalBalance: 0 };
      
      // Update balance displays
      const activeBalance = document.getElementById('activeBalance');
      if (activeBalance) {
        activeBalance.textContent = balances.activeBalance;
      }
      
      const totalBalance = document.getElementById('totalBalance');
      if (totalBalance) {
        totalBalance.textContent = balances.totalBalance;
      }
      
      // Update transaction list
      const transactionsList = document.getElementById('transactionsList');
      if (transactionsList && manna.transactions) {
        if (manna.transactions.length === 0) {
          transactionsList.innerHTML = '<p style="color: #b0b0b0;">No transactions yet.</p>';
        } else {
          // Fetch pilots to build the pilot-transaction map
          fetch('/api/pilots')
            .then(res => res.json())
            .then(pilots => {
              const pilotTransactionMap = {};
              pilots.forEach(pilot => {
                if (pilot.personalTransactions && Array.isArray(pilot.personalTransactions)) {
                  pilot.personalTransactions.forEach(txnId => {
                    if (!pilotTransactionMap[txnId]) {
                      pilotTransactionMap[txnId] = [];
                    }
                    pilotTransactionMap[txnId].push(pilot);
                  });
                }
              });
              
              const reversedTransactions = manna.transactions.slice().reverse();
              const currentFilter = document.querySelector('.filter-pill.active')?.getAttribute('data-filter') || 'all';
              
              transactionsList.innerHTML = reversedTransactions.map(transaction => {
                const date = new Date(transaction.date);
                const formattedDate = date.toLocaleString('en-GB', { dateStyle: 'short', timeStyle: 'short' });
                const amountColor = transaction.amount >= 0 ? '#66BB6A' : '#f44336';
                const amountPrefix = transaction.amount >= 0 ? '+' : '';
                
                const assignedPilots = pilotTransactionMap[transaction.id] || [];
                const isAssigned = assignedPilots.length > 0;
                
                // Apply filter
                let displayStyle = '';
                if (currentFilter === 'assigned' && !isAssigned) {
                  displayStyle = ' style="display: none;"';
                } else if (currentFilter === 'unassigned' && isAssigned) {
                  displayStyle = ' style="display: none;"';
                }
                
                const assignedText = isAssigned 
                  ? `<span style="color: #66BB6A;">${assignedPilots.map(p => p.callsign).join(', ')}</span>`
                  : '<span style="color: #888;">Unassigned</span>';
                
                return `
                  <div class="transaction-item" data-id="${transaction.id}" data-assigned="${isAssigned ? 'true' : 'false'}"${displayStyle}>
                    <div class="transaction-item-field">
                      <strong>Date:</strong> ${formattedDate}
                    </div>
                    <div class="transaction-item-field">
                      <strong>Amount:</strong> 
                      <span style="color: ${amountColor}">
                        ${amountPrefix}${transaction.amount}
                      </span>
                      <img src="/emblems/<%= settings.currencyIcon || 'manna_symbol.svg' %>" alt="Currency Icon" class="currency-icon">
                    </div>
                    <div class="transaction-item-field">
                      <strong>Description:</strong> ${transaction.description}
                    </div>
                    <div class="transaction-item-field">
                      <strong>Assigned to:</strong> ${assignedText}
                    </div>
                    <div class="transaction-item-actions">
                      <button class="btn btn-secondary" onclick="editTransactionPilots('${transaction.id}')">Select Pilot(s)</button>
                      <button class="btn btn-edit" onclick="editTransaction('${transaction.id}')">Edit</button>
                      <button class="btn btn-delete" onclick="deleteTransaction('${transaction.id}')">Delete</button>
                    </div>
                  </div>
                `;
              }).join('');
            })
            .catch(err => {
              console.error('Error fetching pilots for transaction update:', err);
            });
        }
      }
    }
    
    // Handle voting periods update from SSE for admin view
    function handleVotingPeriodsUpdate(data) {
      // Reload the page to show updated voting data
      // This ensures vote counts and all voting period data are current
      location.reload();
    }
  </script>
<script>
    // ==================== VOTING PERIOD MANAGEMENT ====================
    
    // Serialize ongoing period once for reuse
    const ongoingPeriod = <%- JSON.stringify(ongoingPeriod) %>;
    
    // Toggle end time input based on infinite duration checkbox
    function toggleEndTime(checkbox) {
      const endTimeInput = document.getElementById('votingEndTime');
      endTimeInput.disabled = checkbox.checked;
      if (checkbox.checked) {
        endTimeInput.value = '';
      }
    }
    
    // Start a new voting period
    async function startVotingPeriod(event) {
      event.preventDefault();
      
      const infiniteDuration = document.getElementById('infiniteDuration').checked;
      const endTimeInput = document.getElementById('votingEndTime').value;
      
      // Validate end time if not infinite
      if (!infiniteDuration && !endTimeInput) {
        alert('Please select an end time or check "No end time?"');
        return;
      }
      
      // Get all active job IDs
      const activeJobs = <%- JSON.stringify(activeJobIds) %>;
      
      if (activeJobs.length === 0) {
        alert('No Active jobs available to start a voting period');
        return;
      }
      
      // Create job votes structure
      const jobVotes = activeJobs.map(jobId => ({
        jobId: jobId,
        votes: []
      }));
      
      // Create voting period object
      const votingPeriod = {
        state: 'Ongoing',
        jobVotes: jobVotes,
        endTime: infiniteDuration ? null : new Date(endTimeInput).toISOString()
      };
      
      try {
        const response = await fetch('/api/voting-periods', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(votingPeriod)
        });
        
        if (response.ok) {
          showNotification('Voting period started successfully!');
          saveScrollPositionForReload();
          setTimeout(() => location.reload(), 400);
        } else {
          const errorData = await response.json();
          alert(errorData.message || 'Failed to start voting period');
        }
      } catch (error) {
        console.error('Error starting voting period:', error);
        alert('Error starting voting period');
      }
    }
    
    // Conclude vote (set end time to 5 seconds in the past)
    async function concludeVote() {
      if (!confirm('Are you sure you want to conclude the voting period?')) {
        return;
      }
      
      if (!ongoingPeriod) {
        alert('No ongoing voting period found');
        return;
      }
      
      // Set end time to 5 seconds in the past
      const fiveSecondsAgo = new Date(Date.now() - 5000).toISOString();
      
      try {
        const response = await fetch(`/api/voting-periods/${ongoingPeriod.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ...ongoingPeriod,
            endTime: fiveSecondsAgo
          })
        });
        
        if (response.ok) {
          showNotification('Voting period concluded');
          saveScrollPositionForReload();
          setTimeout(() => location.reload(), 400);
        } else {
          const errorData = await response.json();
          alert(errorData.message || 'Failed to conclude voting period');
        }
      } catch (error) {
        console.error('Error concluding voting period:', error);
        alert('Error concluding voting period');
      }
    }
    
    // Archive voting period
    async function archiveVote(periodId) {
      if (!confirm('Are you sure you want to archive this voting period?')) {
        return;
      }
      
      if (!ongoingPeriod || ongoingPeriod.id !== periodId) {
        alert('Voting period not found or not ongoing');
        return;
      }
      
      try {
        const response = await fetch(`/api/voting-periods/${periodId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ...ongoingPeriod,
            state: 'Archived'
          })
        });
        
        if (response.ok) {
          showNotification('Voting period archived');
          saveScrollPositionForReload();
          setTimeout(() => location.reload(), 400);
        } else {
          const errorData = await response.json();
          alert(errorData.message || 'Failed to archive voting period');
        }
      } catch (error) {
        console.error('Error archiving voting period:', error);
        alert('Error archiving voting period');
      }
    }
    
    // Delete vote log
    async function deleteVoteLog(periodId) {
      if (!confirm('Are you sure you want to delete this vote log? This action cannot be undone.')) {
        return;
      }
      
      try {
        const response = await fetch(`/api/voting-periods/${periodId}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          showNotification('Vote log deleted');
          saveScrollPositionForReload();
          setTimeout(() => location.reload(), 400);
        } else {
          const errorData = await response.json();
          alert(errorData.message || 'Failed to delete vote log');
        }
      } catch (error) {
        console.error('Error deleting vote log:', error);
        alert('Error deleting vote log');
      }
    }
    
    // Open modify vote modal
    // Open modify vote modal
    function openModifyVoteModal() {
      if (!ongoingPeriod) {
        alert('No ongoing voting period found');
        return;
      }
      
      const modal = document.getElementById('modify-vote-modal');
      const endTimeInput = document.getElementById('modify-vote-end-time');
      const infiniteCheckbox = document.getElementById('modify-vote-infinite-duration');
      
      // Set current end time in the input or check infinite
      if (ongoingPeriod.endTime) {
        const currentEndTime = new Date(ongoingPeriod.endTime);
        const year = currentEndTime.getFullYear();
        const month = String(currentEndTime.getMonth() + 1).padStart(2, '0');
        const day = String(currentEndTime.getDate()).padStart(2, '0');
        const hours = String(currentEndTime.getHours()).padStart(2, '0');
        const minutes = String(currentEndTime.getMinutes()).padStart(2, '0');
        
        endTimeInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
        endTimeInput.disabled = false;
        infiniteCheckbox.checked = false;
      } else {
        endTimeInput.value = '';
        endTimeInput.disabled = true;
        infiniteCheckbox.checked = true;
      }
      
      modal.style.display = 'block';
    }
    
    // Toggle end time input in modify modal
    function toggleModifyEndTime(checkbox) {
      const endTimeInput = document.getElementById('modify-vote-end-time');
      endTimeInput.disabled = checkbox.checked;
      if (checkbox.checked) {
        endTimeInput.value = '';
      }
    }
    
    // Close modify vote modal
    function closeModifyVoteModal() {
      const modal = document.getElementById('modify-vote-modal');
      modal.style.display = 'none';
    }
    
    // Modify voting close time
    async function modifyVotingClose() {
      if (!ongoingPeriod) {
        alert('No ongoing voting period found');
        return;
      }
      
      const endTimeInput = document.getElementById('modify-vote-end-time').value;
      const infiniteCheckbox = document.getElementById('modify-vote-infinite-duration').checked;
      
      let newEndTime = null;
      
      if (!infiniteCheckbox) {
        if (!endTimeInput) {
          alert('Please select an end time or check "No end time?"');
          return;
        }
        newEndTime = new Date(endTimeInput).toISOString();
      }
      
      try {
        const response = await fetch(`/api/voting-periods/${ongoingPeriod.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ...ongoingPeriod,
            endTime: newEndTime
          })
        });
        
        if (response.ok) {
          showNotification('Voting close time updated');
          saveScrollPositionForReload();
          setTimeout(() => location.reload(), 400);
        } else {
          const errorData = await response.json();
          alert(errorData.message || 'Failed to update voting close time');
        }
      } catch (error) {
        console.error('Error updating voting close time:', error);
        alert('Error updating voting close time');
      }
    }
    
    // Update time remaining display (for ongoing vote)
    function updateTimeRemaining() {
      const timeRemainingEl = document.getElementById('timeRemaining');
      const endTimeEl = document.getElementById('endTime');
      const archiveBtn = document.getElementById('archive-vote-btn');
      const concludeBtn = document.getElementById('conclude-vote-btn');
      const modifyBtn = document.getElementById('modify-vote-btn');
      
      if (!timeRemainingEl || !endTimeEl) {
        return;
      }
      
      if (!ongoingPeriod || !ongoingPeriod.endTime) {
        return;
      }
      
      const endTime = new Date(ongoingPeriod.endTime);
      const now = new Date();
      const diff = endTime - now;
      
      if (diff <= 0) {
        timeRemainingEl.textContent = 'Voting Concluded';
        timeRemainingEl.style.color = '#f44336';
        // Show archive button and hide conclude button when voting has concluded
        // Keep modify button visible to allow extending voting period
        if (archiveBtn) {
          archiveBtn.style.display = 'inline-block';
        }
        if (concludeBtn) {
          concludeBtn.style.display = 'none';
        }
        // Modify button stays visible
        return;
      }
      
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((diff % (1000 * 60)) / 1000);
      
      const hoursStr = String(hours).padStart(2, '0');
      const minutesStr = String(minutes).padStart(2, '0');
      const secondsStr = String(seconds).padStart(2, '0');
      
      timeRemainingEl.textContent = `${hoursStr}:${minutesStr}:${secondsStr} (${hours} hours)`;
    }
    
    // Initialize time remaining update on page load (if on vote tab with ongoing period)
    document.addEventListener('DOMContentLoaded', function() {
      if (ongoingPeriod && ongoingPeriod.endTime) {
        // Update immediately
        updateTimeRemaining();
        
        // Update every second
        setInterval(updateTimeRemaining, 1000);
      }
    });
    
  </script>
<script>
    // Tab switching
    function switchTab(tabName, eventOrButton) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Remove active class from all buttons
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected tab
      document.getElementById(tabName + '-tab').classList.add('active');
      
      // Set button as active
      // If eventOrButton has a target property, it's an event object
      // Otherwise it's a button element directly
      let button;
      if (eventOrButton && typeof eventOrButton === 'object' && 'target' in eventOrButton) {
        button = eventOrButton.target;
      } else if (eventOrButton) {
        button = eventOrButton;
      }
      
      if (button) {
        button.classList.add('active');
      }
      
      // Update URL hash to persist tab state across page reloads
      window.location.hash = tabName;
    }
    
    // Toggle minor module enable/disable
    // ==================== FACILITY MANAGEMENT ====================
    
    // Toggle facility purchased status (Major facilities only)
    async function toggleFacilityPurchased(checkbox) {
      const facilityIndex = parseInt(checkbox.dataset.facilityIndex);
      const isPurchased = checkbox.checked;
      
      try {
        const response = await fetch(`/api/facilities/core-major/${facilityIndex}/purchased`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ isPurchased })
        });
        
        if (!response.ok) {
          alert('Failed to update facility purchase status');
          checkbox.checked = !isPurchased; // Revert
        }
      } catch (error) {
        console.error('Error updating facility purchase status:', error);
        alert('Error updating facility purchase status');
        checkbox.checked = !isPurchased; // Revert
      }
    }
    
    // Update facility cost modifier
    async function updateFacilityCostModifier() {
      const input = document.getElementById('facilityCostModifier');
      const modifier = parseFloat(input.value);
      
      // Validate modifier
      if (isNaN(modifier) || modifier < -100 || modifier > 300) {
        alert('Facility Cost Modifier must be between -100 and 300');
        return;
      }
      
      try {
        // Get current settings first
        const settingsResponse = await fetch('/api/settings');
        const currentSettings = await settingsResponse.json();
        
        // Update with new modifier
        const updatedSettings = {
          ...currentSettings,
          facilityCostModifier: modifier
        };
        
        const response = await fetch('/api/settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updatedSettings)
        });
        
        if (response.ok) {
          alert('Facility Cost Modifier updated successfully');
          // Refresh the displayed prices
          updateDisplayedPrices(modifier);
        } else {
          const data = await response.json();
          alert(`Failed to update modifier: ${data.message || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('Error updating facility cost modifier:', error);
        alert('Error updating facility cost modifier');
      }
    }
    
    /**
     * Apply facility cost modifier to a price and round to nearest 50
     */
    function applyFacilityCostModifier(basePrice, modifier) {
      const price = Number(basePrice);
      if (Number.isNaN(price) || price < 0) {
        return 0;
      }
      
      const mod = Number(modifier);
      if (Number.isNaN(mod)) {
        return Math.round(price / 50) * 50;
      }
      
      const clampedModifier = Math.max(-100, Math.min(300, mod));
      const modifiedPrice = price * (1 + clampedModifier / 100);
      return Math.round(modifiedPrice / 50) * 50;
    }
    
    /**
     * Update all displayed prices based on the current modifier
     */
    function updateDisplayedPrices(modifier) {
      // Update all upgrade prices
      document.querySelectorAll('.upgrade-price').forEach(priceEl => {
        const basePriceStr = priceEl.getAttribute('data-base-price');
        if (basePriceStr) {
          const basePrice = parseInt(basePriceStr);
          const modifiedPrice = applyFacilityCostModifier(basePrice, modifier);
          // Update the text content, keeping the currency icon
          const iconHtml = priceEl.querySelector('.currency-icon') ? priceEl.querySelector('.currency-icon').outerHTML : '';
          priceEl.innerHTML = modifiedPrice + iconHtml;
        }
      });
      
      // Update all facility prices
      document.querySelectorAll('.facility-price').forEach(priceEl => {
        const basePriceStr = priceEl.getAttribute('data-base-price');
        if (basePriceStr) {
          const basePrice = parseInt(basePriceStr);
          const modifiedPrice = applyFacilityCostModifier(basePrice, modifier);
          // Update the text content, keeping the "Price: " label and currency icon
          const iconHtml = priceEl.querySelector('.currency-icon') ? priceEl.querySelector('.currency-icon').outerHTML : '';
          priceEl.innerHTML = 'Price: ' + modifiedPrice + iconHtml;
        }
      });
    }
    
    // Initialize prices with current modifier on page load
    document.addEventListener('DOMContentLoaded', () => {
      /**
       * Ensure all price elements under the given root have a data-base-price
       * attribute. If not already set, derive it from the text content by
       * stripping non-digit characters. This is more robust against currency
       * symbols, commas, and additional formatting than a simple regex match.
       * 
       * NOTE: Only handles positive integer prices. Negative prices and decimals
       * are not supported by the facility system.
       */
      const initializeBasePriceAttributes = (root) => {
        if (!root) return;
        
        const upgradePrices = root.querySelectorAll
          ? root.querySelectorAll('.upgrade-price')
          : [];
        upgradePrices.forEach(priceEl => {
          if (priceEl.dataset && priceEl.dataset.basePrice) {
            return;
          }
          const text = priceEl.textContent ? priceEl.textContent.trim() : '';
          const numeric = text.replace(/[^\d]/g, ''); // Remove all non-digits (currency symbols, commas, etc.)
          if (numeric) {
            priceEl.setAttribute('data-base-price', numeric);
          }
        });
        
        const facilityPrices = root.querySelectorAll
          ? root.querySelectorAll('.facility-price')
          : [];
        facilityPrices.forEach(priceEl => {
          if (priceEl.dataset && priceEl.dataset.basePrice) {
            return;
          }
          const text = priceEl.textContent ? priceEl.textContent.trim() : '';
          const numeric = text.replace(/[^\d]/g, ''); // Remove all non-digits (currency symbols, commas, etc.)
          if (numeric) {
            priceEl.setAttribute('data-base-price', numeric);
          }
        });
      };

      const modifierInput = document.getElementById('facilityCostModifier');
      if (modifierInput) {
        const currentModifier = parseFloat(modifierInput.value) || 0;

        // Store base prices as data attributes for all existing price elements
        initializeBasePriceAttributes(document);
        
        // Apply modifier to displayed prices
        if (currentModifier !== 0) {
          updateDisplayedPrices(currentModifier);
        }

        // Observe dynamically added elements and initialize their base prices
        // Note: Observer is not disconnected as it needs to run for the lifetime of the page
        if (window.MutationObserver && document.body) {
          const observer = new MutationObserver(mutations => {
            mutations.forEach(mutation => {
              mutation.addedNodes.forEach(node => {
                if (node.nodeType === Node.ELEMENT_NODE) {
                  initializeBasePriceAttributes(node);
                  // Apply current modifier to newly added elements
                  // Read current modifier from input element to ensure we use the latest value
                  const currentMod = parseFloat(modifierInput.value) || 0;
                  if (currentMod !== 0) {
                    const upgradePrices = node.querySelectorAll ? node.querySelectorAll('.upgrade-price') : [];
                    const facilityPrices = node.querySelectorAll ? node.querySelectorAll('.facility-price') : [];
                    [...upgradePrices, ...facilityPrices].forEach(priceEl => {
                      const basePrice = parseInt(priceEl.dataset.basePrice, 10); // Explicitly use base-10 parsing
                      if (!isNaN(basePrice)) {
                        const modifiedPrice = applyFacilityCostModifier(basePrice, currentMod);
                        const iconHtml = priceEl.querySelector('.currency-icon') ? priceEl.querySelector('.currency-icon').outerHTML : '';
                        priceEl.innerHTML = 'Price: ' + modifiedPrice + iconHtml;
                      }
                    });
                  }
                }
              });
            });
          });
          observer.observe(document.body, { childList: true, subtree: true });
        }
      }
    });
    
    // Update upgrade count
    async function updateUpgradeCount(input) {
      const facilityIndex = parseInt(input.dataset.facilityIndex);
      const upgradeIndex = parseInt(input.dataset.upgradeIndex);
      const upgradeCount = parseInt(input.value);
      const maxPurchases = parseInt(input.max);
      
      // Validate count
      if (upgradeCount < 0 || upgradeCount > maxPurchases) {
        alert(`Upgrade count must be between 0 and ${maxPurchases}`);
        input.value = Math.max(0, Math.min(upgradeCount, maxPurchases));
        return;
      }
      
      try {
        const response = await fetch(`/api/facilities/core-major/${facilityIndex}/upgrades/${upgradeIndex}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ upgradeCount })
        });
        
        if (!response.ok) {
          alert('Failed to update upgrade count');
          // Reload to get correct value
          location.reload();
        }
      } catch (error) {
        console.error('Error updating upgrade count:', error);
        alert('Error updating upgrade count');
        location.reload();
      }
    }
    
    // Toggle minor slot enabled status
    async function toggleMinorSlotEnabled(checkbox) {
      const slotNumber = parseInt(checkbox.dataset.slotNumber);
      const enabled = checkbox.checked;
      
      try {
        const response = await fetch(`/api/facilities/minor-slots/${slotNumber}/toggle-enabled`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enabled })
        });
        
        if (!response.ok) {
          alert('Failed to toggle slot enabled status');
          checkbox.checked = !enabled; // Revert
        }
      } catch (error) {
        console.error('Error toggling slot enabled status:', error);
        alert('Error toggling slot enabled status');
        checkbox.checked = !enabled; // Revert
      }
    }
    
    // Open minor facility assignment modal
    function openMinorFacilityAssignModal(slotNumber) {
      const modal = document.getElementById('minorFacilityAssignModal');
      const slotNumberSpan = document.getElementById('assignModalSlotNumber');
      const grid = document.getElementById('minorFacilityGrid');
      
      slotNumberSpan.textContent = slotNumber;
      
      // Fetch current minor slots to determine which facilities are already assigned
      fetch('/api/facilities/minor-slots')
        .then(res => res.json())
        .then(minorData => {
          // Get list of already assigned facility names (excluding the current slot)
          const assignedNames = minorData.slots
            .filter(slot => slot.slotNumber !== slotNumber && slot.facilityName)
            .map(slot => slot.facilityName);
          
          // Fetch available minor facility options
          return fetch('/api/facilities/minor-options')
            .then(res => res.json())
            .then(options => {
              // Filter out already assigned facilities
              const availableOptions = options.filter(opt => !assignedNames.includes(opt.minorFacilityName));
              
              // Populate grid
              grid.innerHTML = '';
              availableOptions.forEach(option => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'minor-facility-option';
                optionDiv.innerHTML = `
                  <h4>${option.minorFacilityName}</h4>
                  <div class="facility-price">Price: ${option.minorFacilityPrice}<img src="/emblems/<%= settings.currencyIcon || 'manna_symbol.svg' %>" alt="Currency Icon" class="currency-icon"></div>
                  <p>${option.minorFacilityDescription}</p>
                `;
                optionDiv.onclick = () => assignMinorFacility(slotNumber, option);
                grid.appendChild(optionDiv);
              });
              
              if (availableOptions.length === 0) {
                grid.innerHTML = '<p style="color: #888; text-align: center; padding: 40px;">No available facilities to assign</p>';
              }
            });
        })
        .catch(error => {
          console.error('Error loading minor facility options:', error);
          alert('Error loading minor facility options');
        });
      
      modal.style.display = 'block';
    }
    
    // Close minor facility assignment modal
    function closeMinorFacilityAssignModal() {
      const modal = document.getElementById('minorFacilityAssignModal');
      modal.style.display = 'none';
    }
    
    // Assign minor facility to slot
    async function assignMinorFacility(slotNumber, facilityOption) {
      try {
        const response = await fetch(`/api/facilities/minor-slots/${slotNumber}/assign`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            facilityName: facilityOption.minorFacilityName,
            facilityDescription: facilityOption.minorFacilityDescription
          })
        });
        
        if (response.ok) {
          closeMinorFacilityAssignModal();
          // UI will update via SSE
        } else {
          alert('Failed to assign facility');
        }
      } catch (error) {
        console.error('Error assigning facility:', error);
        alert('Error assigning facility');
      }
    }
    
    // Clear minor facility slot
    async function clearMinorSlot(slotNumber) {
      if (!confirm('Are you sure you want to clear this facility slot?')) {
        return;
      }
      
      try {
        const response = await fetch(`/api/facilities/minor-slots/${slotNumber}/clear`, {
          method: 'DELETE'
        });
        
        if (!response.ok) {
          alert('Failed to clear facility slot');
        }
        // UI will update via SSE
      } catch (error) {
        console.error('Error clearing facility slot:', error);
        alert('Error clearing facility slot');
      }
    }
    
    // SSE handler for Core/Major Facilities updates
    function handleFacilitiesCoreMajorUpdate(data) {
      if (!data || !data.facilities) {
        return;
      }
      
      // Only reload if we're on the Base Config tab
      const baseTab = document.getElementById('base-tab');
      if (!baseTab || baseTab.style.display === 'none') {
        return;
      }
      
      // Reload the page to refresh facility data
      // In a production app, you'd update the DOM directly, but for simplicity we reload
      location.reload();
    }
    
    // SSE handler for Minor Facilities Slots updates
    function handleFacilitiesMinorSlotsUpdate(data) {
      if (!data || !data.minorFacilities) {
        return;
      }
      
      // Only reload if we're on the Base Config tab
      const baseTab = document.getElementById('base-tab');
      if (!baseTab || baseTab.style.display === 'none') {
        return;
      }
      
      // Reload the page to refresh facility data
      // In a production app, you'd update the DOM directly, but for simplicity we reload
      location.reload();
    }
    
    // Helper function to format emblem filename for display
    function formatEmblemTitle(filename) {
      return filename.replace('.svg', '').replace(/_/g, ' ');
    }

    // Settings form submission
    document.getElementById('settingsForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      
      // Client-side date validation
      const datePattern = /^\d{2}\/\d{2}\/\d{4}$/;
      if (data.unt && !datePattern.test(data.unt)) {
        alert('Invalid date format. Please use DD/MM/YYYY');
        return;
      }
      
      if (data.unt && datePattern.test(data.unt)) {
        const [day, month, year] = data.unt.split('/').map(Number);
        if (month < 1 || month > 12 || day < 1) {
          alert('Invalid date values. Day must be at least 1, month must be 1-12');
          return;
        }
        
        // Check days per month
        const daysInMonth = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
        // Check for leap year
        const isLeapYear = (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
        if (month === 2 && isLeapYear) {
          daysInMonth[1] = 29;
        }
        
        if (day > daysInMonth[month - 1]) {
          alert(`Invalid day for month ${month}. Maximum is ${daysInMonth[month - 1]} days.`);
          return;
        }
      }
      
      try {
        const response = await fetch('/api/settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        if (response.ok) {
          // Visual feedback on button
          const btn = document.querySelector('button[type="submit"]');
          const originalText = btn.textContent;
          btn.textContent = '✓ Saved!';
          btn.style.backgroundColor = '#28a745';
          setTimeout(() => {
            btn.textContent = originalText;
            btn.style.backgroundColor = '';
          }, 2000);
        } else {
          const errorData = await response.json();
          alert(errorData.message || 'Failed to save settings');
        }
      } catch (error) {
        alert('Error saving settings');
      }
    });

    // Emblem selection handling
    function setupEmblemGrid(gridId, inputId) {
      const grid = document.getElementById(gridId);
      const input = document.getElementById(inputId);
      
      grid.addEventListener('click', (e) => {
        const option = e.target.closest('.emblem-option');
        if (!option) {
          e.stopPropagation();
          return;
        }
        
        // Remove selected class from all options in this grid
        grid.querySelectorAll('.emblem-option').forEach(opt => opt.classList.remove('selected'));
        
        // Add selected class to clicked option
        option.classList.add('selected');
        
        // Update hidden input
        input.value = option.getAttribute('data-emblem');
      });
    }
    
    // Initialize emblem grids
    setupEmblemGrid('emblemGrid', 'jobEmblem');
    setupEmblemGrid('editEmblemGrid', 'editJobEmblem');
    setupEmblemGrid('factionEmblemGrid', 'factionEmblem');
    setupEmblemGrid('editFactionEmblemGrid', 'editFactionEmblem');
    setupEmblemGrid('currencyIconGrid', 'settingsCurrencyIcon');
    
    // Currency Icon Modal Functions
    function openCurrencyIconModal() {
      const modal = document.getElementById('currencyIconModal');
      const grid = document.getElementById('currencyIconGrid');
      const currentIcon = document.getElementById('settingsCurrencyIcon').value;
      
      // Select the current icon in the grid
      grid.querySelectorAll('.emblem-option').forEach(opt => opt.classList.remove('selected'));
      const currentOption = Array.from(grid.querySelectorAll('.emblem-option'))
        .find(opt => opt.getAttribute('data-emblem') === currentIcon);
      if (currentOption) {
        currentOption.classList.add('selected');
      }
      
      modal.style.display = 'block';
    }
    
    function closeCurrencyIconModal() {
      const modal = document.getElementById('currencyIconModal');
      modal.style.display = 'none';
    }
    
    async function saveCurrencyIcon() {
      const selectedIcon = document.getElementById('settingsCurrencyIcon').value;
      
      if (!selectedIcon) {
        alert('Please select a currency icon');
        return;
      }
      
      // Update the preview in the settings form
      const preview = document.getElementById('currentCurrencyIconPreview');
      const name = document.getElementById('currentCurrencyIconName');
      preview.src = `/emblems/${selectedIcon}?v=${Date.now()}`;
      name.textContent = selectedIcon;
      
      // Close the modal
      closeCurrencyIconModal();
      
      showNotification('Currency icon updated in form. Click "Save Settings" to apply.');
    }
    
    // Flag to prevent auto-selection during programmatic job edit form population
    let isPopulatingJobEditForm = false;
    
    // Auto-select emblem when faction is selected
    function autoSelectEmblemForFaction(factionSelectId, emblemGridId, emblemInputId) {
      const factionSelect = document.getElementById(factionSelectId);
      const emblemGrid = document.getElementById(emblemGridId);
      const emblemInput = document.getElementById(emblemInputId);
      const factionsList = <%- JSON.stringify(factions) %>;
      
      if (!factionSelect || !emblemGrid || !emblemInput) return;
      
      factionSelect.addEventListener('change', function() {
        // Skip auto-selection if we're programmatically populating the job edit form
        if (isPopulatingJobEditForm) {
          return;
        }
        
        const selectedFactionId = this.value;
        
        // If no faction selected, don't change the emblem
        if (!selectedFactionId || selectedFactionId === '') {
          return;
        }
        
        // Find the selected faction
        const selectedFaction = factionsList.find(f => f.id === selectedFactionId);
        
        if (selectedFaction && selectedFaction.emblem) {
          // Find and select the matching emblem in the grid
          const matchingEmblemOption = Array.from(emblemGrid.querySelectorAll('.emblem-option'))
            .find(opt => opt.getAttribute('data-emblem') === selectedFaction.emblem);
          
          if (matchingEmblemOption) {
            // Remove selected class from all options
            emblemGrid.querySelectorAll('.emblem-option').forEach(opt => opt.classList.remove('selected'));
            
            // Select the matching emblem
            matchingEmblemOption.classList.add('selected');
            emblemInput.value = selectedFaction.emblem;
          }
        }
      });
    }
    
    // Setup auto-selection for both add and edit job forms
    autoSelectEmblemForFaction('jobFaction', 'emblemGrid', 'jobEmblem');
    autoSelectEmblemForFaction('editJobFaction', 'editEmblemGrid', 'editJobEmblem');
    
    // Store notification timeout ID
    let notificationTimeoutId = null;

    // Show notification
    function showNotification(message) {
      const notification = document.getElementById('notificationFooter');
      
      // Clear any existing timeout to prevent race conditions
      if (notificationTimeoutId) {
        clearTimeout(notificationTimeoutId);
      }
      
      // Remove the class first to reset the transition
      notification.classList.remove('show');
      notification.textContent = message;
      
      // Force a reflow to ensure the transition works
      void notification.offsetWidth;
      
      // Add the class to trigger the transition
      notification.classList.add('show');
      
      notificationTimeoutId = setTimeout(() => {
        notification.classList.remove('show');
        notificationTimeoutId = null;
      }, 3000);
    }

    function upsertEmblemOption(gridEl, emblemFilename) {
      const options = Array.from(gridEl.querySelectorAll('.emblem-option'));
      let option = options.find(o => o.getAttribute('data-emblem') === emblemFilename);

      const title = formatEmblemTitle(emblemFilename);
      const src = `/emblems/${encodeURIComponent(emblemFilename)}?v=${Date.now()}`;

      if (!option) {
        option = document.createElement('div');
        option.className = 'emblem-option';
        option.setAttribute('data-emblem', emblemFilename);
        option.title = title;

        const img = document.createElement('img');
        img.alt = title;
        img.src = src;
        option.appendChild(img);

        gridEl.appendChild(option);
      } else {
        option.title = title;
        const img = option.querySelector('img');
        if (img) img.src = src;
      }

      return option;
    }

    document.getElementById('fileInput').addEventListener('change', async function () {
      if (!this.files || this.files.length === 0) return;

      const filePayload = new FormData();
      filePayload.append('myFile', this.files[0]);

      try {
        const response = await fetch('/upload', {
          method: 'POST',
          body: filePayload
        });

        let data;
        try {
          data = await response.json();
        } catch (jsonError) {
          console.error('Failed to parse JSON response:', jsonError);
          alert('Server returned an invalid response. Please try again or contact support.');
          return;
        }
        if (!response.ok) {
          alert((data && data.message) || 'Upload failed');
          return;
        }

        const emblem = data.emblem;
        const addGrid = document.getElementById('emblemGrid');
        const editGrid = document.getElementById('editEmblemGrid');
        const currencyGrid = document.getElementById('currencyIconGrid');
        const factionGrid = document.getElementById('factionEmblemGrid');
        const editFactionGrid = document.getElementById('editFactionEmblemGrid');

        const addOption = upsertEmblemOption(addGrid, emblem);
        upsertEmblemOption(editGrid, emblem);
        upsertEmblemOption(currencyGrid, emblem);
        upsertEmblemOption(factionGrid, emblem);
        upsertEmblemOption(editFactionGrid, emblem);

        addGrid.querySelectorAll('.emblem-option').forEach(o => o.classList.remove('selected'));
        addOption.classList.add('selected');
        document.getElementById('jobEmblem').value = emblem;

        showNotification(`Emblem uploaded: ${emblem}`);
      } catch (error) {
        alert('Network error during upload: ' + error.message);
      } finally {
        this.value = '';
      }
    });

    // Add job
    document.getElementById('addJobForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      
      try {
        const response = await fetch('/api/jobs', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        if (response.ok) {
          showNotification('Job added successfully!');
          saveScrollPositionForReload();
          setTimeout(() => location.reload(), 400);
        }
      } catch (error) {
        alert('Error adding job');
      }
    });

    // Edit job
    function editJob(id) {
      const jobItem = document.querySelector(`.job-item[data-id="${id}"]`);
      const jobData = <%- JSON.stringify(jobs) %>.find(j => j.id === id);
      const defaultJobState = '<%= defaultJobState %>';
      
      // Set flag to prevent auto-selection during form population
      isPopulatingJobEditForm = true;
      
      document.getElementById('editJobId').value = jobData.id;
      document.getElementById('editJobName').value = jobData.name;
      document.getElementById('editJobRank').value = jobData.rank;
      document.getElementById('editJobState').value = jobData.state || defaultJobState;
      document.getElementById('editJobFaction').value = jobData.factionId || '';
      document.getElementById('editJobType').value = jobData.jobType;
      document.getElementById('editJobDescription').value = jobData.description;
      document.getElementById('editJobClientBrief').value = jobData.clientBrief;
      document.getElementById('editJobCurrencyPay').value = jobData.currencyPay;
      document.getElementById('editJobAdditionalPay').value = jobData.additionalPay || '';
      document.getElementById('editJobAdminLog').value = jobData.adminLog || '';
      document.getElementById('editJobEmblem').value = jobData.emblem || '';
      
      // Select the correct emblem in the grid
      const editGrid = document.getElementById('editEmblemGrid');
      editGrid.querySelectorAll('.emblem-option').forEach(opt => opt.classList.remove('selected'));
      const selectedEmblem = Array.from(editGrid.querySelectorAll('.emblem-option')).find(opt => opt.getAttribute('data-emblem') === (jobData.emblem || ''));
      if (selectedEmblem) {
        selectedEmblem.classList.add('selected');
      }
      
      // Clear flag after form is populated
      isPopulatingJobEditForm = false;
      
      document.getElementById('editModal').style.display = 'block';
    }

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
    }

    document.getElementById('editJobForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      const id = document.getElementById('editJobId').value;
      
      try {
        const response = await fetch(`/api/jobs/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        if (response.ok) {
          showNotification('Changes successfully saved');
          closeEditModal();
          saveScrollPositionForReload();
          setTimeout(() => location.reload(), 400);
        } else {
          let errorMsg = 'Failed to update job';
          try {
            const errorData = await response.json();
            if (errorData && errorData.message) {
              errorMsg += ': ' + errorData.message;
            }
          } catch (e) {
            // ignore JSON parse errors
          }
          showNotification(errorMsg);
        }
      } catch (error) {
        alert('Error updating job');
      }
    });

    // Delete job
    async function deleteJob(id) {
      if (confirm('Are you sure you want to delete this job?')) {
        try {
          const response = await fetch(`/api/jobs/${id}`, {
            method: 'DELETE'
          });
          
          if (response.ok) {
            saveScrollPositionForReload();
            location.reload();
          }
        } catch (error) {
          alert('Error deleting job');
        }
      }
    }
    
    // Helper function to update job state
    async function updateJobState(id, newState, confirmMessage, successMessage) {
      if (!confirm(confirmMessage)) {
        return;
      }

      try {
        const response = await fetch(`/api/jobs/${id}/state`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ state: newState })
        });

        if (response.ok) {
          showNotification(successMessage);
          saveScrollPositionForReload();
          setTimeout(() => location.reload(), 400);
        } else {
          const errorData = await response.json();
          showNotification(errorData.message || 'Failed to update job state');
        }
      } catch (error) {
        showNotification('Error updating job state');
      }
    }

    // Mark job as complete
    async function markJobComplete(id) {
      return updateJobState(
        id,
        'Complete',
        'Mark this job as Completed?',
        'Job marked as Completed!'
      );
    }
    
    // Mark job as failed
    async function markJobFailed(id) {
      return updateJobState(
        id,
        'Failed',
        'Mark this job as Failed?',
        'Job marked as Failed!'
      );
    }
    
    // Filter jobs by state
    function filterJobs(state) {
      const jobItems = document.querySelectorAll('.job-item');
      const filterPills = document.querySelectorAll('.filter-pill');
      
      // Update active pill
      filterPills.forEach(pill => {
        if (pill.getAttribute('data-state') === state) {
          pill.classList.add('active');
        } else {
          pill.classList.remove('active');
        }
      });
      
      // Filter job items
      jobItems.forEach(item => {
        const itemState = item.getAttribute('data-state');
        if (state === 'all' || itemState === state) {
          item.style.display = '';
        } else {
          item.style.display = 'none';
        }
      });
    }

    // Admin job search functionality
    let adminJobSearchTerm = '';
    let adminJobSearchField = 'all';
    let adminCurrentState = 'all';

    // Search admin jobs
    function searchAdminJobs() {
      const searchInput = document.getElementById('admin-job-search-input');
      const searchFieldSelect = document.getElementById('admin-job-search-field');
      
      adminJobSearchTerm = searchInput.value.toLowerCase().trim();
      adminJobSearchField = searchFieldSelect.value;
      
      applyAdminFilters();
    }
    
    // Clear admin job search
    function clearAdminJobSearch() {
      const searchInput = document.getElementById('admin-job-search-input');
      const searchFieldSelect = document.getElementById('admin-job-search-field');
      
      searchInput.value = '';
      searchFieldSelect.value = 'all';
      adminJobSearchTerm = '';
      adminJobSearchField = 'all';
      
      applyAdminFilters();
    }
    
    // Apply both state filter and search filter
    function applyAdminFilters() {
      const jobItems = document.querySelectorAll('.job-item');
      
      jobItems.forEach(item => {
        const itemState = item.getAttribute('data-state');
        const stateMatch = adminCurrentState === 'all' || itemState === adminCurrentState;
        
        let searchMatch = true;
        if (adminJobSearchTerm) {
          // Get all text content from the job item
          const allText = item.textContent.toLowerCase();
          const jobTitle = item.querySelector('h3').textContent.toLowerCase();
          
          if (adminJobSearchField === 'all') {
            searchMatch = allText.includes(adminJobSearchTerm);
          } else if (adminJobSearchField === 'name') {
            searchMatch = jobTitle.includes(adminJobSearchTerm);
          } else if (adminJobSearchField === 'faction') {
            if (adminJobSearchTerm === 'none') {
              searchMatch = allText.includes('field_null');
            } else {
              searchMatch = allText.includes(adminJobSearchTerm);
            }
          } else if (adminJobSearchField === 'description') {
            searchMatch = allText.includes(adminJobSearchTerm);
          } else if (adminJobSearchField === 'pilot') {
            // For pilot search - would need additional data structure
            searchMatch = allText.includes(adminJobSearchTerm);
          }
        }
        
        if (stateMatch && searchMatch) {
          item.style.display = '';
        } else {
          item.style.display = 'none';
        }
      });
    }
    
    // Override filterJobs to work with search
    filterJobs = function(state) {
      adminCurrentState = state;
      const filterPills = document.querySelectorAll('.filter-pill');
      
      // Update active pill
      filterPills.forEach(pill => {
        if (pill.getAttribute('data-state') === state) {
          pill.classList.add('active');
        } else {
          pill.classList.remove('active');
        }
      });
      
      applyAdminFilters();
    };

    // Delete selected emblem
    async function deleteSelectedEmblem() {
      const selectedEmblem = document.getElementById('jobEmblem').value;
      
      if (!selectedEmblem) {
        alert('Please select an emblem to delete');
        return;
      }
      
      if (confirm(`Are you sure you want to delete the emblem "${formatEmblemTitle(selectedEmblem)}"?\n\nThis action cannot be undone.`)) {
        try {
          const response = await fetch(`/api/emblems/${encodeURIComponent(selectedEmblem)}`, {
            method: 'DELETE'
          });
          
          const data = await response.json();
          
          if (response.ok) {
            showNotification('Emblem deleted successfully!');
            saveScrollPositionForReload();
            setTimeout(() => location.reload(), 400);
          } else {
            alert(data.message || 'Failed to delete emblem');
          }
        } catch (error) {
          alert('Error deleting emblem: ' + error.message);
        }
      }
    }

    // ==================== BASE MANAGEMENT ====================
    
    // ==================== OVERVIEW MANNA MANAGEMENT ====================
    // Pilot selection modal state
    let pilotSelectionContext = null; // 'add' or { type: 'edit', transactionId: '...' }
    let selectedPilotIds = [];
    
    function openPilotSelectionModal(transactionId = null) {
      const modal = document.getElementById('pilotSelectionModal');
      
      if (transactionId) {
        pilotSelectionContext = { type: 'edit', transactionId };
        // Get current pilot selections for this transaction
        fetch('/api/pilots')
          .then(res => {
            if (!res.ok) {
              throw new Error('Failed to fetch pilot data');
            }
            return res.json();
          })
          .then(pilots => {
            selectedPilotIds = pilots
              .filter(p => p.personalTransactions && p.personalTransactions.includes(transactionId))
              .map(p => p.id);
            updatePilotCheckboxes();
            // Display modal only after data is loaded
            modal.style.display = 'block';
          })
          .catch(error => {
            console.error('Error fetching pilot data:', error);
            // Do not open modal on error; inform user via alert
            alert('Failed to load pilot data. Please try again.');
          });
      } else {
        pilotSelectionContext = 'add';
        selectedPilotIds = [];
        updatePilotCheckboxes();
        modal.style.display = 'block';
      }
    }
    
    function closePilotSelectionModal() {
      document.getElementById('pilotSelectionModal').style.display = 'none';
      pilotSelectionContext = null;
    }
    
    function updatePilotCheckboxes() {
      const checkboxes = document.querySelectorAll('.pilot-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = selectedPilotIds.includes(cb.value);
      });
    }
    
    function confirmPilotSelection() {
      const checkboxes = document.querySelectorAll('.pilot-checkbox:checked');
      selectedPilotIds = Array.from(checkboxes).map(cb => cb.value);
      
      if (pilotSelectionContext === 'add') {
        // Update the form
        document.getElementById('selectedPilotIds').value = JSON.stringify(selectedPilotIds);
        
        // Update the display text
        if (selectedPilotIds.length === 0) {
          document.getElementById('selectedPilotsText').textContent = 'No pilots selected (will assign to all active pilots)';
        } else {
          const pilotNames = Array.from(checkboxes).map(cb => cb.parentElement.textContent.trim());
          document.getElementById('selectedPilotsText').textContent = `Selected: ${pilotNames.join(', ')}`;
        }
      } else if (pilotSelectionContext && pilotSelectionContext.type === 'edit') {
        // Update the transaction's pilot associations
        updateTransactionPilots(pilotSelectionContext.transactionId, selectedPilotIds);
      }
      
      closePilotSelectionModal();
    }
    
    async function updateTransactionPilots(transactionId, pilotIds) {
      try {
        const response = await fetch(`/api/manna/transaction/${transactionId}/pilots`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ pilotIds })
        });
        
        if (response.ok) {
          showNotification('Transaction pilot assignments updated!');
        } else {
          const errorData = await response.json();
          alert(errorData.message || 'Failed to update pilot assignments');
        }
      } catch (error) {
        console.error('Error updating transaction pilots:', error);
        alert('Error updating pilot assignments');
      }
    }
    
    function editTransactionPilots(transactionId) {
      openPilotSelectionModal(transactionId);
    }
    
    // Transaction filtering
    function filterTransactions(filter, event) {
      // Update active pill
      document.querySelectorAll('.filter-pill').forEach(pill => {
        pill.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // Filter transactions
      const transactions = document.querySelectorAll('.transaction-item');
      transactions.forEach(txn => {
        const isAssigned = txn.getAttribute('data-assigned') === 'true';
        
        if (filter === 'all') {
          txn.style.display = '';
        } else if (filter === 'assigned') {
          txn.style.display = isAssigned ? '' : 'none';
        } else if (filter === 'unassigned') {
          txn.style.display = !isAssigned ? '' : 'none';
        }
      });
    }
    
    if (document.getElementById('overviewMannaForm')) {
      document.getElementById('overviewMannaForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        
        // Parse pilotIds from JSON string
        if (data.pilotIds) {
          try {
            data.pilotIds = JSON.parse(data.pilotIds);
          } catch (e) {
            data.pilotIds = [];
          }
        }
        
        try {
          const response = await fetch('/api/manna/transaction', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          
          if (response.ok) {
            const result = await response.json();
            document.getElementById('overviewMannaForm').reset();
            document.getElementById('selectedPilotIds').value = '';
            document.getElementById('selectedPilotsText').textContent = 'No pilots selected (will assign to all active pilots)';
            showNotification('Transaction added successfully!');
          } else {
            const errorData = await response.json();
            alert(errorData.message || 'Failed to add transaction');
          }
        } catch (error) {
          console.error('Error adding transaction:', error);
          alert('Error adding transaction');
        }
      });
    }
    
    // ==================== MANNA MANAGEMENT ====================
    if (document.getElementById('mannaForm')) {
      document.getElementById('mannaForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        
        try {
          const response = await fetch('/api/manna/transaction', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          
          if (response.ok) {
            const result = await response.json();
            document.getElementById('mannaBalance').textContent = result.manna.balance;
            document.getElementById('mannaForm').reset();
            showNotification('Transaction added successfully!');
          } else {
            const errorData = await response.json();
            alert(errorData.message || 'Failed to add transaction');
          }
        } catch (error) {
          alert('Error adding transaction');
        }
      });
    }
    
    // ==================== FACTION MANAGEMENT ====================
    if (document.getElementById('addFactionForm')) {
      document.getElementById('addFactionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        
        try {
          const response = await fetch('/api/factions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          
          if (response.ok) {
            showNotification('Faction added successfully!');
            saveScrollPositionForReload();
            setTimeout(() => location.reload(), 400);
          } else {
            const errorData = await response.json();
            alert(errorData.message || 'Failed to add faction');
          }
        } catch (error) {
          alert('Error adding faction');
        }
      });
    }
    
    function editFaction(id) {
      const factionData = <%- JSON.stringify(factions) %>.find(f => f.id === id);
      
      document.getElementById('editFactionId').value = factionData.id;
      document.getElementById('editFactionTitle').value = factionData.title;
      document.getElementById('editFactionBrief').value = factionData.brief;
      document.getElementById('editFactionStanding').value = factionData.standing;
      document.getElementById('editFactionJobsCompletedOffset').value = factionData.jobsCompletedOffset || 0;
      document.getElementById('editFactionJobsFailedOffset').value = factionData.jobsFailedOffset || 0;
      document.getElementById('editFactionAdminLog').value = factionData.adminLog || '';
      document.getElementById('editFactionEmblem').value = factionData.emblem || '';
      
      // Select the correct emblem in the grid
      const editGrid = document.getElementById('editFactionEmblemGrid');
      editGrid.querySelectorAll('.emblem-option').forEach(opt => opt.classList.remove('selected'));
      const selectedEmblem = Array.from(editGrid.querySelectorAll('.emblem-option')).find(opt => opt.getAttribute('data-emblem') === (factionData.emblem || ''));
      if (selectedEmblem) {
        selectedEmblem.classList.add('selected');
      }
      
      document.getElementById('editFactionModal').style.display = 'block';
    }
    
    function closeEditFactionModal() {
      document.getElementById('editFactionModal').style.display = 'none';
    }
    
    if (document.getElementById('editFactionForm')) {
      document.getElementById('editFactionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        const id = document.getElementById('editFactionId').value;
        
        try {
          const response = await fetch(`/api/factions/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          
          if (response.ok) {
            showNotification('Faction updated successfully');
            closeEditFactionModal();
            saveScrollPositionForReload();
            setTimeout(() => location.reload(), 400);
          } else {
            const errorData = await response.json();
            alert(errorData.message || 'Failed to update faction');
          }
        } catch (error) {
          alert('Error updating faction');
        }
      });
    }
    
    async function deleteFaction(id) {
      if (confirm('Are you sure you want to delete this faction?')) {
        try {
          const response = await fetch(`/api/factions/${id}`, {
            method: 'DELETE'
          });
          
          if (response.ok) {
            showNotification('Faction deleted successfully!');
            saveScrollPositionForReload();
            setTimeout(() => location.reload(), 400);
          } else {
            alert('Failed to delete faction');
          }
        } catch (error) {
          alert('Error deleting faction');
        }
      }
    }
    
    // ==================== TRANSACTION MANAGEMENT ====================
    function editTransaction(id) {
      const transactionData = <%- JSON.stringify(manna.transactions) %>.find(t => t.id === id);
      
      if (!transactionData) {
        alert('Transaction not found');
        return;
      }
      
      document.getElementById('editTransactionId').value = transactionData.id;
      
      // Convert ISO date to datetime-local format (YYYY-MM-DDTHH:mm)
      const date = new Date(transactionData.date);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const localDatetime = `${year}-${month}-${day}T${hours}:${minutes}`;
      
      document.getElementById('editTransactionDate').value = localDatetime;
      document.getElementById('editTransactionAmount').value = transactionData.amount;
      document.getElementById('editTransactionDescription').value = transactionData.description;
      
      document.getElementById('editTransactionModal').style.display = 'block';
    }
    
    function closeEditTransactionModal() {
      document.getElementById('editTransactionModal').style.display = 'none';
    }
    
    if (document.getElementById('editTransactionForm')) {
      document.getElementById('editTransactionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        const id = document.getElementById('editTransactionId').value;
        
        // Validate amount
        const amount = parseInt(data.amount);
        if (isNaN(amount)) {
          alert('Invalid amount. Please enter a valid number.');
          return;
        }
        
        try {
          const response = await fetch(`/api/manna/transaction/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              date: new Date(data.date).toISOString(),
              amount: amount,
              description: data.description
            })
          });
          
          if (response.ok) {
            showNotification('Transaction updated successfully');
            closeEditTransactionModal();
            saveScrollPositionForReload();
            setTimeout(() => location.reload(), 400);
          } else {
            const errorData = await response.json();
            alert(errorData.message || 'Failed to update transaction');
          }
        } catch (error) {
          alert('Error updating transaction');
        }
      });
    }
    
    async function deleteTransaction(id) {
      if (confirm('Are you sure you want to delete this transaction?\n\nNote: This will NOT affect the current balance value.')) {
        try {
          const response = await fetch(`/api/manna/transaction/${id}`, {
            method: 'DELETE'
          });
          
          if (response.ok) {
            showNotification('Transaction deleted successfully!');
            saveScrollPositionForReload();
            setTimeout(() => location.reload(), 400);
          } else {
            const errorData = await response.json();
            alert(errorData.message || 'Failed to delete transaction');
          }
        } catch (error) {
          alert('Error deleting transaction');
        }
      }
    }
    
    // ==================== PILOT MANAGEMENT ====================
    if (document.getElementById('addPilotForm')) {
      document.getElementById('addPilotForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        
        // Ensure checkbox state is always captured explicitly
        data.active = formData.get('active') === 'true' || formData.has('active');
        
        // Ensure personalOperationProgress has a value (default to 0 if field doesn't exist)
        if (data.personalOperationProgress === undefined || data.personalOperationProgress === null) {
          data.personalOperationProgress = 0;
        }
        
        try {
          const response = await fetch('/api/pilots', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          
          if (response.ok) {
            showNotification('Pilot added successfully!');
            saveScrollPositionForReload();
            setTimeout(() => location.reload(), 400);
          } else {
            const errorData = await response.json();
            alert(errorData.message || 'Failed to add pilot');
          }
        } catch (error) {
          alert('Error adding pilot');
        }
      });
    }
    
    function editPilot(id) {
      const pilotData = <%- JSON.stringify(pilots) %>.find(p => p.id === id);
      
      if (!pilotData) {
        alert('Pilot not found');
        return;
      }
      
      document.getElementById('editPilotId').value = pilotData.id;
      document.getElementById('editPilotName').value = pilotData.name;
      document.getElementById('editPilotCallsign').value = pilotData.callsign;
      document.getElementById('editPilotLL').value = pilotData.ll;
      document.getElementById('editPilotNotes').value = pilotData.notes || '';
      document.getElementById('editPilotAdminLog').value = pilotData.adminLog || '';
      document.getElementById('editPilotActive').checked = pilotData.active;
      
      // Set personalOperationProgress if the field exists (when openTable is ON)
      // When openTable is OFF, the field is not rendered in the DOM and this safely skips setting the value
      const personalProgressField = document.getElementById('editPilotPersonalOperationProgress');
      if (personalProgressField) {
        personalProgressField.value = pilotData.personalOperationProgress ?? 0;
      }
      
      document.getElementById('editPilotModal').style.display = 'block';
    }
    
    function closeEditPilotModal() {
      document.getElementById('editPilotModal').style.display = 'none';
    }
    
    if (document.getElementById('editPilotForm')) {
      document.getElementById('editPilotForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        const id = document.getElementById('editPilotId').value;
        
        // Ensure checkbox state is always captured explicitly
        data.active = formData.get('active') === 'true' || formData.has('active');
        
        // Get current pilot's related jobs
        const pilotData = <%- JSON.stringify(pilots) %>.find(p => p.id === id);
        data.relatedJobs = pilotData ? pilotData.relatedJobs : [];
        
        // Ensure personalOperationProgress has a value (preserve existing if field doesn't exist)
        if (data.personalOperationProgress === undefined || data.personalOperationProgress === null) {
          data.personalOperationProgress = pilotData ? (pilotData.personalOperationProgress ?? 0) : 0;
        }
        
        try {
          const response = await fetch(`/api/pilots/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          
          if (response.ok) {
            showNotification('Pilot updated successfully');
            closeEditPilotModal();
            saveScrollPositionForReload();
            setTimeout(() => location.reload(), 400);
          } else {
            const errorData = await response.json();
            alert(errorData.message || 'Failed to update pilot');
          }
        } catch (error) {
          alert('Error updating pilot');
        }
      });
    }
    
    async function deletePilot(id) {
      if (confirm('Are you sure you want to delete this pilot?')) {
        try {
          const response = await fetch(`/api/pilots/${id}`, {
            method: 'DELETE'
          });
          
          if (response.ok) {
            showNotification('Pilot deleted successfully!');
            saveScrollPositionForReload();
            setTimeout(() => location.reload(), 400);
          } else {
            alert('Failed to delete pilot');
          }
        } catch (error) {
          alert('Error deleting pilot');
        }
      }
    }
    
    function openPilotRelatedJobsModal(pilotId) {
      const pilotData = <%- JSON.stringify(pilots) %>.find(p => p.id === pilotId);
      const allJobs = <%- JSON.stringify(jobs) %>;
      
      if (!pilotData) {
        alert('Pilot not found');
        return;
      }
      
      // Filter out Pending jobs
      const availableJobs = allJobs.filter(job => job.state !== 'Pending');
      const pilotRelatedJobs = new Set(pilotData.relatedJobs || []);
      
      const listHtml = availableJobs.map(job => {
        const isChecked = pilotRelatedJobs.has(job.id);
        return `
          <div style="margin-bottom: 10px; padding: 10px; border: 1px solid #444; border-radius: 3px; background-color: #2a2a2a;">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
              <input type="checkbox" value="${job.id}" ${isChecked ? 'checked' : ''} class="pilot-related-job-checkbox">
              <span style="color: #e0e0e0;">
                <strong>${job.name}</strong> (${job.state})
              </span>
            </label>
          </div>
        `;
      }).join('');
      
      document.getElementById('pilotRelatedJobsPilotId').value = pilotId;
      document.getElementById('pilotRelatedJobsList').innerHTML = listHtml || '<p style="color: #b0b0b0;">No non-Pending jobs available</p>';
      document.getElementById('pilotRelatedJobsModal').style.display = 'block';
    }
    
    function closePilotRelatedJobsModal() {
      document.getElementById('pilotRelatedJobsModal').style.display = 'none';
    }
    
    async function savePilotRelatedJobs() {
      const pilotId = document.getElementById('pilotRelatedJobsPilotId').value;
      const pilotData = <%- JSON.stringify(pilots) %>.find(p => p.id === pilotId);
      
      if (!pilotData) {
        alert('Pilot not found');
        return;
      }
      
      // Get selected job IDs
      const checkboxes = document.querySelectorAll('.pilot-related-job-checkbox:checked');
      const relatedJobs = Array.from(checkboxes).map(cb => cb.value);
      
      try {
        const response = await fetch(`/api/pilots/${pilotId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ...pilotData,
            relatedJobs: relatedJobs
          })
        });
        
        if (response.ok) {
          showNotification('Related jobs updated successfully');
          closePilotRelatedJobsModal();
          saveScrollPositionForReload();
          setTimeout(() => location.reload(), 400);
        } else {
          const errorData = await response.json();
          alert(errorData.message || 'Failed to update related jobs');
        }
      } catch (error) {
        alert('Error updating related jobs');
      }
    }
    
    // ==================== PILOT BALANCE HISTORY ====================
    async function openPilotBalanceHistoryModal(pilotId) {
      try {
        // Fetch pilot balance and transaction history from API
        const response = await fetch(`/api/pilots/${pilotId}/balance`);
        if (!response.ok) {
          alert('Failed to load pilot balance history');
          return;
        }
        
        const data = await response.json();
        const pilotData = <%- JSON.stringify(pilots) %>.find(p => p.id === pilotId);
        
        if (!pilotData) {
          alert('Pilot not found');
          return;
        }
        
        // Set pilot ID and balance
        document.getElementById('pilotBalanceHistoryPilotId').value = pilotId;
        document.getElementById('pilotBalanceHistoryTotal').textContent = data.balance || 0;
        
        // Create transaction list (sorted newest to top)
        const transactions = data.transactions || [];
        
        if (transactions.length === 0) {
          document.getElementById('pilotBalanceHistoryList').innerHTML = '<p style="color: #b0b0b0;">No transactions associated with this pilot</p>';
        } else {
          const listHtml = transactions.map(transaction => {
            const date = new Date(transaction.date).toLocaleString('en-GB', { dateStyle: 'short', timeStyle: 'short' });
            const amountColor = transaction.amount >= 0 ? '#66BB6A' : '#f44336';
            const amountSign = transaction.amount >= 0 ? '+' : '';
            
            return `
              <div style="margin-bottom: 15px; padding: 15px; border: 1px solid #444; border-radius: 3px; background-color: #2a2a2a;">
                <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                  <input type="checkbox" value="${transaction.id}" checked class="pilot-balance-transaction-checkbox" style="margin-top: 3px; flex-shrink: 0;">
                  <div style="flex-grow: 1;">
                    <div style="color: #b0b0b0; margin-bottom: 5px;"><strong>Date:</strong> ${date}</div>
                    <div style="color: #b0b0b0; margin-bottom: 5px;">
                      <strong>Amount:</strong> 
                      <span style="color: ${amountColor}">${amountSign}${transaction.amount}</span>
                      <img src="/emblems/<%= settings.currencyIcon || 'manna_symbol.svg' %>" alt="Currency Icon" class="currency-icon">
                    </div>
                    <div style="color: #b0b0b0; margin-bottom: 5px;"><strong>Description:</strong> ${transaction.description}</div>
                    <div style="color: #b0b0b0;">
                      <strong>Balance After:</strong> ${transaction.pilotBalance}
                      <img src="/emblems/<%= settings.currencyIcon || 'manna_symbol.svg' %>" alt="Currency Icon" class="currency-icon">
                    </div>
                  </div>
                </label>
              </div>
            `;
          }).join('');
          
          document.getElementById('pilotBalanceHistoryList').innerHTML = listHtml;
        }
        
        document.getElementById('pilotBalanceHistoryModal').style.display = 'block';
      } catch (error) {
        console.error('Error loading pilot balance history:', error);
        alert('Error loading pilot balance history');
      }
    }
    
    function closePilotBalanceHistoryModal() {
      document.getElementById('pilotBalanceHistoryModal').style.display = 'none';
    }
    
    async function savePilotBalanceHistory() {
      const pilotId = document.getElementById('pilotBalanceHistoryPilotId').value;
      
      // Get selected transaction IDs
      const checkboxes = document.querySelectorAll('.pilot-balance-transaction-checkbox:checked');
      const personalTransactions = Array.from(checkboxes).map(cb => cb.value);
      
      try {
        const response = await fetch(`/api/pilots/${pilotId}/personal-transactions`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            personalTransactions: personalTransactions
          })
        });
        
        if (response.ok) {
          showNotification('Balance history updated successfully');
          closePilotBalanceHistoryModal();
          saveScrollPositionForReload();
          setTimeout(() => location.reload(), 400);
        } else {
          const errorData = await response.json();
          alert(errorData.message || 'Failed to update balance history');
        }
      } catch (error) {
        console.error('Error updating balance history:', error);
        alert('Error updating balance history');
      }
    }
    
    // ==================== PILOT RESERVES MANAGEMENT ====================
    let selectedPilotReserves = new Set();
    let selectedStockReservesForAdd = new Set();
    
    async function openPilotReservesModal(pilotId) {
      try {
        // Fetch fresh pilot and reserves data
        const pilotsResponse = await fetch('/api/pilots');
        const reservesResponse = await fetch('/api/reserves');
        const pilotsData = await pilotsResponse.json();
        const reservesData = await reservesResponse.json();
        
        const pilot = pilotsData.find(p => p.id === pilotId);
        if (!pilot) {
          alert('Pilot not found');
          return;
        }
        
        // Set pilot ID
        document.getElementById('pilotReservesModalPilotId').value = pilotId;
        
        // Clear previous selection
        selectedPilotReserves.clear();
        updateReserveActionButtons();
        
        // Build reserves grid
        const grid = document.getElementById('pilotReservesGrid');
        
        if (!pilot.reserves || pilot.reserves.length === 0) {
          grid.innerHTML = '<p style="color: #888; font-style: italic; margin: 20px 0;">No reserves owned by this pilot.</p>';
        } else {
          // Get full reserve details and sort by rank then name
          const pilotReservesWithDetails = pilot.reserves.map(pr => {
            const reserve = reservesData.find(r => r.id === pr.reserveId);
            return reserve ? { ...reserve, deploymentStatus: pr.deploymentStatus } : null;
          }).filter(r => r !== null)
            .sort((a, b) => {
              if (a.rank !== b.rank) return a.rank - b.rank;
              return a.name.localeCompare(b.name);
            });
          
          // Clear existing content
          grid.innerHTML = '';
          
          // Build cards using safe DOM APIs to avoid XSS
          pilotReservesWithDetails.forEach(reserve => {
            const statusColor = reserve.deploymentStatus === 'In Reserve' ? '#66BB6A' : 
                               reserve.deploymentStatus === 'Deployed' ? '#FFA726' : '#f44336';
            
            const card = document.createElement('div');
            card.className = 'job-item pilot-reserve-card';
            card.dataset.reserveId = reserve.id;
            card.style.cursor = 'pointer';
            card.style.transition = 'all 0.2s';
            
            card.addEventListener('click', () => {
              togglePilotReserveSelection(card, reserve.id);
            });
            
            // Title
            const titleEl = document.createElement('h3');
            titleEl.style.color = '#e0e0e0';
            titleEl.style.marginBottom = '10px';
            titleEl.textContent = reserve.name;
            card.appendChild(titleEl);
            
            // Rank
            const rankDiv = document.createElement('div');
            rankDiv.className = 'job-item-field';
            const rankStrong = document.createElement('strong');
            rankStrong.textContent = 'Rank:';
            rankDiv.appendChild(rankStrong);
            rankDiv.appendChild(document.createTextNode(' R' + reserve.rank));
            card.appendChild(rankDiv);
            
            // Price
            const priceDiv = document.createElement('div');
            priceDiv.className = 'job-item-field';
            const priceStrong = document.createElement('strong');
            priceStrong.textContent = 'Price:';
            priceDiv.appendChild(priceStrong);
            priceDiv.appendChild(document.createTextNode(' ' + reserve.price + ' '));
            const priceImg = document.createElement('img');
            priceImg.src = '/emblems/<%= settings.currencyIcon || 'manna_symbol.svg' %>';
            priceImg.alt = 'Currency Icon';
            priceImg.className = 'currency-icon';
            priceDiv.appendChild(priceImg);
            card.appendChild(priceDiv);
            
            // Status
            const statusDiv = document.createElement('div');
            statusDiv.className = 'job-item-field';
            const statusStrong = document.createElement('strong');
            statusStrong.textContent = 'Status:';
            statusDiv.appendChild(statusStrong);
            statusDiv.appendChild(document.createTextNode(' '));
            const statusSpan = document.createElement('span');
            statusSpan.style.color = statusColor;
            statusSpan.style.fontWeight = 'bold';
            statusSpan.textContent = reserve.deploymentStatus;
            statusDiv.appendChild(statusSpan);
            card.appendChild(statusDiv);
            
            // Description (optional)
            if (reserve.description) {
              const descDiv = document.createElement('div');
              descDiv.className = 'job-item-field';
              const descStrong = document.createElement('strong');
              descStrong.textContent = 'Description:';
              descDiv.appendChild(descStrong);
              descDiv.appendChild(document.createElement('br'));
              descDiv.appendChild(document.createTextNode(reserve.description));
              card.appendChild(descDiv);
            }
            
            grid.appendChild(card);
          });
        }
        
        // Show modal
        document.getElementById('pilotReservesModal').style.display = 'block';
      } catch (error) {
        console.error('Error opening pilot reserves modal:', error);
        alert('Error loading pilot reserves');
      }
    }
    
    function closePilotReservesModal() {
      document.getElementById('pilotReservesModal').style.display = 'none';
      selectedPilotReserves.clear();
    }
    
    function togglePilotReserveSelection(element, reserveId) {
      if (selectedPilotReserves.has(reserveId)) {
        selectedPilotReserves.delete(reserveId);
        element.style.backgroundColor = '';
        element.style.border = '';
      } else {
        selectedPilotReserves.add(reserveId);
        element.style.backgroundColor = '#3a3a3a';
        element.style.border = '2px solid #66BB6A';
      }
      updateReserveActionButtons();
    }
    
    function updateReserveActionButtons() {
      const hasSelection = selectedPilotReserves.size > 0;
      document.getElementById('setInReserveBtn').disabled = !hasSelection;
      document.getElementById('setDeployedBtn').disabled = !hasSelection;
      document.getElementById('setExpendedBtn').disabled = !hasSelection;
      document.getElementById('removeReservesBtn').disabled = !hasSelection;
    }
    
    async function setSelectedReservesStatus(newStatus) {
      if (selectedPilotReserves.size === 0) {
        return;
      }
      
      const pilotId = document.getElementById('pilotReservesModalPilotId').value;
      
      try {
        // Fetch fresh pilot data
        const pilotsResponse = await fetch('/api/pilots');
        const pilotsData = await pilotsResponse.json();
        const pilot = pilotsData.find(p => p.id === pilotId);
        
        if (!pilot) {
          alert('Pilot not found');
          return;
        }
        
        // Update reserves array
        const updatedReserves = pilot.reserves.map(pr => {
          if (selectedPilotReserves.has(pr.reserveId)) {
            return { ...pr, deploymentStatus: newStatus };
          }
          return pr;
        });
        
        const response = await fetch(`/api/pilots/${pilotId}/reserves-management`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reserves: updatedReserves })
        });
        
        if (response.ok) {
          showNotification(`Deployment status updated to "${newStatus}"`);
          selectedPilotReserves.clear();
          saveScrollPositionForReload();
          setTimeout(() => location.reload(), 400);
        } else {
          const errorData = await response.json();
          alert(errorData.message || 'Failed to update reserves');
        }
      } catch (error) {
        console.error('Error updating reserves:', error);
        alert('Error updating reserves');
      }
    }
    
    async function removeSelectedReservesFromPilot() {
      if (selectedPilotReserves.size === 0) {
        return;
      }
      
      if (!confirm(`Remove ${selectedPilotReserves.size} reserve(s) from this pilot?`)) {
        return;
      }
      
      const pilotId = document.getElementById('pilotReservesModalPilotId').value;
      const pilotsData = <%- JSON.stringify(pilots) %>;
      const pilot = pilotsData.find(p => p.id === pilotId);
      
      if (!pilot) {
        alert('Pilot not found');
        return;
      }
      
      // Filter out selected reserves
      const updatedReserves = pilot.reserves.filter(pr => !selectedPilotReserves.has(pr.reserveId));
      
      try {
        const response = await fetch(`/api/pilots/${pilotId}/reserves-management`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reserves: updatedReserves })
        });
        
        if (response.ok) {
          showNotification('Reserves removed from pilot');
          selectedPilotReserves.clear();
          saveScrollPositionForReload();
          setTimeout(() => location.reload(), 400);
        } else {
          const errorData = await response.json();
          alert(errorData.message || 'Failed to remove reserves');
        }
      } catch (error) {
        console.error('Error removing reserves:', error);
        alert('Error removing reserves');
      }
    }
    
    async function openAddReservesToPilotModal() {
      try {
        const reservesData = <%- JSON.stringify(reserves) %>;
        
        // Clear previous selection and filters
        selectedStockReservesForAdd.clear();
        updateAddStockReservesButton();
        
        // Reset filters
        document.getElementById('pilotAddReserveSearchInput').value = '';
        document.querySelectorAll('#addReservesToPilotModal .filter-pill').forEach(pill => {
          pill.classList.remove('active');
        });
        document.getElementById('pilotAddFilterAll').classList.add('active');
        document.getElementById('pilotAddHideDefaultPill').dataset.hideDefault = 'false';
        document.getElementById('pilotAddHideDefaultPill').classList.remove('active');
        
        // Build reserves grid - show ALL reserves
        const grid = document.getElementById('addReservesStockGrid');
        
        if (!reservesData || reservesData.length === 0) {
          grid.innerHTML = '<p style="color: #888; font-style: italic; margin: 20px 0;">No reserves available.</p>';
        } else {
          // Sort by rank then name
          const sortedReserves = [...reservesData].sort((a, b) => {
            if (a.rank !== b.rank) return a.rank - b.rank;
            return a.name.localeCompare(b.name);
          });
          
          // Clear existing content
          grid.innerHTML = '';
          
          // Build cards using safe DOM APIs to avoid XSS
          sortedReserves.forEach(reserve => {
            const card = document.createElement('div');
            card.className = 'job-item stock-reserve-card';
            card.dataset.reserveId = reserve.id;
            card.dataset.rank = String(reserve.rank);
            card.dataset.isCustom = String(reserve.isCustom);
            card.dataset.name = (reserve.name || '').toLowerCase();
            card.style.cursor = 'pointer';
            card.style.transition = 'all 0.2s';
            
            card.addEventListener('click', () => {
              toggleStockReserveForAdd(card, reserve.id);
            });
            
            // Title
            const titleEl = document.createElement('h3');
            titleEl.style.color = '#e0e0e0';
            titleEl.style.marginBottom = '10px';
            titleEl.textContent = reserve.name;
            card.appendChild(titleEl);
            
            // Rank
            const rankDiv = document.createElement('div');
            rankDiv.className = 'job-item-field';
            const rankStrong = document.createElement('strong');
            rankStrong.textContent = 'Rank:';
            rankDiv.appendChild(rankStrong);
            rankDiv.appendChild(document.createTextNode(' R' + reserve.rank));
            card.appendChild(rankDiv);
            
            // Price
            const priceDiv = document.createElement('div');
            priceDiv.className = 'job-item-field';
            const priceStrong = document.createElement('strong');
            priceStrong.textContent = 'Price:';
            priceDiv.appendChild(priceStrong);
            priceDiv.appendChild(document.createTextNode(' ' + reserve.price + ' '));
            const priceImg = document.createElement('img');
            priceImg.src = '/emblems/<%= settings.currencyIcon || 'manna_symbol.svg' %>';
            priceImg.alt = 'Currency Icon';
            priceImg.className = 'currency-icon';
            priceDiv.appendChild(priceImg);
            card.appendChild(priceDiv);
            
            // Description (optional)
            if (reserve.description) {
              const descDiv = document.createElement('div');
              descDiv.className = 'job-item-field';
              const descStrong = document.createElement('strong');
              descStrong.textContent = 'Description:';
              descDiv.appendChild(descStrong);
              descDiv.appendChild(document.createElement('br'));
              descDiv.appendChild(document.createTextNode(reserve.description));
              card.appendChild(descDiv);
            }
            
            // Type
            const typeDiv = document.createElement('div');
            typeDiv.className = 'job-item-field';
            const typeStrong = document.createElement('strong');
            typeStrong.textContent = 'Type:';
            typeDiv.appendChild(typeStrong);
            typeDiv.appendChild(document.createTextNode(' ' + (reserve.isCustom ? 'Custom' : 'Default')));
            card.appendChild(typeDiv);
            
            grid.appendChild(card);
          });
        }
        
        // Show modal
        document.getElementById('addReservesToPilotModal').style.display = 'block';
      } catch (error) {
        console.error('Error opening add reserves modal:', error);
        alert('Error loading reserves');
      }
    }
    
    function closeAddReservesToPilotModal() {
      document.getElementById('addReservesToPilotModal').style.display = 'none';
      selectedStockReservesForAdd.clear();
    }
    
    function filterPilotAddReserves(rank, event) {
      // Update active pill
      document.querySelectorAll('#addReservesToPilotModal .filter-pill[data-rank]').forEach(pill => {
        pill.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // Apply filter
      const cards = document.querySelectorAll('#addReservesStockGrid .stock-reserve-card');
      cards.forEach(card => {
        const cardRank = card.dataset.rank;
        const hideDefault = document.getElementById('pilotAddHideDefaultPill').dataset.hideDefault === 'true';
        const isCustom = card.dataset.isCustom === 'true';
        const searchValue = document.getElementById('pilotAddReserveSearchInput').value.toLowerCase();
        const cardName = card.dataset.name;
        
        let shouldShow = true;
        
        // Rank filter
        if (rank !== 'all' && cardRank !== rank) {
          shouldShow = false;
        }
        
        // Hide default filter
        if (hideDefault && !isCustom) {
          shouldShow = false;
        }
        
        // Search filter
        if (searchValue && !cardName.includes(searchValue)) {
          shouldShow = false;
        }
        
        card.style.display = shouldShow ? '' : 'none';
      });
    }
    
    function togglePilotAddHideDefault(event) {
      const currentState = event.target.dataset.hideDefault === 'true';
      event.target.dataset.hideDefault = currentState ? 'false' : 'true';
      event.target.classList.toggle('active');
      
      // Re-apply current rank filter
      const activeRankPill = document.querySelector('#addReservesToPilotModal .filter-pill[data-rank].active');
      const currentRank = activeRankPill ? activeRankPill.dataset.rank : 'all';
      filterPilotAddReserves(currentRank, activeRankPill || event);
    }
    
    function searchPilotAddReserves(searchValue) {
      searchValue = searchValue.toLowerCase();
      
      // Re-apply current filters
      const activeRankPill = document.querySelector('#addReservesToPilotModal .filter-pill[data-rank].active');
      const currentRank = activeRankPill ? activeRankPill.dataset.rank : 'all';
      
      const cards = document.querySelectorAll('#addReservesStockGrid .stock-reserve-card');
      cards.forEach(card => {
        const cardRank = card.dataset.rank;
        const hideDefault = document.getElementById('pilotAddHideDefaultPill').dataset.hideDefault === 'true';
        const isCustom = card.dataset.isCustom === 'true';
        const cardName = card.dataset.name;
        
        let shouldShow = true;
        
        // Rank filter
        if (currentRank !== 'all' && cardRank !== currentRank) {
          shouldShow = false;
        }
        
        // Hide default filter
        if (hideDefault && !isCustom) {
          shouldShow = false;
        }
        
        // Search filter
        if (searchValue && !cardName.includes(searchValue)) {
          shouldShow = false;
        }
        
        card.style.display = shouldShow ? '' : 'none';
      });
    }
    
    function toggleStockReserveForAdd(element, reserveId) {
      if (selectedStockReservesForAdd.has(reserveId)) {
        selectedStockReservesForAdd.delete(reserveId);
        element.style.backgroundColor = '';
        element.style.border = '';
      } else {
        selectedStockReservesForAdd.add(reserveId);
        element.style.backgroundColor = '#3a3a3a';
        element.style.border = '2px solid #66BB6A';
      }
      updateAddStockReservesButton();
    }
    
    function updateAddStockReservesButton() {
      const hasSelection = selectedStockReservesForAdd.size > 0;
      document.getElementById('addStockReservesBtn').disabled = !hasSelection;
    }
    
    async function addSelectedStockReservesToPilot() {
      if (selectedStockReservesForAdd.size === 0) {
        return;
      }
      
      const pilotId = document.getElementById('pilotReservesModalPilotId').value;
      const pilotsData = <%- JSON.stringify(pilots) %>;
      const pilot = pilotsData.find(p => p.id === pilotId);
      
      if (!pilot) {
        alert('Pilot not found');
        return;
      }
      
      // Add new reserves with "In Reserve" status
      const newReserves = Array.from(selectedStockReservesForAdd).map(reserveId => ({
        reserveId: reserveId,
        deploymentStatus: 'In Reserve'
      }));
      
      const updatedReserves = [...pilot.reserves, ...newReserves];
      
      try {
        const response = await fetch(`/api/pilots/${pilotId}/reserves-management`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reserves: updatedReserves })
        });
        
        if (response.ok) {
          showNotification(`${newReserves.length} reserve(s) added to pilot`);
          closeAddReservesToPilotModal();
          selectedPilotReserves.clear();
          saveScrollPositionForReload();
          setTimeout(() => location.reload(), 400);
        } else {
          const errorData = await response.json();
          alert(errorData.message || 'Failed to add reserves');
        }
      } catch (error) {
        console.error('Error adding reserves:', error);
        alert('Error adding reserves');
      }
    }
    
    // ==================== FACTION RELATED JOBS ====================
    function openFactionRelatedJobsModal(factionId) {
      const allJobs = <%- JSON.stringify(jobs) %>;
      const allPilots = <%- JSON.stringify(pilots) %>;
      const factionData = <%- JSON.stringify(factions) %>.find(f => f.id === factionId);
      
      if (!factionData) {
        alert('Faction not found');
        return;
      }
      
      // Filter jobs related to this faction
      const relatedJobs = allJobs.filter(job => job.factionId === factionId);
      
      if (relatedJobs.length === 0) {
        document.getElementById('factionRelatedJobsList').innerHTML = '<p style="color: #b0b0b0;">No jobs related to this faction</p>';
      } else {
        const listHtml = relatedJobs.map(job => {
          // Find pilots related to this job
          const relatedPilots = allPilots.filter(pilot => 
            (pilot.relatedJobs || []).includes(job.id)
          ).map(p => p.callsign).join(', ') || 'None';
          
          const stateClass = job.state ? job.state.toLowerCase() : 'pending';
          
          return `
            <div style="margin-bottom: 15px; padding: 15px; border: 1px solid #444; border-radius: 3px; background-color: #1a1a1a;">
              <h4 style="color: #e0e0e0; margin-bottom: 8px;">${job.name}</h4>
              <div style="color: #b0b0b0; margin-bottom: 5px;"><strong>State:</strong> <span class="state-badge state-badge-${stateClass}">${job.state}</span></div>
              <div style="color: #b0b0b0;"><strong>Related Pilots:</strong> ${relatedPilots}</div>
            </div>
          `;
        }).join('');
        
        document.getElementById('factionRelatedJobsList').innerHTML = listHtml;
      }
      
      document.getElementById('factionRelatedJobsModal').style.display = 'block';
    }
    
    function closeFactionRelatedJobsModal() {
      document.getElementById('factionRelatedJobsModal').style.display = 'none';
    }
    
    // ==================== PROGRESS ALL JOBS ====================
    function showProgressAllJobsModal() {
      const allJobs = <%- JSON.stringify(jobs) %>;
      
      // Filter jobs that will be affected (Active → Ignored, Pending → Active)
      const affectedJobs = allJobs.filter(job => job.state === 'Active' || job.state === 'Pending');
      
      // Populate the job list
      const jobListDiv = document.getElementById('progressAllJobsList');
      if (affectedJobs.length === 0) {
        jobListDiv.innerHTML = '<p style="color: #999; text-align: center;">No jobs will be affected.</p>';
      } else {
        jobListDiv.innerHTML = affectedJobs.map(job => {
          const currentState = job.state || 'Pending';
          const newState = currentState === 'Active' ? 'Ignored' : 'Active';
          const currentStateClass = currentState.toLowerCase();
          const newStateClass = newState.toLowerCase();
          const factionName = job.faction ? job.faction.title : 'FIELD_NULL';
          
          return `
            <div style="margin-bottom: 10px; padding: 10px; border: 1px solid #444; border-radius: 3px; background-color: #2a2a2a;">
              <div style="margin-bottom: 5px;">
                <strong style="color: #e0e0e0;">${job.name}</strong>
              </div>
              <div style="margin-bottom: 5px; color: #b0b0b0;">
                <strong>Faction:</strong> ${factionName}
              </div>
              <div style="color: #b0b0b0;">
                <strong>State:</strong> 
                <span class="state-badge state-badge-${currentStateClass}">${currentState}</span>
                <span style="margin: 0 5px;">→</span>
                <span class="state-badge state-badge-${newStateClass}">${newState}</span>
              </div>
            </div>
          `;
        }).join('');
      }
      
      document.getElementById('progressAllJobsModal').style.display = 'block';
    }
    
    function closeProgressAllJobsModal() {
      document.getElementById('progressAllJobsModal').style.display = 'none';
    }
    
    async function confirmProgressAllJobs() {
      try {
        const response = await fetch('/api/jobs/progress-all', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
          const result = await response.json();
          closeProgressAllJobsModal();
          showNotification(`Jobs progressed successfully! ${result.newlyActiveJobs} jobs became active, ${result.pilotsUpdated} active pilots updated.`);
          saveScrollPositionForReload();
          setTimeout(() => location.reload(), 400);
        } else {
          const errorData = await response.json();
          alert(errorData.message || 'Failed to progress jobs');
        }
      } catch (error) {
        alert('Error progressing jobs');
      }
    }
    
    // ==================== PROGRESS OPERATION FOR ACTIVE PILOTS ====================
    function showProgressOperationModal() {
      // Get all active pilots from the DOM
      const pilotsList = document.getElementById('pilotsList');
      const pilotItems = pilotsList.querySelectorAll('.job-item');
      const activePilots = [];
      
      pilotItems.forEach(item => {
        const isActive = item.querySelector('.state-badge-active') !== null;
        if (isActive) {
          const name = item.querySelector('h3').textContent.split('(')[0].trim();
          const callsignMatch = item.querySelector('h3').textContent.match(/\("([^"]+)"\)/);
          const callsign = callsignMatch ? callsignMatch[1] : '';
          
          const llField = Array.from(item.querySelectorAll('.job-item-field')).find(field => 
            field.textContent.includes('License Level:')
          );
          const ll = llField ? parseInt(llField.textContent.split(':')[1].trim()) : 0;
          
          const progressField = Array.from(item.querySelectorAll('.job-item-field')).find(field => 
            field.textContent.includes('Personal Operation Progress:')
          );
          const currentProgress = progressField ? parseInt(progressField.textContent.split(':')[1].trim()) : 0;
          const newProgress = currentProgress >= 3 ? 0 : currentProgress + 1;
          
          activePilots.push({ name, callsign, ll, currentProgress, newProgress });
        }
      });
      
      // Populate the pilot list in the modal
      const pilotListDiv = document.getElementById('progressOperationPilotList');
      if (activePilots.length === 0) {
        pilotListDiv.innerHTML = '<p style="color: #999; text-align: center;">No active pilots found.</p>';
      } else {
        pilotListDiv.innerHTML = activePilots.map(pilot => `
          <div style="margin-bottom: 10px; padding: 10px; border-bottom: 1px solid #333;">
            <div><strong>${pilot.name} ("${pilot.callsign}")</strong></div>
            <div style="margin-top: 5px; font-size: 0.9em;">
              <span style="margin-right: 15px;">License Level: ${pilot.ll}</span>
              <span>Operation Progress: ${pilot.currentProgress} → ${pilot.newProgress}</span>
            </div>
          </div>
        `).join('');
      }
      
      document.getElementById('progressOperationModal').style.display = 'block';
    }
    
    function closeProgressOperationModal() {
      document.getElementById('progressOperationModal').style.display = 'none';
    }
    
    async function confirmProgressOperation() {
      try {
        const response = await fetch('/api/pilots/progress-operation', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
          const result = await response.json();
          closeProgressOperationModal();
          
          let message = `Operation progressed successfully! ${result.pilotsProgressed} active pilot(s) updated.`;
          if (result.resetPilots && result.resetPilots.length > 0) {
            const resetNames = result.resetPilots.map(p => `${p.name} ("${p.callsign}")`).join(', ');
            message += ` Reset to 0: ${resetNames}`;
          }
          
          showNotification(message);
          saveScrollPositionForReload();
          setTimeout(() => location.reload(), 400);
        } else {
          const errorData = await response.json();
          alert(errorData.message || 'Failed to progress operation');
        }
      } catch (error) {
        alert('Error progressing operation');
      }
    }
    
    // Update modal close handlers
    window.onclick = function(event) {
      const modal = document.getElementById('editModal');
      const factionModal = document.getElementById('editFactionModal');
      const transactionModal = document.getElementById('editTransactionModal');
      const pilotModal = document.getElementById('editPilotModal');
      const pilotRelatedJobsModal = document.getElementById('pilotRelatedJobsModal');
      const factionRelatedJobsModal = document.getElementById('factionRelatedJobsModal');
      const progressAllJobsModal = document.getElementById('progressAllJobsModal');
      const progressOperationModal = document.getElementById('progressOperationModal');
      const createReserveModal = document.getElementById('createReserveModal');
      const editReserveModal = document.getElementById('editReserveModal');
      
      if (event.target === modal) {
        closeEditModal();
      }
      if (event.target === factionModal) {
        closeEditFactionModal();
      }
      if (event.target === transactionModal) {
        closeEditTransactionModal();
      }
      if (event.target === pilotModal) {
        closeEditPilotModal();
      }
      if (event.target === pilotRelatedJobsModal) {
        closePilotRelatedJobsModal();
      }
      if (event.target === factionRelatedJobsModal) {
        closeFactionRelatedJobsModal();
      }
      if (event.target === progressAllJobsModal) {
        closeProgressAllJobsModal();
      }
      if (event.target === progressOperationModal) {
        closeProgressOperationModal();
      }
      if (event.target === createReserveModal) {
        closeCreateReserveModal();
      }
      if (event.target === editReserveModal) {
        closeEditReserveModal();
      }
    };
    
    // ==================== STORE CONFIG MANAGEMENT ====================
    
    // Global state for available reserves selection
    let selectedAvailableReserveId = null;
    let selectedStockReserveIds = [];
    let currentRankFilter = 'all';
    let hideDefaultReservesFilter = false;
    let currentSearchQuery = '';
    
    // Resupply Items Form Submit
    if (document.getElementById('resupplyItemsForm')) {
      document.getElementById('resupplyItemsForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        
        // Build resupply items array
        const resupplyItems = [];
        const itemCount = 3; // Fixed count
        for (let i = 0; i < itemCount; i++) {
          resupplyItems.push({
            id: formData.get(`items[${i}][id]`),
            name: formData.get(`items[${i}][name]`),
            price: parseInt(formData.get(`items[${i}][price]`)),
            enabled: formData.get(`items[${i}][enabled]`) === 'on'
          });
        }
        
        try {
          const response = await fetch('/api/store-config', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ resupplyItems })
          });
          
          if (response.ok) {
            showNotification('Resupply settings saved successfully!');
          } else {
            const errorData = await response.json();
            alert(errorData.message || 'Failed to save resupply settings');
          }
        } catch (error) {
          alert('Error saving resupply settings');
        }
      });
    }
    
    // Toggle stock reserve selection
    function toggleStockReserveSelection(card, reserveId) {
      const checkbox = card.querySelector('.stock-reserve-checkbox');
      
      // Toggle checkbox
      checkbox.checked = !checkbox.checked;
      
      // Update selected IDs array
      if (checkbox.checked) {
        if (!selectedStockReserveIds.includes(reserveId)) {
          selectedStockReserveIds.push(reserveId);
        }
        card.style.borderColor = '#66BB6A';
        card.style.backgroundColor = '#2a3a2a';
      } else {
        selectedStockReserveIds = selectedStockReserveIds.filter(id => id !== reserveId);
        card.style.borderColor = '#444';
        card.style.backgroundColor = '#1a1a1a';
      }
      
      // Update button states
      updateStockRemoveButtons();
    }
    
    // Update stock remove button states
    function updateStockRemoveButtons() {
      const removeBtn = document.getElementById('removeSelectedBtn');
      const removeAllBtn = document.getElementById('removeAllSelectedBtn');
      const hasSelection = selectedStockReserveIds.length > 0;
      
      if (removeBtn) removeBtn.disabled = !hasSelection;
      if (removeAllBtn) removeAllBtn.disabled = !hasSelection;
    }
    
    // Remove selected reserves from stock
    async function removeSelectedReserves(removeAll) {
      if (selectedStockReserveIds.length === 0) {
        alert('No reserves selected');
        return;
      }
      
      const action = removeAll ? 'Remove all selected reserves' : 'Remove first occurrence of selected reserves';
      if (!confirm(`${action} from stock?`)) {
        return;
      }
      
      try {
        const response = await fetch('/api/store-config/remove-stock', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            reserveIds: selectedStockReserveIds,
            removeAll 
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          const message = removeAll 
            ? `Removed ${data.removedCount} reserve(s) from stock`
            : 'Reserve removed from stock';
          showNotification(message);
          selectedStockReserveIds = [];
          saveScrollPositionForReload();
          setTimeout(() => location.reload(), 400);
        } else {
          const errorData = await response.json();
          alert(errorData.message || 'Failed to remove reserves from stock');
        }
      } catch (error) {
        alert('Error removing reserves from stock');
      }
    }
    
    // Select available reserve
    function selectAvailableReserve(card, reserveId) {
      // Deselect all cards
      document.querySelectorAll('.available-reserve-card').forEach(c => {
        c.style.borderColor = '#444';
        c.style.backgroundColor = '#1a1a1a';
      });
      
      // Select clicked card
      card.style.borderColor = '#66BB6A';
      card.style.backgroundColor = '#2a3a2a';
      selectedAvailableReserveId = reserveId;
      
      // Enable/disable action buttons
      updateAvailableReserveButtons();
    }
    
    // Update available reserve action buttons
    function updateAvailableReserveButtons() {
      const editBtn = document.getElementById('editReserveBtn');
      const deleteBtn = document.getElementById('deleteReserveBtn');
      const addToStockBtn = document.getElementById('addToStockBtn');
      const hasSelection = selectedAvailableReserveId !== null;
      
      if (editBtn) editBtn.disabled = !hasSelection;
      if (deleteBtn) deleteBtn.disabled = !hasSelection;
      if (addToStockBtn) addToStockBtn.disabled = !hasSelection;
    }
    
    // Filter available reserves
    function filterAvailableReserves(rank, event) {
      // Update filter pills (except Hide Default which is independent)
      document.querySelectorAll('.filter-pill[data-rank]').forEach(pill => {
        pill.classList.remove('active');
      });
      event.target.classList.add('active');
      
      currentRankFilter = rank;
      applyReserveFilters();
    }
    
    // Toggle hide default reserves
    function toggleHideDefaultReserves(event) {
      hideDefaultReservesFilter = !hideDefaultReservesFilter;
      
      if (hideDefaultReservesFilter) {
        event.target.classList.add('active');
      } else {
        event.target.classList.remove('active');
      }
      
      applyReserveFilters();
    }
    
    // Apply both filters to available reserves
    function applyReserveFilters() {
      const cards = document.querySelectorAll('.available-reserve-card');
      
      cards.forEach(card => {
        const cardRank = card.getAttribute('data-rank');
        const cardIsCustom = card.getAttribute('data-is-custom') === 'true';
        const cardName = card.querySelector('h3').textContent.trim();
        
        let show = true;
        
        // Apply rank filter
        if (currentRankFilter !== 'all' && cardRank !== currentRankFilter) {
          show = false;
        }
        
        // Apply hide default filter
        if (hideDefaultReservesFilter && !cardIsCustom) {
          show = false;
        }
        
        // Apply search filter
        if (currentSearchQuery && !cardName.toLowerCase().includes(currentSearchQuery.toLowerCase())) {
          show = false;
        }
        
        card.style.display = show ? '' : 'none';
      });
    }
    
    // Search available reserves by name
    function searchAvailableReserves(query) {
      currentSearchQuery = query;
      applyReserveFilters();
    }
    
    // Add random reserve from current view
    async function addRandomReserve() {
      try {
        const response = await fetch('/api/store-config/add-random', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            rankFilter: currentRankFilter,
            hideDefaultReserves: hideDefaultReservesFilter
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          showNotification(`${data.addedReserve.name} Reserve was added to the Reserve Stock`);
          saveScrollPositionForReload();
          setTimeout(() => location.reload(), 400);
        } else {
          const errorData = await response.json();
          alert(errorData.message || 'Failed to add random reserve');
        }
      } catch (error) {
        alert('Error adding random reserve');
      }
    }
    
    // Add selected reserve to stock
    async function addSelectedToStock() {
      if (!selectedAvailableReserveId) {
        alert('No reserve selected');
        return;
      }
      
      try {
        const storeConfig = await fetch('/api/store-config').then(r => r.json());
        const currentStock = storeConfig.currentStock || [];
        currentStock.push(selectedAvailableReserveId);
        
        const response = await fetch('/api/store-config', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ currentStock })
        });
        
        if (response.ok) {
          showNotification('Reserve added to stock');
          saveScrollPositionForReload();
          setTimeout(() => location.reload(), 400);
        } else {
          const errorData = await response.json();
          alert(errorData.message || 'Failed to add reserve to stock');
        }
      } catch (error) {
        alert('Error adding reserve to stock');
      }
    }
    
    // Create Reserve Modal
    function openCreateReserveModal() {
      document.getElementById('createReserveModal').style.display = 'block';
    }
    
    function closeCreateReserveModal() {
      document.getElementById('createReserveModal').style.display = 'none';
    }
    
    if (document.getElementById('createReserveForm')) {
      document.getElementById('createReserveForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        
        try {
          const response = await fetch('/api/reserves', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              rank: parseInt(data.rank),
              name: data.name,
              price: parseInt(data.price),
              description: data.description || '',
              adminLog: data.adminLog || ''
            })
          });
          
          if (response.ok) {
            showNotification('Reserve created successfully!');
            closeCreateReserveModal();
            saveScrollPositionForReload();
            setTimeout(() => location.reload(), 400);
          } else {
            const errorData = await response.json();
            alert(errorData.message || 'Failed to create reserve');
          }
        } catch (error) {
          alert('Error creating reserve');
        }
      });
    }
    
    // Edit Reserve Modal
    async function openEditReserveModal() {
      if (!selectedAvailableReserveId) {
        alert('No reserve selected');
        return;
      }
      
      try {
        const response = await fetch('/api/reserves');
        const reserves = await response.json();
        const reserve = reserves.find(r => r.id === selectedAvailableReserveId);
        
        if (!reserve) {
          alert('Reserve not found');
          return;
        }
        
        document.getElementById('editReserveId').value = reserve.id;
        document.getElementById('editReserveRank').value = reserve.rank;
        document.getElementById('editReserveName').value = reserve.name;
        document.getElementById('editReservePrice').value = reserve.price;
        document.getElementById('editReserveDescription').value = reserve.description || '';
        document.getElementById('editReserveAdminLog').value = reserve.adminLog || '';
        
        document.getElementById('editReserveModal').style.display = 'block';
      } catch (error) {
        alert('Error loading reserve data');
      }
    }
    
    function closeEditReserveModal() {
      document.getElementById('editReserveModal').style.display = 'none';
    }
    
    if (document.getElementById('editReserveForm')) {
      document.getElementById('editReserveForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        const id = document.getElementById('editReserveId').value;
        
        try {
          const response = await fetch(`/api/reserves/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              rank: parseInt(data.rank),
              name: data.name,
              price: parseInt(data.price),
              description: data.description || '',
              adminLog: data.adminLog || ''
            })
          });
          
          if (response.ok) {
            showNotification('Reserve updated successfully');
            closeEditReserveModal();
            saveScrollPositionForReload();
            setTimeout(() => location.reload(), 400);
          } else {
            const errorData = await response.json();
            alert(errorData.message || 'Failed to update reserve');
          }
        } catch (error) {
          alert('Error updating reserve');
        }
      });
    }
    
    // Delete Reserve
    async function deleteSelectedReserve() {
      if (!selectedAvailableReserveId) {
        alert('No reserve selected');
        return;
      }
      
      if (!confirm('Are you sure you want to delete this reserve? This action cannot be undone.')) {
        return;
      }
      
      try {
        const response = await fetch(`/api/reserves/${selectedAvailableReserveId}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          showNotification('Reserve deleted successfully!');
          selectedAvailableReserveId = null;
          saveScrollPositionForReload();
          setTimeout(() => location.reload(), 400);
        } else {
          const errorData = await response.json();
          alert(errorData.message || 'Failed to delete reserve');
        }
      } catch (error) {
        alert('Error deleting reserve');
      }
    }
    
    // ==================== TAB PERSISTENCE AND SCROLL RESTORATION ====================
    
    // Constants
    const SCROLL_RESTORE_TIMEOUT_MS = 5000; // Only restore scroll if saved within last 5 seconds
    
    // Helper function to save scroll position before form submission reloads
    function saveScrollPositionForReload() {
      sessionStorage.setItem('adminScrollY', window.scrollY.toString());
      sessionStorage.setItem('adminScrollSaved', Date.now().toString());
    }
    
    // Initialize tab from URL hash on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Get tab from URL hash (e.g., #jobs -> 'jobs')
      const hash = window.location.hash.substring(1);
      const validTabs = ['overview', 'transactions', 'jobs', 'base', 'pilots', 'factions', 'store', 'vote'];
      
      if (hash && validTabs.includes(hash)) {
        // Find the button for this tab by matching the tab name in onclick attribute using a direct selector
        const tabButton = document.querySelector(`.tab-button[onclick*="switchTab('${hash}'"]`);
        
        if (tabButton) {
          // Use the existing switchTab function to avoid duplication
          switchTab(hash, tabButton);
        }
      }
      
      // Restore scroll position using requestAnimationFrame for better timing
      const savedScrollY = sessionStorage.getItem('adminScrollY');
      const savedTime = sessionStorage.getItem('adminScrollSaved');
      
      // Only restore if saved recently to avoid restoring on intentional navigation
      if (savedScrollY !== null && savedTime !== null) {
        const parsedTime = parseInt(savedTime, 10);
        const parsedScrollY = parseInt(savedScrollY, 10);
        
        // Validate that parsed values are valid numbers
        if (Number.isFinite(parsedTime) && Number.isFinite(parsedScrollY)) {
          const timeSinceSave = Date.now() - parsedTime;
          if (timeSinceSave < SCROLL_RESTORE_TIMEOUT_MS) {
            // Use requestAnimationFrame to ensure content is rendered
            requestAnimationFrame(() => {
              requestAnimationFrame(() => {
                window.scrollTo(0, parsedScrollY);
                sessionStorage.removeItem('adminScrollY');
                sessionStorage.removeItem('adminScrollSaved');
              });
            });
          } else {
            // Clear stale data
            sessionStorage.removeItem('adminScrollY');
            sessionStorage.removeItem('adminScrollSaved');
          }
        } else {
          // Clear invalid data
          sessionStorage.removeItem('adminScrollY');
          sessionStorage.removeItem('adminScrollSaved');
        }
      }
    });
  </script>
  
  <!-- Modify Voting Close Modal -->
  <div id="modify-vote-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Modify Voting Close Time</h2>
        <span class="close" onclick="closeModifyVoteModal()">&times;</span>
      </div>
      <div class="form-group">
        <label for="modify-vote-end-time">New End Time</label>
        <div style="display: flex; align-items: center; gap: 10px;">
          <input type="datetime-local" id="modify-vote-end-time" style="flex: 1; color-scheme: dark;">
          <label style="display: flex; align-items: center; gap: 5px; color: #b0b0b0; cursor: pointer; white-space: nowrap;">
            <input type="checkbox" id="modify-vote-infinite-duration" onchange="toggleModifyEndTime(this)">
            No end time?
          </label>
        </div>
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-primary" onclick="modifyVotingClose()">Update End Time</button>
        <button type="button" class="btn btn-secondary" onclick="closeModifyVoteModal()">Cancel</button>
      </div>
    </div>
  </div>
</body></html>
